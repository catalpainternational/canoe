<DataDownload>
    <script>
        import { storeManifest, storeSiteDownloadedIs } from "ReduxImpl/Store";
        import { fetchManifest } from "js/WagtailPagesAPI";
        import { SiteDownloader } from "js/SiteDownloader";
        import { dispatchLoggedInEvent } from "js/Events";
        import { isGuestUser } from "js/AuthenticationUtilities";

        import { pullExamDataIntoMemory, clearInMemoryExamData } from "js/ExamInterface";
        import {
            pullCompletionsIntoMemory,
            clearInMemoryCompletions,
        } from "js/CompletionInterface";
        import { updateApi, updateIdb } from "Actions/actions_store.js";
        import { closeAndDeleteDB } from "Actions/actions_idb";

        const EVERY_FIVE_MINUTES = 1000 * 60 * 5;

        export default {
            state: {
                pagesPoller: null,
                completionPoller: null,
            },

            onMounted() {
                this.prepDataForAppLaunch();
            },

            onUnmounted() {
                this.clearAppData();
            },

            async pollForWebpageChanges() {
                const manifest = await fetchManifest();
                storeManifest(manifest);
                new SiteDownloader().requestTheSitesPagesAndImages();
            },

            async pullIdbDataIntoMemory() {
                await pullCompletionsIntoMemory();
                await pullExamDataIntoMemory();
            },

            async prepDataForAppLaunch() {
                if (!isGuestUser()) {
                    await updateIdb();
                    this.state.pagesPoller = window.setInterval(
                        this.pollForWebpageChanges,
                        EVERY_FIVE_MINUTES
                    );
                }

                await this.pullIdbDataIntoMemory();

                this.pollForWebpageChanges();
                this.state.completionPoller = window.setInterval(updateApi, EVERY_FIVE_MINUTES);

                storeSiteDownloadedIs(true);
                dispatchLoggedInEvent();
            },

            async clearAppData() {
                window.clearInterval(this.state.completionPoller);
                window.clearInterval(this.state.pagesPoller);
                storeSiteDownloadedIs(false);
                clearInMemoryCompletions();
                clearInMemoryExamData();
                await closeAndDeleteDB();
            },
        };
    </script>
</DataDownload>
