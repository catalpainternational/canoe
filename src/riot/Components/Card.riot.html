<Card>
    <span if="{ props.debugState }">
        { JSON.stringify(props, null, 2) }
    </span>
    <a class="card {props.status}" href="#{props.link || props.contentItem.loc_hash}">
        <div class="card-image">
            <img crossorigin="anonymous" src="{getCardImage()}" class="card-hero-image" />
            <span class="card-status"><span class="icon"></span></span>
        </div>
        <div class="card-title">
            <h5 class="clamp-lines">{ props.title || props.contentItem.title }</h5>
            <progress
                if="{props.status === 'in-progress'}"
                value="{props.progressValue}"
                max="{props.progressMax}"
            ></progress>
            <progress if="{props.status === 'complete'}" value="1" max="1"></progress>
        </div>
    </a>
    <button if="{ props.contentItem }" onclick="{ toggleCached }">
        { state.cached ? TRANSLATIONS.cached() : TRANSLATIONS.notCached() }
    </button>
    <script>
        import {getCardImageUrl} from "js/utilities";

        export default {
            state: {
                cached: undefined,
                cachedStatus: 'undetermined',
            },
            TRANSLATIONS: {
                cached: () => gettext("Available offline"),
                notCached: () => gettext("Not yet available offline"),
            },
            onMounted(props, state) {
                if(props.contentItem) {
                    props.contentItem.isAvailableOffline().then(cached => {
                        this.update({cached});
                    });
                }
            },
            toggleCached() {
                const item = this.props.contentItem;
                const action = this.state.cached 
                    ? item.removeAvailableOffline()
                    : item.makeAvailableOffline();
                action
                    .then(() => item.isAvailableOffline())
                    .then(cached => {
                        this.update({cached});
                    });
            },

            getCardImage() {
                return getCardImageUrl(this.props.link || this.props.contentItem.id, this.props.imageUrl);
            }
        };
    </script>
</Card>
