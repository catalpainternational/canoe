<App>
    <ServiceWorker></ServiceWorker>
    <OnlineOrOffline></OnlineOrOffline>
    <Toast></Toast>

    <Authentication if="{!isUserLoggedIn()}"></Authentication>

    <DataDownload if="{isUserLoggedIn()}"></DataDownload>

    <template if="{isUserLoggedIn() && props.store.getState().siteIsDownloaded}">
        <TopMenu
            contentType="{state.contentType}"
            wagtailPage="{state.contentType === 'LessonPage' ? state.wagtailPage : ''}"
        ></TopMenu>

        <HomePage
            if="{state.contentType === 'HomePage'}"
            wagtailPage="{state.wagtailPage}"
        ></HomePage>
        <CoursePage
            if="{state.contentType === 'CoursePage'}"
            wagtailPage="{state.wagtailPage}"
        ></CoursePage>
        <LessonPage
            if="{state.contentType === 'LessonPage'}"
            wagtailPage="{state.wagtailPage}"
        ></LessonPage>
        <Settings if="{state.contentType === 'settings'}"></Settings>
        <Notifications if="{state.contentType === 'notifications'}"></Notifications>
        <Profile if="{state.contentType === 'profile'}"></Profile>

        <BottomMenu contentType="{state.contentType}"></BottomMenu>
        <Telemetry></Telemetry>
        <PushSubscription></PushSubscription>
    </template>

    <script>
        import { isUserLoggedIn } from "js/AuthenticationUtilities";
        import { getPage } from "js/Routing";
        import { ON_LOG_IN, ON_LOG_OUT, ON_REQUEST_SITE_DOWNLOAD } from "js/Events";

        import TopMenu from "RiotTags/Components/TopMenu.riot.html";
        import BottomMenu from "RiotTags/Components/BottomMenu.riot.html";
        import Telemetry from "RiotTags/Components/Telemetry.riot.html";
        import ServiceWorker from "RiotTags/Components/ServiceWorker.riot.html";
        import DataDownload from "RiotTags/Components/DataDownload.riot.html";
        import PushSubscription from "RiotTags/Components/PushSubscription.riot.html";
        import Toast from "RiotTags/Components/Toast.riot.html";
        import OnlineOrOffline from "RiotTags/Components/OnlineOrOffline.riot.html";

        import Authentication from "RiotTags/Screens/Authentication.riot.html";
        import Notifications from "RiotTags/Screens/Notifications.riot.html";
        import Profile from "RiotTags/Screens/Profile.riot.html";
        import Settings from "RiotTags/Screens/Settings.riot.html";

        import HomePage from "RiotTags/WagtailPages/HomePage.riot.html";
        import CoursePage from "RiotTags/WagtailPages/CoursePage.riot.html";
        import LessonPage from "RiotTags/WagtailPages/LessonPage.riot.html";

        const scrollToFirstUnfinishedContent = () => {
            const ongoingCards = document.getElementsByClassName("ongoing");
            const cards = document.getElementsByTagName("card");

            const firstUnfinishedContent = ongoingCards[0];
            const allCardsAreUnfinished = ongoingCards.length === cards.length;

            if (!firstUnfinishedContent || allCardsAreUnfinished) {
                window.scroll(0, 0);
                return;
            }

            const unfinishedContentCoords = firstUnfinishedContent.getBoundingClientRect();
            window.scroll(unfinishedContentCoords);
        };

        export default {
            state: {
                wagtailPage: {},
                homePageURL: "",
                appTitle: ""
            },

            components: {
                authentication: Authentication,
                topmenu: TopMenu,
                bottommenu: BottomMenu,
                homepage: HomePage,
                coursepage: CoursePage,
                lessonpage: LessonPage,
                notifications: Notifications,
                profile: Profile,
                settings: Settings,
                telemetry: Telemetry,
                serviceworker: ServiceWorker,
                datadownload: DataDownload,
                pushsubscription: PushSubscription,
                toast: Toast,
                onlineoroffline: OnlineOrOffline
            },

            onMounted() {
                // After authenticating, the app downloads its materials.
                window.addEventListener(ON_REQUEST_SITE_DOWNLOAD, () => {
                    this.update();
                });

                // After downloading its materials, the app starts.
                window.addEventListener(ON_LOG_IN, async () => {
                    this.route();
                });

                window.addEventListener(ON_LOG_OUT, () => {
                    window.location.hash = "";
                    this.update();
                });

                window.addEventListener("hashchange", () => {
                    if (this.isUserLoggedIn()) {
                        this.route();
                        scrollToFirstUnfinishedContent();
                    }
                });

                if (this.isUserLoggedIn() && this.props.store.getState().siteIsDownloaded) {
                    // If user returns to site and is logged in.
                    this.route();
                }
            },

            onUpdated() {
                scrollToFirstUnfinishedContent();
            },

            async route() {
                const page = await getPage();
                const pageModel = getWagtailPageModelName(page);

                this.update({
                    wagtailPage: page,
                    contentType: pageModel
                });
            },

            isUserLoggedIn() {
                return isUserLoggedIn();
            }
        };

        function getWagtailPageModelName(wagtailPage) {
            const type = wagtailPage.meta.type;
            return type.substring(type.lastIndexOf(".") + 1);
        }
    </script>
</App>
