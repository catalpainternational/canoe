<App>
    <template if="{!isBrowserSupported()}">
        <ChangeBrowser></ChangeBrowser>
    </template>

    <template if="{isBrowserSupported()}">
        <OnlineOrOffline></OnlineOrOffline>
        <Toast></Toast>

        <Login if="{!isUserLoggedIn()}"></Login>

        <LoadCompletions if="{isUserLoggedIn()}"></LoadCompletions>

        <LoadingDots
            if="{Object.keys(state.wagtailPage).length === 0 && isUserLoggedIn()}"
            extrastyleclasses="light app"
        ></LoadingDots>

        <template if="{isUserLoggedIn() && areCompletionsReady()}">
            <DownloadSite></DownloadSite>

            <TopMenu
                contentType="{state.contentType}"
                wagtailPage="{state.contentType === 'LessonPage' ? state.wagtailPage : ''}"
            ></TopMenu>
            <HomePage
                if="{state.contentType === 'HomePage'}"
                wagtailPage="{createHomePage(state.wagtailPage)}"
            ></HomePage>
            <CourseOverview
                if="{state.contentType === 'CoursePage'}"
                wagtailPage="{createCoursePage(state.wagtailPage)}"
            ></CourseOverview>
            <LessonOverview
                if="{state.contentType === 'LessonPage'}"
                wagtailPage="{createLessonPage(state.wagtailPage)}"
            ></LessonOverview>
            <Settings if="{state.contentType === 'settings'}"></Settings>
            <Resources
                if="{state.contentType === 'resources' || state.contentType === 'ResourcesRoot'}"
            ></Resources>
            <ResourceArticle
                if="{state.contentType === 'ResourceArticle'}"
                wagtailPage="{createResourceArticle(state.wagtailPage)}"
            ></ResourceArticle>
            <Profile if="{state.contentType === 'profile'}"></Profile>
            <BottomMenu contentType="{state.contentType}"></BottomMenu>
            <PushSubscription></PushSubscription>
        </template>
    </template>

    <script>
        import { getPage } from "js/Routing";
        import { ON_REQUEST_SITE_DOWNLOAD } from "js/Events";
        import {
            isBrowserSupported,
            isUserLoggedIn,
            areCompletionsReady,
            getManifestFromStore,
        } from "ReduxImpl/Interface";
        import { storeSubscribers } from "ReduxImpl/StoreSubscribers";
        import { logPageView } from "js/GoogleAnalytics";

        import HomePageJS from "js/HomePage";
        import CoursePageJS from "js/CoursePage";
        import LessonPageJS from "js/LessonPage";
        import ResourceArticleJS from "js/ResourceArticle";

        import TopMenu from "RiotTags/Components/TopMenu.riot.html";
        import BottomMenu from "RiotTags/Components/BottomMenu.riot.html";
        import LoadCompletions from "RiotTags/Components/LoadCompletions.riot.html";
        import DownloadSite from "RiotTags/Components/DownloadSite.riot.html";
        import PushSubscription from "RiotTags/Components/PushSubscription.riot.html";
        import Toast from "RiotTags/Components/Toast.riot.html";
        import OnlineOrOffline from "RiotTags/Components/OnlineOrOffline.riot.html";
        import LoadingDots from "RiotTags/Components/LoadingDots.riot.html";

        import Login from "RiotTags/Screens/Login.riot.html";
        import Resources from "RiotTags/Screens/Resources.riot.html";
        import Profile from "RiotTags/Screens/Profile.riot.html";
        import Settings from "RiotTags/Screens/Settings.riot.html";
        import ChangeBrowser from "RiotTags/Screens/ChangeBrowser.riot.html";

        import HomePage from "RiotTags/WagtailPages/HomePage.riot.html";
        import CourseOverview from "RiotTags/Lesson/CourseOverview.riot.html";
        import LessonOverview from "RiotTags/Lesson/LessonOverview.riot.html";
        import ResourceArticle from "RiotTags/WagtailPages/ResourceArticle.riot.html";

        const scrollToFirstUnfinishedContent = () => {
            const ongoingCards = document.getElementsByClassName("ongoing");
            const cards = document.getElementsByTagName("card");

            const firstUnfinishedContent = ongoingCards[0];
            const allCardsAreUnfinished = ongoingCards.length === cards.length;

            if (!firstUnfinishedContent || allCardsAreUnfinished) {
                window.scroll(0, 0);
                return;
            }

            const unfinishedContentCoords = firstUnfinishedContent.getBoundingClientRect();
            window.scroll(unfinishedContentCoords);
        };

        export default {
            state: {
                wagtailPage: {},
                homePageURL: "",
                appTitle: "",
                storeSubscriptions: {},
            },

            components: {
                login: Login,
                topmenu: TopMenu,
                bottommenu: BottomMenu,
                homepage: HomePage,
                courseoverview: CourseOverview,
                lessonoverview: LessonOverview,
                resources: Resources,
                profile: Profile,
                settings: Settings,
                loadcompletions: LoadCompletions,
                downloadsite: DownloadSite,
                pushsubscription: PushSubscription,
                changebrowser: ChangeBrowser,
                toast: Toast,
                onlineoroffline: OnlineOrOffline,
                resourcearticle: ResourceArticle,
                loadingdots: LoadingDots,
            },

            onMounted() {
                // After authenticating, the app downloads its materials.
                window.addEventListener(ON_REQUEST_SITE_DOWNLOAD, () => {
                    this.update();
                });

                const loginRoute = async () => this.route();

                const logoutUpdate = () => {
                    window.location.hash = "";
                    this.update();
                };

                window.addEventListener("hashchange", () => {
                    if (this.isUserLoggedIn()) {
                        this.route();
                        logPageView(window.location.hash);
                    }
                });

                if (!this.isUserLoggedIn() && this.areCompletionsReady()) {
                    // If user returns to site and is logged in.
                    loginRoute();
                }

                // Watch for changes to specific store members
                // After downloading its materials, the app starts.
                const completionTargets = ["areCompletionsReady"];
                const completionCallback = async (storeState) => {
                    if (storeState.userLoggedIn) {
                        await loginRoute();
                    }
                };

                const logoutTargets = ["userLoggedIn"];
                const logoutCallback = (storeState) => {
                    if (!storeState.userLoggedIn) {
                        if (!!this.state.logoutUpdating) {
                            return;
                        }

                        this.state.logoutUpdating = true;
                        logoutUpdate();
                        this.state.logoutUpdating = false;
                    }
                };

                this.state.storeSubscriptions["completion"] = storeSubscribers(
                    completionCallback,
                    completionTargets
                );
                this.state.storeSubscriptions["logout"] = storeSubscribers(
                    logoutCallback,
                    logoutTargets
                );
            },

            onUpdated() {
                scrollToFirstUnfinishedContent();
            },

            /** Watch for any change within the entire store */
            storeListener(previousStoreState, storeState) {
                if (previousStoreState.language != storeState.language) {
                    this.update();
                }
            },

            async route() {
                const page = await getPage();
                const pageModel = getWagtailPageModelName(page);

                this.update({
                    wagtailPage: page,
                    contentType: pageModel,
                });
            },

            isBrowserSupported() {
                return isBrowserSupported();
            },

            areCompletionsReady() {
                return areCompletionsReady();
            },

            isUserLoggedIn() {
                return isUserLoggedIn();
            },

            createHomePage(aWagtailPage) {
                return new HomePageJS(aWagtailPage);
            },

            createCoursePage(aWagtailPage) {
                return new CoursePageJS(aWagtailPage);
            },

            createLessonPage(aWagtailPage) {
                return new LessonPageJS(aWagtailPage);
            },

            createResourceArticle(aWagtailPage) {
                return new ResourceArticleJS(aWagtailPage);
            },
        };

        function getWagtailPageModelName(wagtailPage) {
            const type = wagtailPage.meta.type;
            return type.substring(type.lastIndexOf(".") + 1);
        }
    </script>
</App>
