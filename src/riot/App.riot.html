<App>
    <template if="{!isBrowserSupported()}">
        <ChangeBrowser></ChangeBrowser>
    </template>

    <template if="{isBrowserSupported()}">
        <OnlineOrOffline></OnlineOrOffline>
        <Toast></Toast>

        <Authentication if="{!isUserLoggedIn()}"></Authentication>

        <DataDownload if="{isUserLoggedIn()}"></DataDownload>

        <template if="{isUserLoggedIn() && isSiteDownloaded()}">
            <TopMenu
                contentType="{state.contentType}"
                wagtailPage="{state.contentType === 'LessonPage' ? state.wagtailPage : ''}"
            ></TopMenu>
            <HomePage
                if="{state.contentType === 'HomePage'}"
                wagtailPage="{state.wagtailPage}"
            ></HomePage>
            <CoursePage
                if="{state.contentType === 'CoursePage'}"
                wagtailPage="{state.wagtailPage}"
            ></CoursePage>
            <LessonPage
                if="{state.contentType === 'LessonPage'}"
                wagtailPage="{state.wagtailPage}"
            ></LessonPage>
            <Settings if="{state.contentType === 'settings'}"></Settings>
            <Resources
                if="{state.contentType === 'resources'}"
            ></Resources>
            <Profile if="{state.contentType === 'profile'}"></Profile>
            <BottomMenu contentType="{state.contentType}"></BottomMenu>
            <PushSubscription></PushSubscription>
        </template>
    </template>

    <script>
        import { isUserLoggedIn } from "js/AuthenticationUtilities";
        import { getPage } from "js/Routing";
        import { ON_LOG_IN, ON_LOG_OUT, ON_REQUEST_SITE_DOWNLOAD } from "js/Events";
        import { isBrowserSupported, isSiteDownloaded } from "ReduxImpl/Store";
        import { logPageView } from "js/GoogleAnalytics";

        import TopMenu from "RiotTags/Components/TopMenu.riot.html";
        import BottomMenu from "RiotTags/Components/BottomMenu.riot.html";
        import DataDownload from "RiotTags/Components/DataDownload.riot.html";
        import PushSubscription from "RiotTags/Components/PushSubscription.riot.html";
        import Toast from "RiotTags/Components/Toast.riot.html";
        import OnlineOrOffline from "RiotTags/Components/OnlineOrOffline.riot.html";

        import Authentication from "RiotTags/Screens/Authentication.riot.html";
        import Resources from "RiotTags/Screens/Resources.riot.html";
        import Profile from "RiotTags/Screens/Profile.riot.html";
        import Settings from "RiotTags/Screens/Settings.riot.html";
        import ChangeBrowser from "RiotTags/Screens/ChangeBrowser.riot.html";

        import HomePage from "RiotTags/WagtailPages/HomePage.riot.html";
        import CoursePage from "RiotTags/WagtailPages/CoursePage.riot.html";
        import LessonPage from "RiotTags/WagtailPages/LessonPage.riot.html";

        const scrollToFirstUnfinishedContent = () => {
            const ongoingCards = document.getElementsByClassName("ongoing");
            const cards = document.getElementsByTagName("card");

            const firstUnfinishedContent = ongoingCards[0];
            const allCardsAreUnfinished = ongoingCards.length === cards.length;

            if (!firstUnfinishedContent || allCardsAreUnfinished) {
                window.scroll(0, 0);
                return;
            }

            const unfinishedContentCoords = firstUnfinishedContent.getBoundingClientRect();
            window.scroll(unfinishedContentCoords);
        };

        export default {
            state: {
                wagtailPage: {},
                homePageURL: "",
                appTitle: "",
            },

            components: {
                authentication: Authentication,
                topmenu: TopMenu,
                bottommenu: BottomMenu,
                homepage: HomePage,
                coursepage: CoursePage,
                lessonpage: LessonPage,
                resources: Resources,
                profile: Profile,
                settings: Settings,
                datadownload: DataDownload,
                pushsubscription: PushSubscription,
                changebrowser: ChangeBrowser,
                toast: Toast,
                onlineoroffline: OnlineOrOffline,
            },

            onMounted() {
                // After authenticating, the app downloads its materials.
                window.addEventListener(ON_REQUEST_SITE_DOWNLOAD, () => {
                    this.update();
                });

                // After downloading its materials, the app starts.
                window.addEventListener(ON_LOG_IN, async () => {
                    this.route();
                });

                window.addEventListener(ON_LOG_OUT, () => {
                    window.location.hash = "";
                    this.update();
                });

                window.addEventListener("hashchange", () => {
                    if (this.isUserLoggedIn()) {
                        this.route();
                        logPageView(window.location.hash);
                        scrollToFirstUnfinishedContent();
                    }
                });

                if (this.isUserLoggedIn() && this.props.store.getState().siteIsDownloaded) {
                    // If user returns to site and is logged in.
                    this.route();
                }
            },

            onUpdated() {
                scrollToFirstUnfinishedContent();
            },

            storeListener(previousStoreState, storeState) {
                if (previousStoreState.language != storeState.language) {
                    this.update();
                }
            },

            async route() {
                const page = await getPage();
                const pageModel = getWagtailPageModelName(page);

                this.update({
                    wagtailPage: page,
                    contentType: pageModel,
                });
            },

            isBrowserSupported() {
                return isBrowserSupported();
            },

            isSiteDownloaded() {
                return isSiteDownloaded();
            },

            isUserLoggedIn() {
                return isUserLoggedIn();
            },
        };

        function getWagtailPageModelName(wagtailPage) {
            const type = wagtailPage.meta.type;
            return type.substring(type.lastIndexOf(".") + 1);
        }
    </script>
</App>
