<App>
    <ChangeBrowser></ChangeBrowser>

    <template if="{state.browserSupported}">
        <Toast></Toast>

        <LoadingDots
            if="{state.loading}"
            extrastyleclasses="dark app"
        ></LoadingDots>

        <TopMenu
            contentType="{state.contentType || state.route.page}"
            wagtailPage="{state.contentType === 'LessonPage' ? state.wagtailPage : ''}"
        ></TopMenu>

        <Login if="{state.route.page === 'login'}"></Login>
        <Settings if="{state.route.page === 'settings'}"></Settings>
        <Profile if="{state.route.page === 'profile'}"></Profile>
        <Sync if="{state.route.page === 'sync'}"></Sync>

        <AllCoursesPage
            if="{state.route.page && state.route.page.type === 'homepage'}"
        ></AllCoursesPage>
        <!--
        <HomePage
            if="{state.route.page && state.route.page.type === 'homepage'}"
        ></HomePage>
         -->
        <CourseOverview
            if="{state.route.page && state.route.page.type === 'coursepage'}"
        ></CourseOverview>
        <LessonOverview
            if="{state.route.page && state.route.page.type === 'lessonpage'}"
        ></LessonOverview>
        <Resources
            if="{state.route.page && state.route.page.type === 'resourcesroot'}"
        ></Resources>
        <ResourceArticle
            if="{state.route.page && state.route.page.type === 'resourcearticle'}"
        ></ResourceArticle>
        
        <BottomMenu contentType="{state.contentType}"></BottomMenu>
        <PushSubscription></PushSubscription>
    </template>

    <script>
        import {
            isBrowserSupported,
            getRoute
        } from "ReduxImpl/Interface";

        import AllCoursesPageJS from "js/AllCoursesPage";
        import CoursePageJS from "js/CoursePage";
        import LessonPageJS from "js/LessonPage";
        import ResourceArticleJS from "js/ResourceArticle";

        import TopMenu from "RiotTags/Components/TopMenu.riot.html";
        import BottomMenu from "RiotTags/Components/BottomMenu.riot.html";
        import PushSubscription from "RiotTags/Components/PushSubscription.riot.html";
        import Toast from "RiotTags/Components/Toast.riot.html";
        import LoadingDots from "RiotTags/Components/LoadingDots.riot.html";

        import Login from "RiotTags/Screens/Login.riot.html";
        import Resources from "RiotTags/Screens/Resources.riot.html";
        import Profile from "RiotTags/Screens/Profile.riot.html";
        import Settings from "RiotTags/Screens/Settings.riot.html";
        import ChangeBrowser from "RiotTags/Screens/ChangeBrowser.riot.html";
        import Sync from "RiotTags/Screens/Sync";

        import AllCoursesPage from "RiotTags/WagtailPages/AllCoursesPage.riot.html";
        import CourseOverview from "RiotTags/Lesson/CourseOverview.riot.html";
        import LessonOverview from "RiotTags/Lesson/LessonOverview.riot.html";
        import ResourceArticle from "RiotTags/WagtailPages/ResourceArticle.riot.html";


        function App() {
            return {
                state: {
                    route: getRoute(),
                    browserSupported: isBrowserSupported(),
                    wagtailPage: {},
                    homePageURL: "",
                    appTitle: "",
                },

                onUpdated(props, state) {
                    scrollToFirstUnfinishedContent();
                },

                storeListener(previousStoreState, storeState) {
                    if (previousStoreState.language !== storeState.language
                        || previousStoreState.route.page !== storeState.route.page
                        || previousStoreState.fetchStatus.fetchingManifest !== storeState.fetchStatus.fetchingManifest
                    ) {
                        this.update({
                            route: getRoute()
                        });
                    }
                }
            }
        }
        App.components = {
            login: Login,
            topmenu: TopMenu,
            bottommenu: BottomMenu,
            allcoursespage: AllCoursesPage,
            courseoverview: CourseOverview,
            lessonoverview: LessonOverview,
            resources: Resources,
            profile: Profile,
            settings: Settings,
            sync: Sync,
            pushsubscription: PushSubscription,
            changebrowser: ChangeBrowser,
            toast: Toast,
            resourcearticle: ResourceArticle,
            loadingdots: LoadingDots,
        }

        const scrollToFirstUnfinishedContent = () => {
            const ongoingCards = document.getElementsByClassName("ongoing");
            const cards = document.getElementsByTagName("card");

            const firstUnfinishedContent = ongoingCards[0];
            const allCardsAreUnfinished = ongoingCards.length === cards.length;

            if (!firstUnfinishedContent || allCardsAreUnfinished) {
                window.scroll(0, 0);
                return;
            }

            const unfinishedContentCoords = firstUnfinishedContent.getBoundingClientRect();
            window.scroll(unfinishedContentCoords);
        };

        export default App;

    </script>
</App>
