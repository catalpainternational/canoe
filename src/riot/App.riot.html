<App>
    <template if="{!isBrowserSupported()}">
        <ChangeBrowser></ChangeBrowser>
    </template>

    <template if="{isBrowserSupported()}">
        <Toast></Toast>

        <Login if="{userShouldLogin()}"></Login>

        <LoadCompletions if="{!userShouldLogin()}"></LoadCompletions>

        <LoadingDots
            if="{Object.keys(state.wagtailPage).length === 0 && !userShouldLogin()}"
            extrastyleclasses="light app"
        ></LoadingDots>

        <template if="{!userShouldLogin() && areCompletionsReady()}">
            <DownloadSite></DownloadSite>

            <TopMenu
                contentType="{state.contentType}"
                wagtailPage="{state.contentType === 'LessonPage' ? state.wagtailPage : ''}"
            ></TopMenu>
            <HomePage
                if="{state.contentType === 'HomePage'}"
                wagtailPage="{createHomePage(state.wagtailPage)}"
            ></HomePage>
            <CourseOverview
                if="{state.contentType === 'CoursePage'}"
                wagtailPage="{createCoursePage(state.wagtailPage)}"
            ></CourseOverview>
            <LessonOverview
                if="{state.contentType === 'LessonPage'}"
                wagtailPage="{createLessonPage(state.wagtailPage)}"
            ></LessonOverview>
            <Settings if="{state.contentType === 'settings'}"></Settings>
            <Resources
                if="{state.contentType === 'resources' || state.contentType === 'ResourcesRoot'}"
            ></Resources>
            <ResourceArticle
                if="{state.contentType === 'ResourceArticle'}"
                wagtailPage="{createResourceArticle(state.wagtailPage)}"
            ></ResourceArticle>
            <Profile if="{state.contentType === 'profile'}"></Profile>
            <BottomMenu contentType="{state.contentType}"></BottomMenu>
            <PushSubscription></PushSubscription>
            <Sync if="{state.contentType === 'sync'}"></Sync>
        </template>
    </template>

    <script>
        import { userShouldLogin } from "js/AuthenticationUtilities";
        import { getPage } from "js/Routing";
        import {
            ON_LOG_IN,
            ON_LOG_OUT,
            ON_REQUEST_SITE_DOWNLOAD,
        } from "js/Events";
        import {
            isBrowserSupported,
            areCompletionsReady,
            getManifestFromStore,
        } from "ReduxImpl/Interface";
        import { logPageView } from "js/GoogleAnalytics";

        import { InitialiseCertChain } from "ts/StartUp";

        import HomePageJS from "js/HomePage";
        import CoursePageJS from "js/CoursePage";
        import LessonPageJS from "js/LessonPage";
        import ResourceArticleJS from "js/ResourceArticle";

        import TopMenu from "RiotTags/Components/TopMenu.riot.html";
        import BottomMenu from "RiotTags/Components/BottomMenu.riot.html";
        import LoadCompletions from "RiotTags/Components/LoadCompletions.riot.html";
        import DownloadSite from "RiotTags/Components/DownloadSite.riot.html";
        import PushSubscription from "RiotTags/Components/PushSubscription.riot.html";
        import Toast from "RiotTags/Components/Toast.riot.html";
        import LoadingDots from "RiotTags/Components/LoadingDots.riot.html";

        import Login from "RiotTags/Screens/Login.riot.html";
        import Resources from "RiotTags/Screens/Resources.riot.html";
        import Profile from "RiotTags/Screens/Profile.riot.html";
        import Settings from "RiotTags/Screens/Settings.riot.html";
        import ChangeBrowser from "RiotTags/Screens/ChangeBrowser.riot.html";
        import Sync from "RiotTags/Screens/Sync";

        import HomePage from "RiotTags/WagtailPages/HomePage.riot.html";
        import CourseOverview from "RiotTags/Lesson/CourseOverview.riot.html";
        import LessonOverview from "RiotTags/Lesson/LessonOverview.riot.html";
        import ResourceArticle from "RiotTags/WagtailPages/ResourceArticle.riot.html";

        const scrollToFirstUnfinishedContent = () => {
            const ongoingCards = document.getElementsByClassName("ongoing");
            const cards = document.getElementsByTagName("card");

            const firstUnfinishedContent = ongoingCards[0];
            const allCardsAreUnfinished = ongoingCards.length === cards.length;

            if (!firstUnfinishedContent || allCardsAreUnfinished) {
                window.scroll(0, 0);
                return;
            }

            const unfinishedContentCoords = firstUnfinishedContent.getBoundingClientRect();
            window.scroll(unfinishedContentCoords);
        };

        export default {
            state: {
                wagtailPage: {},
                homePageURL: "",
                appTitle: "",
            },

            components: {
                login: Login,
                topmenu: TopMenu,
                bottommenu: BottomMenu,
                homepage: HomePage,
                courseoverview: CourseOverview,
                lessonoverview: LessonOverview,
                resources: Resources,
                profile: Profile,
                settings: Settings,
                sync: Sync,
                loadcompletions: LoadCompletions,
                downloadsite: DownloadSite,
                pushsubscription: PushSubscription,
                changebrowser: ChangeBrowser,
                toast: Toast,
                resourcearticle: ResourceArticle,
                loadingdots: LoadingDots,
            },

            onMounted() {
                this.setUpEventListeners();

                // Check that the Appelflap wrapper has started, by looking for its global object
                if (window.canoeHost) {
                    // Regardless of what happens with Appelflap, we continue starting up Canoe
                    if (
                        !this.userShouldLogin() &&
                        this.areCompletionsReady()
                    ) {
                        // If user returns to site and is logged in.
                        this.route();
                    }
                }
            },

            onUpdated() {
                scrollToFirstUnfinishedContent();
            },

            setUpEventListeners() {
                // After authenticating, the app downloads its materials.
                window.addEventListener(ON_REQUEST_SITE_DOWNLOAD, () => {
                    this.update();
                });

                // After downloading its materials, the app starts.
                window.addEventListener(ON_LOG_IN, async () => {
                    this.route();
                });

                window.addEventListener(ON_LOG_OUT, () => {
                    window.location.hash = "";
                    this.update();
                });

                window.addEventListener("hashchange", () => {
                    if (!this.userShouldLogin()) {
                        this.route();
                        logPageView(window.location.hash);
                    }
                });
            },

            storeListener(previousStoreState, storeState) {
                if (previousStoreState.language != storeState.language) {
                    this.update();
                }
            },

            async route() {
                const page = await getPage();
                const pageModel = getWagtailPageModelName(page);

                if (
                    !this.userShouldLogin() &&
                    this.areCompletionsReady() &&
                    !window.certChain
                ) {
                    InitialiseCertChain();
                }

                this.update({
                    wagtailPage: page,
                    contentType: pageModel,
                });
            },

            isBrowserSupported() {
                return isBrowserSupported();
            },

            areCompletionsReady() {
                return areCompletionsReady();
            },

            userShouldLogin() {
                return userShouldLogin();
            },

            createHomePage(aWagtailPage) {
                return new HomePageJS(aWagtailPage);
            },

            createCoursePage(aWagtailPage) {
                return new CoursePageJS(aWagtailPage);
            },

            createLessonPage(aWagtailPage) {
                return new LessonPageJS(aWagtailPage);
            },

            createResourceArticle(aWagtailPage) {
                return new ResourceArticleJS(aWagtailPage);
            },
        };

        function getWagtailPageModelName(wagtailPage) {
            const type = wagtailPage.meta.type;
            return type.substring(type.lastIndexOf(".") + 1);
        }
    </script>
</App>
