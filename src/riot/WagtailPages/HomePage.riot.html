<Home>
    <div class="wave"></div>
    <div class="header">
        <div class="header-box">
            <div class="left-block">
                <h3>{ greetingMessage() }</h3>
                <h6 if="{state.currentCourse && isCurrentCourseInProgress(state.currentCourse)}">
                    { continueLearningMessage() }
                </h6>
                <ContinueLearningButton if="{state.currentCourse && isCurrentCourseInProgress(state.currentCourse)}"
                    class="profile header-text"
                    background="home-background-image"
                ></ContinueLearningButton>
            </div>
            <span class="home-background-image"></span>
        </div>
    </div>
    <div class="content-wrapper">
        <div class="section-title">
            <div>
                <h5 translate>Your courses</h5>
                <span>
                    <hr>
                </span>
            </div>
        </div>
        <div
            class="course"
            each="{course in props.wagtailPage.courses}"
        >
            <div class="course-header">
                <span class="background-{course.data.colour}"></span>
                <div>
                    <a href="#{course.data.id}"> <h3>{course.data.title}</h3> </a>
                    <div>
                        <p>{ courseProgressMessage(course) }</p>
                        <a href="#{course.data.id}">
                            <p class="text-purple" translate>view all</p>
                            <span class="arrow background-purple"></span>
                        </a>
                    </div>
                </div>
            </div>
            <Card
                if="{state.nextLesson[course.data.id]}"
                title="{state.nextLesson[course.data.id].title}"
                description="{state.nextLesson[course.data.id].description}"
                duration="{state.nextLesson[course.data.id].duration}"
                link="{state.nextLesson[course.data.id].id}"
                isCompleted="{isLessonComplete(course, state.nextLesson[course.data.id])}"
                isComingSoon="{state.nextLesson[course.data.id].coming_soon}"
            >
            </Card>
        </div>
    </div>

    <script>
        import { getOrFetchManifest, getOrFetchWagtailPage } from "js/WagtailPagesAPI";
        import ContinueLearningButton from "RiotTags/Components/ContinueLearningButton.riot.html";
        import Card from "RiotTags/Components/Card.riot.html";

        import { getUsername } from "js/AuthenticationUtilities";
        import { 
            getAllLessons, 
            getNumberOfCompletedLessons,
            getNumberOfCompletedLessonsFor 
        } from "js/utilities";
        import { 
            countComplete, 
            isComplete, 
            getMostRecentCompletion,
            isTheCourseComplete 
        } from "Actions/completion";
        import { ON_COMPLETION_CHANGE } from "js/Events";
        export default {
            state: {
                nextLesson: {},
                courses: [],
                currentCourse: null
            },

            components: {
                card: Card,
                continuelearningbutton: ContinueLearningButton
            },

            onBeforeMount(props, state) {
                const courses = props.wagtailPage.courses;
                const lastWorkedOnCourse = this.getCurrentCourse(courses);
                courses.forEach(course => {
                    this.getNextLesson(course);
                });

                this.state.courses = courses;
                this.state.currentCourse = lastWorkedOnCourse;
            },
            continueLearningMessage() {
                return ngettext(
                    "You only have %1 lesson left to finish %2.",
                    "You only have %1 lessons left to finish %2.",
                    this.state.currentCourse.data.lessons_count - getNumberOfCompletedLessonsFor(this.state.currentCourse),
                    this.state.currentCourse.data.title
                );
            },
            courseProgressMessage(course) {
                // displays how many lessons are complete and how many lessons are in the current course
                return ngettext(
                    "%2 / %1 lesson complete",  // this is the singular form
                    "%2 / %1 lessons complete",             // this is the plural form
                    course.data.lessons_count,              // the plurality of this number decides which form is used
                    course.data.lessons_count,              // first subsequent argument replaces %1
                    countComplete(course.data.slug),        // other subsequent arguments replace %2+
                );
            },

            greetingMessage() {
                // Greet the user with their username
                return gettext(
                    "Hi %1",
                    getUsername()
                );
            },

            getCurrentCourse(courses) {
                const lastCompletion = getMostRecentCompletion();
                if (lastCompletion === null) {
                    return null;
                }
                const lastWorkedOnCourse = courses.find(
                    course => course.data.slug === lastCompletion.courseSlug
                );
                return lastWorkedOnCourse;
            },

            getNextLesson(course) {
                const lessons = course.lessons;
                const lastLesson = lessons[lessons.length - 1];

                const isUnfinishedAndIsntComingSoon = (lesson, course) => {
                    return !isComplete(course.data.slug, lesson.slug) && !lesson.coming_soon;
                };

                for (const lesson of lessons) {
                    if (
                        isUnfinishedAndIsntComingSoon(lesson, course) ||
                        lesson.id === lastLesson.id
                    ) {
                        this.state.nextLesson[course.data.id] = lesson;
                        return true;
                    }
                }
            },

            getPercentOfLessonsCompleted() {
                const percentage =
                    (getNumberOfCompletedLessons(this.state.courses) /
                        getAllLessons(this.state.courses).length) *
                    100;
                return Math.round(percentage) || 0;
            },

            isCurrentCourseInProgress(aCourse) {
                return !isTheCourseComplete(aCourse.data.slug, aCourse.lessons);
            },

            isLessonComplete(course, lesson) {
                return isComplete(course.data.slug, lesson.slug);
            }
        };
    </script>
</Home>
