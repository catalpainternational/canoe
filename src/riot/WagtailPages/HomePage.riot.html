<HomePage>
    <GuestBanner if="{showBanner()}" closeBanner="{closeBanner}"></GuestBanner>
    <div class="wave"></div>
    <div class="header">
        <div class="header-box">
            <div class="left-block">
                <h3>{ greetingMessage() }</h3>
                <h6 if="{state.currentCourse && isCourseInProgress(state.currentCourse)}">
                    { continueLearningMessage() }
                </h6>
                <ContinueLearningButton
                    if="{state.currentCourse && isCourseInProgress(state.currentCourse)}"
                    class="profile header-text"
                    background="home-background-image"
                ></ContinueLearningButton>
            </div>
            <span class="home-background-image"></span>
        </div>
    </div>
    <div class="content-wrapper">
        <TagList
            if="{state.sortedListOfCourses.length > 0 && state.listOfTags.length > 0}"
            tags="{state.listOfTags}"
            onTagClick="{onTagClick}"
            selectedTags="{state.selectedTags}"
        ></TagList>
        <div
            class="course"
            each="{course in state.sortedListOfCourses}"
            if="{doesCourseHaveTag(course)}"
        >
            <Card
                title="{course.data.title}"
                link="{course.data.id}"
                description="{courseProgressMessage(course)}"
                isCompleted="{!isCourseInProgress(course)}"
                showFooter="{true}"
                type="course"
            ></Card>
        </div>
        <p if="{!state.isLoading && state.sortedListOfCourses.length === 0}">
            { TRANSLATIONS.noCourses() }
        </p>
    </div>

    <script>
        import ContinueLearningButton from "RiotTags/Components/ContinueLearningButton.riot.html";
        import Card from "RiotTags/Components/Card.riot.html";
        import TagList from "RiotTags/Components/TagList.riot.html";
        import GuestBanner from "RiotTags/Components/GuestBanner.riot.html";

        import { getCapitalizedUsername, isGuestUser } from "js/AuthenticationUtilities";
        import { isComplete } from "Actions/completion";
        import {
            countCompleteLessonsInCourses,
            getLatestCompletion,
            isCourseInProgress,
        } from "js/CompletionInterface";
        import { ON_COMPLETION_CHANGE } from "js/Events";
        import { getTagsFromPages, doPageTagsMatchSelections } from "js/SearchAndFiltering";
        import { toggleGuestBanner, isGuestBannerVisible } from "ReduxImpl/Store";

        export default {
            state: {
                currentCourse: null,
                selectedTags: [],
                listOfTags: [],
                sortedListOfCourses: [],
                isLoading: false,
            },

            components: {
                card: Card,
                continuelearningbutton: ContinueLearningButton,
                taglist: TagList,
                guestbanner: GuestBanner,
            },

            TRANSLATIONS: {
                noCourses: () => gettext("There are no courses yet. Check back soon!"),
            },

            async onMounted(props, state) {
                this.update({ isLoading: true });
                const unsortedCourses = props.wagtailPage.courses.filter(
                    (course) => course.lessons.length
                );

                const currentCourse = this.getCurrentCourse(unsortedCourses);
                const listOfTags = getTagsFromPages(unsortedCourses);
                const allVisibleCourses = isGuestUser()
                    ? this.removeHiddenCoursesFrom(unsortedCourses)
                    : unsortedCourses;
                const sortedListOfCourses = this.sortCourses(allVisibleCourses);
                this.update({
                    currentCourse,
                    listOfTags,
                    sortedListOfCourses,
                    isLoading: false,
                });
            },

            removeHiddenCoursesFrom(allCourses) {
                let coursesVisibleToGuests = [];
                allCourses.map((course) => {
                    if (course.is_visible_to_guests) {
                        coursesVisibleToGuests.push(course);
                    }
                });
                return coursesVisibleToGuests;
            },

            sortCourses(courses) {
                const completedCourses = [];
                const incompleteCourses = [];

                courses.map((course) => {
                    if (this.isCourseInProgress(course)) {
                        incompleteCourses.push(course);
                    } else {
                        completedCourses.push(course);
                    }
                });

                const sortedCourses = incompleteCourses.concat(completedCourses);
                return sortedCourses;
            },

            continueLearningMessage() {
                const { currentCourse } = this.state;
                return ngettext(
                    "You only have %1 lesson left to finish %2.",
                    "You only have %1 lessons left to finish %2.",
                    this.state.currentCourse.data.lessons_count -
                        countCompleteLessonsInCourses([currentCourse]),
                    this.state.currentCourse.data.title
                );
            },

            courseProgressMessage(course) {
                return ngettext(
                    "%1 lesson complete",
                    "%1 lessons complete",
                    this.calculateCourseProgress(course)
                );
            },

            calculateCourseProgress(course) {
                return countCompleteLessonsInCourses([course]) + " / " + course.data.lessons_count;
            },

            greetingMessage() {
                // Greet the user with their username
                return gettext("Hi %1", getCapitalizedUsername());
            },

            getCurrentCourse(courses) {
                const latestCompletion = getLatestCompletion(courses);
                if (latestCompletion === null) {
                    return null;
                }
                const lastWorkedOnCourse = courses.find(
                    (course) => course.data.slug === latestCompletion.courseSlug
                );
                return lastWorkedOnCourse;
            },

            isCourseInProgress(aCourse) {
                return isCourseInProgress(aCourse);
            },

            isLessonComplete(course, lesson) {
                return isComplete(course.data.slug, lesson.slug);
            },

            onTagClick(clickedTag) {
                if (this.state.selectedTags.includes(clickedTag)) {
                    const tagIndex = this.state.selectedTags.indexOf(clickedTag);
                    this.state.selectedTags.splice(tagIndex, 1);
                } else {
                    this.state.selectedTags.push(clickedTag);
                }
                this.update();
            },

            doesCourseHaveTag(course) {
                const { tags } = course;
                const { selectedTags } = this.state;
                const lowercaseCourseTags = tags.map((tag) => tag.toLowerCase());

                return doPageTagsMatchSelections(lowercaseCourseTags, selectedTags);
            },

            showBanner() {
                return isGuestUser() && isGuestBannerVisible();
            },

            closeBanner() {
                toggleGuestBanner(false);
                this.showBanner();
                this.update();
            },
        };
    </script>
</HomePage>
