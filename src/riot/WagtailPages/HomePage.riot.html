<Home>
    <div class="wave"></div>
    <div class="header">
        <div class="header-box">
            <div class="left-block">
                <h3>{ greetingMessage() }</h3>
                <h6 if="{state.currentCourse}">
                    { state.messageAboveContinueButton }
                </h6>
                <ContinueLearningButton
                    if="{state.currentCourse}"
                    class="profile header-text"
                    background="home-background-image"
                ></ContinueLearningButton>
            </div>
            <span class="home-background-image"></span>
        </div>
    </div>
    <div class="content-wrapper">
        <h5 class="section-title" translate>Your courses</h5>
        <CoursePromo
            each="{course in state.courses}"
            course="{course}"
        ></CoursePromo>
    </div>

    <script>
        import ContinueLearningButton from "RiotTags/Components/ContinueLearningButton.riot.html";
        import CoursePromo from "RiotTags/Components/CoursePromo.riot.html";

        import { getUsername } from "js/AuthenticationUtilities";
        import { getAllLessons } from "js/utilities";
        import {
            getNumberOfCompletedLessons,
            getNumberOfCompleteLessons,
        } from "js/LearningStatistics";
        import {
            isComplete,
            getMostRecentCompletion,
            isTheCourseCompleteNew,
        } from "Actions/completion";
        import { ON_COMPLETION_CHANGE } from "js/Events";
        import { getCourseById, getACoursesLessons } from "js/WagtailPagesAPI";

        export default {
            state: {
                courses: [],
                currentCourse: null,
                messageAboveContinueButton: "",
            },

            components: {
                continuelearningbutton: ContinueLearningButton,
                coursepromo: CoursePromo,
            },

            onMounted(props, state) {
                this.renderHomePage(props, state);
            },

            async renderHomePage(props, state) {
                const courseIds = props.wagtailPage.courseIds;
                const courses = [];
                for (const courseId of courseIds) {
                    courses.push(await getCourseById(courseId));
                }

                const lastWorkedOnCourse = await this.getCurrentCourse(courses);
                let messageAboveContinueButton = "";
                if (lastWorkedOnCourse) {
                    messageAboveContinueButton = await this.getContinueLearningMessage(
                        lastWorkedOnCourse
                    );
                }

                this.update({
                    courses,
                    currentCourse: lastWorkedOnCourse,
                    messageAboveContinueButton,
                });
            },

            async getContinueLearningMessage(currentCourse) {
                const lessons = await getACoursesLessons(currentCourse.id);
                const lessonSlugs = lessons.map((lesson) => lesson.slug);
                const numberOfLessons = lessons.length;

                const messageAboveContinueButton = ngettext(
                    "You only have %1 lesson left to finish %2.",
                    "You only have %1 lessons left to finish %2.",
                    numberOfLessons - getNumberOfCompleteLessons(currentCourse.slug, lessonSlugs),
                    currentCourse.title
                );
                return messageAboveContinueButton;
            },

            greetingMessage() {
                // Greet the user with their username
                return gettext("Hi %1", getUsername());
            },

            async getCurrentCourse(courses) {
                const lastCompletion = getMostRecentCompletion();
                if (lastCompletion === null) {
                    return null;
                }

                const lastWorkedOnCourse = courses.find(
                    (course) => course.slug === lastCompletion.courseSlug
                );

                if (!lastWorkedOnCourse) {
                    return null;
                }

                const andItsLessons = await getACoursesLessons(lastWorkedOnCourse.id);

                const isCourseComplete = this.isCurrentCourseComplete(
                    lastWorkedOnCourse,
                    andItsLessons
                );

                if (isCourseComplete) {
                    return null;
                }

                return lastWorkedOnCourse;
            },

            getPercentOfLessonsCompleted() {
                const percentage =
                    (getNumberOfCompletedLessons(this.state.courses) /
                        getAllLessons(this.state.courses).length) *
                    100;
                return Math.round(percentage) || 0;
            },

            isCurrentCourseComplete(aCourse, lessons) {
                const lessonSlugs = lessons.map((lesson) => lesson.slug);
                return isTheCourseCompleteNew(aCourse.slug, lessonSlugs);
            },
        };
    </script>
</Home>
