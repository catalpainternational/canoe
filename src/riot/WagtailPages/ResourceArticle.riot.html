<ResourceArticle>
    <LessonFrame
        if="{ props.lesson.ready && state.cardNumber <= state.cards.length }"
        extraStyleClasses="content"
        progressValue="{ state.cardNumber }"
        progressMax="{ state.cards.length }"
        lesson="{ props.lesson }"
        noCardStyle="{true}"
        resourceTitle="{props.lessonContent.title}"
    >
        <p  if="{props.description}" class="resource-description">{ props.description }</p>
    <template each="{card in state.cards}">
        <Raw if="{card.tag === 'raw'}" html="{card.content}" class="content-block"></Raw>
        <BasicCard if="{card.tag === 'basic'}" card="{card}" class="content-block"></BasicCard>
        <AudioCard
            if="{card.media_type === 'audio'}"
            media="{card}"
            class="content-block"
        ></AudioCard>
        <VideoCard
            if="{card.media_type === 'video'}"
            media="{card}"
            class="content-block"
        ></VideoCard>
        <QuoteCard if="{card.tag === 'quote'}" card="{card}" class="content-block"></QuoteCard>
        <ListCard if="{card.tag === 'list'}" card="{card}" class="content-block"></ListCard>
        <PdfCard if="{card.tag === 'pdf'}" card="{card}" class="content-block"></PdfCard>
    </template>
    </LessonFrame>
    <div if="{props.lesson && state.cardNumber <= state.cards.length}" class="bottom-buttons">
        <div>
            <a if="{ state.cardNumber > 1 }" class="has-circle" onclick="{ goBack }">
                <span class="arrow"></span>
            </a>
        </div>
        <div>
            <button
                class="btn-primary"
                onclick="{ nextContentCard }"
                if="{ state.cardNumber < state.cards.length }"
            >
                { TRANSLATIONS.next() }
            </button>
            <button
                class="btn-primary"
                onclick="{ completeContentModal }"
                if="{ state.cardNumber === state.cards.length }"
            >
                { TRANSLATIONS.finish() }
            </button>
        </div>
    </div>

    <script>
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";
        import Raw from "RiotTags/Components/Raw.riot.html";
        import BasicCard from "RiotTags/Components/BasicCard.riot.html";
        import VideoCard from "RiotTags/Lesson/VideoCard.riot.html";
        import AudioCard from "RiotTags/Lesson/AudioCard.riot.html";
        import QuoteCard from "RiotTags/Components/QuoteCard.riot.html";
        import ListCard from "RiotTags/Lesson/ListCard.riot.html";
        import PdfCard from "RiotTags/Lesson/PdfCard.riot.html";
        import Html5Card from "RiotTags/Lesson/Html5Card.riot.html";


        function readState(props) {
            const route = getRoute();
            const stage = route.riotHash[1];
            const cardNumber = parseInt(stage);
            const state = {
                cards: props.lesson.ready ? props.lesson.content.cards : [],
                card: props.lesson.ready ? props.lesson.content.cards[cardNumber - 1] : undefined,
                cardNumber: cardNumber,
                complete: stage === 'complete'
            };
            return state;
        }

        function LessonContent() { return {

            TRANSLATIONS: {
                next: () => gettext("Next"),
                finish: () => gettext("Finish"),
            },

            onBeforeMount(props, state) {
                this.state = readState(props);
            },
            
            onBeforeUpdate(props, state) {
                this.state = readState(props);
            },

            goBack() {
                location.hash = `${this.props.lesson.loc_hash}:content:${this.state.cardNumber - 1}`;
            },

            nextContentCard() {
                window.scroll(0, 0);
                location.hash = `${this.props.lesson.loc_hash}:content:${this.state.cardNumber + 1}`;
            },

            completeContentModal() {
                this.props.lesson.completeSection(this.props.module);
                location.hash = `${this.props.lesson.loc_hash}:content:complete`;
            },

            checkForPlayableVideos() {
                this.state.iframes = this.$$("iframe");
            },

            onUpdated() {
                this.checkForPlayableVideos();
            },
        }}

        LessonContent.components = {
            basiccard: BasicCard,
            quotecard: QuoteCard,
            listcard: ListCard,
            raw: Raw,
            lessonframe: LessonFrame,
            videocard: VideoCard,
            audiocard: AudioCard,
            pdfcard: PdfCard,
            html5card: Html5Card,
        };

    // 
        import { getRoute } from "ReduxImpl/Interface";

        export default {
            onBeforeMount() {
                this.state.resource = getRoute().page;
                this.state.isLoading = !this.state.resource.ready;
            },
            onBeforeUpdate() {
                this.state.isLoading = !this.state.resource.ready;
            },
        }
    </script>
</ResourceArticle>
