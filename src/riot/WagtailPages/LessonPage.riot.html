<LessonPage>
    <LessonFrame
        if="{lesson.ready}"
        extrastyleclasses="message-container"
        linkTo="{lesson.course.loc_hash}"
    >
        <h5>Lesson</h5>
        <h3>{lesson.title}</h3>
        <div if="{lesson.cardImage}" class="lesson-page-image-wrap">
            <img
                crossorigin="anonymous"
                src="{getMediaUrl(lesson.cardImage)}"
                class="lesson-page-image"
            />
        </div>
        <span if="{!lesson.cardImage}" class="lesson-presentation"></span>
        <p>{lesson.shortDescription}</p>
        <p>{lesson.longDescription}</p>
    </LessonFrame>
    <div if="{lesson.ready}" class="bottom-buttons">
        <button class="btn-primary" onclick="{startLesson}">
            { TRANSLATIONS.start() }
        </button>
    </div>

    <script>
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";

        import { getMediaUrl } from "js/RenditionSelector";
        import { getRoute } from "ReduxImpl/Interface";

        function LessonPage() { return {
            state: {
                showLongDescription: false,
            },

            TRANSLATIONS: {
                lesson_activities: () => gettext("Lesson Activities"),
                more: () => gettext("See more"),
                less: () => gettext("See less"),
                start: () => gettext("Start lesson"),
            },

            OBJECTIVES: "objectives",
            CONTENT: "content",
            TEST: "test",

            onBeforeMount(props, state) {
                this.lesson = getRoute().page;
            },

            onMounted(props, state) {
                this.disableBlockedLessonModules();
            },

            onUpdated() {
                this.disableBlockedLessonModules();
            },

            startLesson() {
                location.hash = `#${this.lesson.loc_hash}:content:1`;
            },

            backToCoursePage() {
                location.hash = "#" + this.lesson.course.loc_hash;
            },

            toggleLessonDescription() {
                this.update({
                    showLongDescription: !this.state.showLongDescription,
                });
            },

            disableBlockedLessonModules() {
                const ongoingCards = [...document.getElementsByClassName("ongoing")];

                const isComingSoon = this.lesson.isComingSoon();
                let sliceFrom = 1;

                if (isComingSoon) {
                    sliceFrom = 0;
                }

                const cardsToDisable = ongoingCards.slice(sliceFrom);
                for (const card of cardsToDisable) {
                    card.classList.add("disabled");
                }
            },

            moduleStatus(module) {
                if (this.lesson.isModuleComplete(module)) {
                    return "complete";
                } else {
                    return "not-started";
                }
            },

            getMediaUrl(documentPath) {
                return `${getMediaUrl(documentPath)}`;
            },
        }};

        LessonPage.components = {
            lessonframe: LessonFrame,
        };

        export default LessonPage;
    </script>
</LessonPage>
