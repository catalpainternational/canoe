<CoursePage>
    <div if="{state.hash == null}" class="course background-blue-1">
        <div class="content-wrapper">
            <div class="course-header">
                <div>
                    <div>
                        <a class="arrow-gray" onclick="{backToHome}"></a>
                    </div>
                    <div>
                        <p translate>Course</p>
                    </div>
                    <h3>{props.wagtailPage.data.title}</h3>
                    <div>
                        <p class="bottom-border">{ numberOfLessonsCompleteMessage() }</p>
                    </div>
                </div>
            </div>
            <h5 class="section-title" translate>Your lessons</h5>
            <Card
                each="{lesson in props.wagtailPage.lessons}"
                title="{lesson.title}"
                description="{lesson.description}"
                duration="{lesson.duration}"
                link="{lesson.id}"
                isCompleted="{isLessonComplete(lesson)}"
                isComingSoon="{lesson.coming_soon}"
                showFooter="{true}"
            ></Card>
            <h5 class="section-title" translate>Course exam</h5>
            <Card
                title="{'Title of Exam'}"
                description="{'this is the course exam description'}"
                duration="{15}"
                link="{props.wagtailPage.id}/exam/0"
                isCompleted="{false}"
                isComingSoon="{false}"
                showFooter="{true}"
                isExam="{true}"
                isDisabled="{!state.isCourseComplete}"
            ></Card>
        </div>
    </div>
    <CourseExam
        if="{state.hash === examModule}"
        wagtailPage="{props.wagtailPage}"
        module="exam"
        cards="{examCards}"
    ></CourseExam>

    <script>
        import { countCompleteLessonsInCourse } from "js/LearningStatistics";
        import { isComplete, isTheCourseComplete } from "Actions/completion";
        import { getCourseAndLessonSlugs } from "js/utilities";
        import { getHashPieces } from "js/Routing";
        import Card from "RiotTags/Components/Card.riot.html";
        import CourseExam from "RiotTags/Lesson/CourseExam.riot.html";

        export default {
            state: {
                hash: "",
            },

            components: {
                card: Card,
                courseexam: CourseExam,
            },

            examModule: "exam",

            examCards: [
                {
                    answers: [
                        { correct: false, text: "incorrect" },
                        { correct: true, text: "this is correct" },
                        { correct: false, text: "Another incorrect answer" },
                        {
                            correct: false,
                            text: "Another incorrect answer here it is a bit longer",
                        },
                    ],
                    question: "will it keep raining?",
                },
                {
                    answers: [
                        { correct: true, text: "correct time" },
                        { correct: true, text: "correct too" },
                        { correct: false, text: "incorrect" },
                    ],
                    question: "what time is it?",
                },
                {
                    answers: [
                        { correct: false, text: "ba dum dum dum" },
                        { correct: true, text: "dee ba da" },
                        { correct: false, text: "ba dum dum dum" },
                        { correct: true, text: "dee ba da" },
                    ],
                    question: "What does Karen sing?",
                },
            ],

            onBeforeMount(props, state) {
                state.hash = getHashPieces()[1];
                window.addEventListener("hashchange", this.hashChanged);
            },

            onMounted(props, state) {
                state.header = document.getElementsByClassName("course-header")[0];
                state.headerOffsetTop = state.header.offsetTop;
                window.addEventListener("scroll", this.stickyHeader);

                const { courseSlug, lessonSlugs } = getCourseAndLessonSlugs(this.props.wagtailPage);
                this.update({ isCourseComplete: isTheCourseComplete(courseSlug, lessonSlugs) });
            },

            onBeforeUnmount(props, state) {
                window.removeEventListener("hashchange", this.hashChanged);
            },

            onUnmounted() {
                window.removeEventListener("scroll", this.stickyHeader);
            },

            hashChanged() {
                this.update({
                    hash: getHashPieces()[1],
                });

                if (this.state.hash) {
                    window.removeEventListener("scroll", this.stickyHeader);
                } else {
                    window.addEventListener("scroll", this.stickyHeader);
                }
            },

            getCourseProgress() {
                const { courseSlug, lessonSlugs } = getCourseAndLessonSlugs(this.props.wagtailPage);
                return (
                    countCompleteLessonsInCourse(courseSlug, lessonSlugs) +
                    " / " +
                    this.props.wagtailPage.data.lessons_count
                );
            },

            backToHome() {
                location.hash = "#";
            },

            stickyHeader() {
                if (window.pageYOffset > this.state.headerOffsetTop) {
                    this.state.header.classList.add("sticky");
                } else {
                    this.state.header.classList.remove("sticky");
                }
            },

            isLessonComplete(lesson) {
                return isComplete(this.props.wagtailPage.data.slug, lesson.slug);
            },

            numberOfLessonsCompleteMessage() {
                // the number of lessons completed in a course
                return ngettext(
                    "%1 lesson complete",
                    "%1 lessons complete",
                    this.getCourseProgress()
                );
            },
        };
    </script>
</CoursePage>
