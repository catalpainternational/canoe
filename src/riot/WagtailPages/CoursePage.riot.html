<CoursePage>
    <TopMenu extrastyleclasses="without-swoop">
        <a class="top-icon left has-circle" onclick="{backToAllCourses}">
            <span class="arrow"></span>
        </a>
    </TopMenu>

    <div class="content-wrapper">
        <div>
            <h3 id="coursePageTitle">{props.wagtailPage.title}</h3>
        </div>
        <div class="lesson-swoop">
            <h5 class="section-title">{ TRANSLATIONS.your_lessons() }</h5>
            <LoadingDots if="{state.lessons.length === 0}" extrastyleclasses="dark"></LoadingDots>
            <div class="card-container">
                <Card
                    each="{lesson in state.lessons}"
                    status="{lessonStatus(lesson)}"
                    title="{lesson.title}"
                    link="{lesson.id}"
                ></Card>
            </div>
            <template if="{state.lessons.length > 0 && props.examCards.length > 0}">
                <h5 class="section-title">{ TRANSLATIONS.course_exam() }</h5>
                <Card
                    title="{courseExamTitle()}"
                    description="{props.wagtailPage.hasUserTriedExam() ? `${TRANSLATIONS.highestScore()}: ${props.wagtailPage.getExamHighScore()}%` : ''}"
                    link="{props.wagtailPage.id}/exam/0"
                    status="{examStatus(props.wagtailPage)}"
                ></Card>
            </template>
        </div>
    </div>

    <script>
        import Card from "RiotTags/Components/Card.riot.html";
        import CourseExam from "RiotTags/Lesson/CourseExam.riot.html";
        import LoadingDots from "RiotTags/Components/LoadingDots.riot.html";
        import TopMenu from "RiotTags/Components/TopMenu.riot.html";

        import { isGuestUser } from "js/AuthenticationUtilities";

        export default {
            TRANSLATIONS: {
                your_lessons: () => gettext("Your lessons"),
                course_exam: () => gettext("Course exam"),
                highestScore: () => gettext("Highest score"),
            },

            components: {
                card: Card,
                courseexam: CourseExam,
                loadingdots: LoadingDots,
                topmenu: TopMenu,
            },

            state: {
                header: null,
                coursePageTitle: null,
                lessons: [],
            },

            async onMounted(props, state) {
                const header = this.$(".course-header");
                const coursePageTitle = this.$("#coursePageTitle");
                const { wagtailPage: course } = props;
                const lessons = await course.getFullLessonObjects();

                this.update({ header, lessons, coursePageTitle });
            },

            backToAllCourses() {
                location.hash = "#";
            },

            isExamDisabled() {
                // Exams are enabled if you complete all lessons or if you are a
                // guest user.
                const { wagtailPage: course } = this.props;
                const isExamUnlocked =
                    course.numberOfFinishedLessons === course.numberOfLessons - 1;
                return !isExamUnlocked && !isGuestUser();
            },

            courseExamTitle() {
                let p = gettext("%1's Course Exam", this.props.wagtailPage.title);
                return p;
            },

            lessonStatus(lesson) {
                if (lesson.isComingSoon()) {
                    return "coming-soon";
                } else if (lesson.isFinished()) {
                    return "complete";
                } else {
                    return "not-started";
                }
            },

            examStatus(exam) {
                if (exam.isExamFinished()) {
                    return "complete";
                } else if (this.isExamDisabled()) {
                    return "disabled";
                } else {
                    return "not-started";
                }
            },
        };
    </script>
</CoursePage>
