<CoursePage>
    <TopMenu extrastyleclasses="without-swoop">
        <a class="top-icon left has-circle" onclick="{backToAllCourses}">
            <span class="arrow"></span>
        </a>
    </TopMenu>

    <div class="content-wrapper">
        <div>
            <h2 id="coursePageTitle">{props.page.title}</h2>
        </div>
        <div class="lesson-swoop">

            <h5 class="section-title">{ TRANSLATIONS.your_lessons() }</h5>
            <LoadingDots if="{ !props.page.ready }" extrastyleclasses="dark"></LoadingDots>
            <template if="{ props.page.ready }">
                <div class="card-container">
                    <p if="{! props.page.lessons.length }">{ TRANSLATIONS.no_lessons() }</h5>
                    <Card
                        each="{lesson in props.page.lessons}"
                        status="{lessonStatus(lesson)}"
                        availability="{lesson.isAvailableOffline}"
                        title="{lesson.title}"
                        link="{lesson.loc_hash}"
                    ></Card>
                </div>
                <template if="{ props.page.hasExam }">
                    <h5 class="section-title">{ TRANSLATIONS.course_exam() }</h5>
                    <Card
                        title="{examTitle()}"
                        description="{examDescription()}"
                        link="{ `${props.page.loc_hash}:exam` }"
                        status="{examStatus(props.wagtailPage)}"
                    ></Card>
                </template>
            </template>
        </div>
    </div>

    <script>
        import Card from "RiotTags/Components/Card.riot.html";
        import CourseExam from "RiotTags/Lesson/CourseExam.riot.html";
        import LoadingDots from "RiotTags/Components/LoadingDots.riot.html";
        import TopMenu from "RiotTags/Components/TopMenu.riot.html";

        import { isGuestUser } from "js/AuthenticationUtilities";

        function CoursePage() { return {
            state: {
                coursePageTitle: null,
                lessons: [],
            },
            TRANSLATIONS: {
                no_lessons: () => gettext("There are no lessons yet in this course"),
                your_lessons: () => gettext("Your lessons"),
                course_exam: () => gettext("Course exam"),
                highestScore: () => gettext("Highest score"),
            },

            storeListener(previousStoreState, storeState) {
                const page = this.props.page;
                if (!this.state.pageReady && page.ready) {
                    this.update({pageReady: true});
                }
                if (!this.state.availableOffline || this.state.availableOffline !== page.isAvailableOffline) {
                    this.update({ isAvailableOffline: page.isAvailableOffline });
                }
            },

            onBeforeMount(props, state) {
                state.pageReady = props.page.ready;
            },

            backToAllCourses() {
                location.hash = "#";
            },

            examDescription() {
                const course = this.props.page;
                return (
                    course.hasUserTriedExam
                     ? `${this.TRANSLATIONS.highestScore()}: ${course.examHighScore}%`
                     : ''
                );
            },

            isExamEnabled() {
                // Exams are enabled if you complete all lessons or if you are a
                // guest user.
                return this.props.page.allLessonsComplete || isGuestUser();
            },

            examTitle() {
                let p = gettext("%1's Course Exam", this.props.page.title);
                return p;
            },

            lessonStatus(lesson) {
                if (lesson.isComingSoon()) {
                    return "coming-soon";
                } else if (lesson.isFinished()) {
                    return "complete";
                } else {
                    return "not-started";
                }
            },

            examStatus() {
                if (this.props.page.isExamFinished) {
                    return "complete";
                } else if (!this.isExamEnabled()) {
                    return "disabled";
                } else {
                    return "not-started";
                }
            },
            
            availabilityStatus() {
                return this.state.isAvailableOffline ? "Available Offline" : "Not Available Offline";
            },
        }};

        CoursePage.components = {
            card: Card,
            courseexam: CourseExam,
            loadingdots: LoadingDots,
            topmenu: TopMenu,
        };

        export default CoursePage;
    </script>
</CoursePage>
