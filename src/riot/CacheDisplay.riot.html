<CacheDisplay>
    <h3>Storage Use</h3>
    <div if={ state.quotaInfo }>
        <label for="quota">{ pretty(state.quotaInfo.usage) } of { pretty(state.quotaInfo.quota) }</label>
        <br />
        <progress id="quota" value="{ state.quotaInfo.pct }" max="100"> { state.quotaInfo.pct }% </progress>
    </div>
    <h4>Summary</h4>
    <table if={ state.cacheSummary }>
        <thead>
            <tr>
                <th>Type</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            <tr each={ cache in Object.entries(state.cacheSummary) }>
                <th>{ cache[0] }</th>
                <th>{ pretty(cache[1]) }</th>
            </tr>
        </tbody>
    </table>
    <h4>Details</h4>
    <table if={ state.cachesInfo }>
        <thead>
            <tr>
                <th>Cache</th>
                <th>Total</th>
                <th>Count</th>
                <th>Avg</th>
            </tr>
        </thead>
        <tbody>
            <tr each={ cache in state.cachesInfo }>
                <th>{ cache.name }</th>
                <th>{ pretty(cache.size) }</th>
                <th>{ cache.count }</th>
                <th>{ pretty(cache.size / cache.count) }</th>
            </tr>
        </tbody>
    </table>

    <script>
        import { getCachesInfo, storageQuota } from "js/cacheManager/cacheManager";
        import { MANIFEST_CACHE_NAME, PAGES_CACHE_NAME } from "ts/Constants";

        import prettyBytes from "pretty-bytes";

        export default {
            state: {
                cacheInfo: false,
            },
            onMounted() {
                this.getInfo();
            },
            async getInfo() {
                const cacheSummary = {
                    'App': 0,
                    'Pages': 0,
                    'Images': 0,
                    'Media': 0
                };
                const cachesInfo = await getCachesInfo();
                cachesInfo.forEach(q => {
                    switch (q.name) {
                        case 'workbox-precache-v2-http://localhost:8080/':
                        case MANIFEST_CACHE_NAME:
                            cacheSummary['App'] += q.size;
                            break;
                        case PAGES_CACHE_NAME:
                            cacheSummary['Pages'] += q.size;
                            break;
                        case 'images-cache':
                            cacheSummary['Images'] += q.size;
                            break;
                        case 'media-cache':
                            cacheSummary['Media'] += q.size;
                            break;
                    }
                });
                const quotaInfo = await storageQuota();

                this.update({
                    quotaInfo,
                    cachesInfo,
                    cacheSummary,
                });
            },

            pretty(bytes) {
                return prettyBytes(bytes);
            }
        };
    </script>
</CacheDisplay>
