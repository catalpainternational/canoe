<References>
    <div class="content-wrapper">
        <div class="references-bar">
            <span if="{!state.searchOpen}" class="references-icon title"></span>
            <h3 if="{!state.searchOpen}" translate>Quick references</h3>
            <input if="{state.searchOpen}" id="search" type="text" />
            <span if="{state.searchOpen}" class="search-icon active"></span>
            <a class="{!state.searchOpen ? 'search-icon' : 'cross gray'}" onclick="{toggleSearch}"></a>
        </div>
        <TagList
            tags="{listOfTags}"
            onTagClick="{onTagClick}"
            selectedTags="{state.selectedTags}"
        >
        </TagList>
        <div each="{article in props.wagtailPage}">
            <Card
                if="{isReferenceArticleVisible(article)}"
                title="{article.title}"
                description="{article.tags}"
                link="references?"
                showFooter="{false}"
            >
            </Card>
        </div>
    </div>

    <script>
        import TagList from "RiotTags/Components/TagList.riot.html";
        import Card from "RiotTags/Components/Card.riot.html";

        export default {
            state: {
                searchOpen: false,
                selectedTags: [],
            },
        
            components: {
                taglist: TagList,
                card: Card,
            },

            listOfTags: [
                "covid",
                "triage",
                "symptoms",
                "treatment",
            ],
            
            onTagClick(clickedTag) {
                if (this.state.selectedTags.includes(clickedTag)) {
                    const tagIndex = this.state.selectedTags.indexOf(clickedTag);
                    this.state.selectedTags.splice(tagIndex, 1);
                } else {
                    this.state.selectedTags.push(clickedTag);
                }
                this.update();
            },

            getSearchQuery(){
                const query = this.$("#search");
                if (!this.state.searchOpen) {
                    return false;
                } else if (query.value.length < 3){
                    return false;
                } else {
                    return query.value;
                }
            },

            isReferenceArticleVisible(article) {
                const query = this.getSearchQuery();
                if (query) {
                    if (article.title.includes(query)) {
                        return true;
                    } else {
                        return false;
                    }
                }// else 
                
                if (this.state.selectedTags.length === 0) {
                    return true;
                 } else {
                    for (let i = 0; i < this.state.selectedTags.length; i++ ) {
                        if (article.tags.includes(this.state.selectedTags[i])) {
                            return true;
                        }
                    }
                }
            },

            toggleSearch() {
                this.update({ searchOpen: !this.state.searchOpen });
                if (this.state.searchOpen) {
                    const query = this.$("#search");
                    query.focus();
                }
            }
        }
    
    </script>
</References>
