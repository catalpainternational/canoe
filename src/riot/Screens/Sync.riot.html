<Sync>
    <div class="sync">
        <TopMenu extrastyleclasses="with-swoop">
            <h3>{ TRANSLATIONS.latest() }</h3>
            <div class="filter-copy-container">
                <a class="btn btn-primary" onclick="{syncMe}">Sync Me</a>
            </div>
        </TopMenu>        

        <div class="content-wrapper">
            <ol class="sync-list">
                <li
                    each="{(statusListing, index) in state.statusListings}">
                    <div class="sync-header">
                        <h5>ID:{statusListing.id} {statusListing.type}:{statusListing.title} <small>({statusListing.version})</small> </h5>
                    </div>

                    <div
                        class="sync-body"
                        if="{statusListing.storeStatus !== 'unset' || statusListing.cacheStatus !== 'unset'}"
                    >
                        <span>Store URL:{ statusListing.api_url }, status:{ statusListing.storeStatus }</span>
                    </div>

                    <div
                        class="sync-body"
                        if="{statusListing.storeStatus !== 'unset' || statusListing.cacheStatus !== 'unset'}"
                    >
                        <span>Cache Key:{ statusListing.cacheKey }, status:{ statusListing.cacheStatus }</span>
                    </div>

                    <div
                        class="sync-body"
                        if="{statusListing.storeStatus !== 'unset' || statusListing.cacheStatus !== 'unset'}"
                    >
                        <span>Validity:{ statusListing.isValid },  </span>
                        <span>Availablity:{ statusListing.isAvailableOffline },  </span>
                        <span>Publishable:{ statusListing.isPublishable }, </span>
                    </div>

                    <!-- <div class="sync-footer">
                        <a class="action">
                            <span class="arrow-blue"></span>
                            <p>{ TRANSLATIONS.start() }</p>
                        </a>
                        <div>
                            <p>{showTimeAgoFromNow(sync.timestamp)}</p>
                        </div>
                    </div> -->
                </li>
            </ol>
        </div>
    </div>

    <script>
        import { AppDataStatus } from "ts/AppDataStatus";
        import { AppelflapConnect } from "ts/AppelflapConnect";
        // import { CacheUtilities } from "ts/CacheUtilities";
        import { CachePublish } from "ts/CachePublish";
        import { Manifest } from "ts/Implementations/Manifest";

        export default {
            state: {
                statusListings: [],
                cacheStatus: "",
                publications: "",
                manifest: "",
                page: "",
                appDataStatus: new AppDataStatus(),
            },

            TRANSLATIONS: {
                latest: () => gettext("Latest syncs"),
                start: () => gettext("Start lesson"),
            },

            async onMounted() {
                await this.appelflapStatus();
            },

            async appelflapStatus() {
                this.update({ appelflapMeta: "Getting" });
                
                const appelflapConnect = new AppelflapConnect();
                const metaStatus = await appelflapConnect.getMetaStatus();
                this.update({ appelflapMeta: JSON.stringify(metaStatus) });

                /* Not yet implemented
                const cacheUtilities = new CacheUtilities(appelflapConnect);
                const cacheStatus = await cacheUtilities.status();
                this.update({ cacheStatus: JSON.stringify(cacheStatus) });
                */

                const cachePublish = new CachePublish(appelflapConnect);
                const publications = await cachePublish.publications();
                this.update(({ publications: JSON.stringify(publications) }));

                // Get the Item Status Listing
                await this.state.appDataStatus.Initialise();
                await this.state.appDataStatus.BuildList();
                this.update({statusListings: this.state.appDataStatus.itemListings});
            },

            async syncMe() {
                const cacheUtilities = new CacheUtilities(appelflapConnect);
                await cacheUtilities.unlock();

                // Identify what needs to be subscribed to, and what needs to be published
                const appDataStatus = this.state.appDataStatus;
                const syncStatus = await appDataStatus.SyncAll();

                await cacheUtilities.lock();

                window.alert(`Published: ${JSON.stringify(syncStatus)}`);
            },
        };
    </script>
</Sync>
