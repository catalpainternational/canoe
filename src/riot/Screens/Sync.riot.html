<Sync>
    <div class="sync">
        <div class="sync-header">
            <div class="header-box">
                <div class="left-block">
                    <h3>{ TRANSLATIONS.latest() }</h3>
                </div>
                <span class="syncs-image"></span>
            </div>
        </div>

        <div class="content-wrapper">
            <p>{state.cacheStatus}</p>
            <p>{state.cacheKeys}</p>
            <p>{state.publications}</p>
            <ol class="sync-list">
                <li
                    each="{(statusListing, index) in state.statusListings}">
                    <div class="sync-header">
                        <h6>{ `${statusListing.id}:${statusListing.type}:${statusListing.api_url}`}</h6>
                    </div>

                    <div class="sync-body">
                        <span>Version:{ statusListing.version }</span>
                        <span>Store:{ statusListing.storeStatus }</span>
                        <span>Cache:{ statusListing.storeStatus }</span>
                        <span>Validity:{ statusListing.isValid }</span>
                        <span>Availablity:{ statusListing.isAvailableOffline }</span>
                        <span>Publishable:{ statusListing.isPublishable }</span>
                    </div>

                    <!-- <div class="sync-footer">
                        <a class="action">
                            <span class="arrow-blue"></span>
                            <p>{ TRANSLATIONS.start() }</p>
                        </a>
                        <div>
                            <p>{showTimeAgoFromNow(sync.timestamp)}</p>
                        </div>
                    </div> -->
                </li>
            </ol>
        </div>
    </div>

    <script>
        import { AppDataStatus } from "ts/AppDataStatus";
        import { AppelflapConnect } from "ts/AppelflapConnect";
        import { CacheUtilities } from "ts/CacheUtilities";
        import { CachePublish } from "ts/CachePublish";
        import { Manifest } from "ts/Implementations/Manifest";

        export default {
            state: {
                statusListings: [],
                cacheStatus: "",
                cacheKeys: "",
                publications: "",
                manifest: "",
                page: "",
            },

            onMounted() {
                this.appelflapStatus();
            },

            async appelflapStatus() {
                const appelflapConnect = new AppelflapConnect();
                const cacheUtilities = new CacheUtilities(appelflapConnect);
                const cachePublish = new CachePublish(appelflapConnect);
                /* Not yet implemented
                cacheUtilities.status().then((response) => {
                    this.update({ cacheStatus: JSON.stringify(response) });
                });
                */
                let cacheKeys = [];
                cacheUtilities.cacheKeys().then((response) => {
                    cacheKeys = response;
                    this.update({ cacheKeys: cacheKeys });
                });
                cachePublish.publications().then((response) => {
                    this.update(({ publications: JSON.stringify(response) }));
                });

                // Get the Item Status Listing
                const appDataStatus = new AppDataStatus();
                await appDataStatus.Initialise();
                appDataStatus.BuildList();
                this.update({statusListings: appDataStatus.itemListings});

                // try to get the manifest
                // const manifest = new Manifest();
                // if (!manifest.isValid) {
                //     await manifest.initialiseByRequest();
                // }
                // if (manifest.isValid) {
                //     const data = JSON.stringify(manifest.data);
                //     this.update({ manifest: "Got a manifest" });

                //     // try getting a page
                //     const aPage = await manifest.getPageManifestData(
                //         "/site/resources/resource"
                //     );
                //     await aPage.initialiseByRequest();
                //     const manifestAssetCount = aPage.manifestAssets.length;
                //     const assetCount = aPage.assets.length;
                //     const pageData =
                //         `Page:${aPage.title} at ${aPage.loc_hash} ` +
                //         `Assets Defined:${manifestAssetCount} ` +
                //         `Assets Found:${assetCount} ` +
                //         `Valid:${aPage.isValid} ` +
                //         `Publishable:${aPage.isPublishable} ` +
                //         `Available Offline:${aPage.isAvailableOffline} ` +
                //         `Status:${aPage.status} `;
                //     this.update({ page: pageData });
                //     if (assetCount) {
                //         aPage.assets.forEach((asset) => {
                //             if (asset.isValid) {
                //                 this.update({ img: asset.fullUrl });
                //             }
                //         });
                //     }

                //     // try publishing the page
                //     aPage.publish(appelflapConnect);
                // }
            },
        };
    </script>
</Sync>
