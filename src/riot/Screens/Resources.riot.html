<Resources>
    <div class="content-wrapper" if="{state.hash == null}">
        <div class="resources-bar">
            <span class="resources-icon title"></span>
            <h3 translate>Resources</h3>
        </div>
        <SearchBar 
            if="{state.articles.length > 0}"
            query="{state.query}" 
            submitQuery="{submitQuery}"
        ></SearchBar>
        <TagList
            tags="{state.listOfAllTags}"
            onTagClick="{onTagClick}"
            selectedTags="{state.selectedTags}"
        ></TagList>
        <div each="{article in state.articles}">
            <Card
                if="{isResourceArticleVisible(article)}"
                title="{article.title}"
                description="{article.description}"
                link="{article.id}"
                showFooter="{false}"
            ></Card>
        </div>
        <p if="{state.articles == 0}" translate>There are no resource articles yet. Check back soon!</p>
    </div>

    <script>
        import TagList from "RiotTags/Components/TagList.riot.html";
        import Card from "RiotTags/Components/Card.riot.html";
        import SearchBar from "RiotTags/Components/SearchBar.riot.html";

        import { getSearchQueryFromUrl, parseURLHash } from 'js/Routing';
        import { getResources } from "js/WagtailPagesAPI";
        import {
            getTagsFromPages,
            doPageTagsMatchSelections,
            doesQueryMatchSearchContent,
        } from "js/SearchAndFiltering";

        export default {
            state: {
                selectedTags: [],
                query: "",
                articles: [],
                listOfAllTags: [],
                articleContent: {},
            },

            components: {
                taglist: TagList,
                card: Card,
                searchbar: SearchBar,
            },

            async onMounted() {
                const articles = await getResources();
                const listOfAllTags = getTagsFromPages(articles);
                this.update({ articles, listOfAllTags, selectedTags: [] });

                const queryStringFromURI = getSearchQueryFromUrl();
                const urlParams = new URLSearchParams(queryStringFromURI);
                const query = urlParams.get("qs");
                if (!!query) {
                    this.update({ query: decodeURIComponent(query) });
                }

                const filter = urlParams.getAll("filter");
                if (filter.length > 0) {
                    for (var i=0; i < filter.length; ++i) {
                        if (listOfAllTags.includes(filter[i])) {
                            this.onTagClick(decodeURIComponent(filter[i]), true);
                        }
                    }
                }
            },

            onTagClick(clickedTag, isFromUrlQuery) {
                const queryStringFromURI = getSearchQueryFromUrl();
                const urlParams = new URLSearchParams(queryStringFromURI);
                
                if (this.state.selectedTags.includes(clickedTag)) {
                    const tagIndex = this.state.selectedTags.indexOf(clickedTag);
                    this.state.selectedTags.splice(tagIndex, 1);
                    this.update();
                    
                    if (this.state.selectedTags.length > 0) {
                        for (var i=0; i < this.state.selectedTags.length; ++i ) {
                            const encodedTag = this.state.selectedTags[i].toLowerCase();
                            urlParams.set("filter", encodedTag);
                        }
                        this.replaceUrlQuery(urlParams);
                    } else {
                        urlParams.delete("filter");
                        this.replaceUrlQuery(urlParams);
                    }

                } else {
                    this.state.selectedTags.push(clickedTag);
                    urlParams.append("filter", encodeURIComponent(clickedTag));
                    !isFromUrlQuery && this.replaceUrlQuery(urlParams);
                    this.update();
                }
                this.update();
            },

            submitQuery(query) {
                const queryStringFromURI = getSearchQueryFromUrl();
                const urlParams = new URLSearchParams(queryStringFromURI);
                const encodedQuery = encodeURIComponent(query);
                
                urlParams.set("qs", encodedQuery);
                this.replaceUrlQuery(urlParams);
                this.update({ query });
            },

            isResourceArticleVisible(article) {
                const { query } = this.state;
                const isQueryMatch = query.length < 3 ? 'true' : doesQueryMatchSearchContent(
                    query,
                    article.title,
                    article.description
                );

                const { selectedTags } = this.state;
                const lowercaseArticleTags = article.tags.map(tag => tag.toLowerCase());
                const isTagMatch = doPageTagsMatchSelections(lowercaseArticleTags, selectedTags);

                const showArticle = isQueryMatch && isTagMatch;
                return showArticle;
            },

            replaceUrlQuery(urlParams) {
                window.history.replaceState({}, '', `${location.pathname}#resources?${urlParams}`);
            }
        };
    </script>
</Resources>
