<Resources>
    <div class="content-wrapper" if="{state.hash == null}">
        <div class="resources-bar">
            <span class="resources-icon title"></span>
            <h3>{ TRANSLATIONS.resources() }</h3>
        </div>
        <SearchBar
            if="{state.articles.length > 0}"
            searchString="{state.searchString}"
            submitSearch="{submitSearch}"
        ></SearchBar>
        <TagList
            if="{state.listOfAllTags.length > 0}"
            tags="{state.listOfAllTags}"
            onTagClick="{onTagClick}"
            selectedTags="{state.selectedTags}"
        ></TagList>
        <div each="{article in state.articles}">
            <Card
                if="{isResourceArticleVisible(article)}"
                title="{article.title}"
                description="{article.description}"
                link="{article.id}"
                showFooter="{false}"
            ></Card>
        </div>
        <LoadingDots if="{state.isLoading}" extrastyleclasses="dark"></LoadingDots>
        <p if="{!state.isLoading && state.articles == 0}">
            { TRANSLATIONS.noArticlesYet() }
        </p>
    </div>

    <script>
        import TagList from "RiotTags/Components/TagList.riot.html";
        import Card from "RiotTags/Components/Card.riot.html";
        import SearchBar from "RiotTags/Components/SearchBar.riot.html";
        import LoadingDots from "RiotTags/Components/LoadingDots.riot.html";

        import { getSearchQueryFromUrl, parseURLHash } from "js/Routing";
        import { getResources } from "js/WagtailPagesAPI";
        import {
            getTagsFromPages,
            doPageTagsMatchSelections,
            doesQueryMatchSearchContent,
        } from "js/SearchAndFiltering";
        import { isGuestUser } from "js/AuthenticationUtilities";

        export default {
            state: {
                selectedTags: [],
                searchString: "",
                articles: [],
                listOfAllTags: [],
                isLoading: false,
            },

            components: {
                taglist: TagList,
                card: Card,
                searchbar: SearchBar,
                loadingdots: LoadingDots,
            },

            TRANSLATIONS: {
                resources: () => gettext("Resources"),
                noArticlesYet: () =>
                    gettext("There are no resource articles yet. Check back soon!"),
            },

            async onMounted() {
                this.toggleLoadingMessage();
                const articles = await getResources();
                const listOfAllTags = getTagsFromPages(articles);
                this.update({ articles, listOfAllTags, selectedTags: [] });

                const urlParams = this.generateUrlParams();

                const query = urlParams.get("qs");
                if (!!query) {
                    this.update({ searchString: decodeURIComponent(query) });
                }

                const filter = urlParams.getAll("filter");
                if (filter.length > 0) {
                    for (var i = 0; i < filter.length; ++i) {
                        if (listOfAllTags.includes(filter[i])) {
                            this.onTagClick(decodeURIComponent(filter[i]), true);
                        }
                    }
                }
                this.toggleLoadingMessage();
            },

            toggleLoadingMessage() {
                this.update({ isLoading: !this.state.isLoading });
            },

            generateUrlParams() {
                const queryStringFromUrl = getSearchQueryFromUrl();
                return new URLSearchParams(queryStringFromUrl);
            },

            onTagClick(clickedTag, isFromUrl) {
                const urlParams = this.generateUrlParams();

                if (this.state.selectedTags.includes(clickedTag)) {
                    const tagIndex = this.state.selectedTags.indexOf(clickedTag);
                    this.state.selectedTags.splice(tagIndex, 1);
                    urlParams.delete("filter");

                    if (this.state.selectedTags.length > 0) {
                        for (var i = 0; i < this.state.selectedTags.length; ++i) {
                            const pendingTag = this.state.selectedTags[i].toLowerCase();
                            urlParams.append("filter", pendingTag);
                        }
                    }
                    this.replaceUrlQuery(urlParams);
                } else {
                    this.state.selectedTags.push(clickedTag);
                    urlParams.append("filter", clickedTag);
                    !isFromUrl && this.replaceUrlQuery(urlParams);
                    this.update();
                }
                this.update();
            },

            submitSearch(searchString) {
                const urlParams = this.generateUrlParams();

                urlParams.set("qs", searchString);
                this.replaceUrlQuery(urlParams);
                this.update({ searchString });
            },

            isResourceArticleVisible(article) {
                const { is_visible_to_guests } = article;
                const { searchString } = this.state;

                const doesUserHavePermission = isGuestUser() ? is_visible_to_guests : true;
                const isQueryMatch = doesQueryMatchSearchContent(
                    searchString,
                    article.title,
                    article.description
                );

                const { selectedTags } = this.state;
                const lowercaseArticleTags = article.tags.map((tag) => tag.toLowerCase());
                const isTagMatch = doPageTagsMatchSelections(lowercaseArticleTags, selectedTags);

                const showArticle = doesUserHavePermission && isQueryMatch && isTagMatch;
                return showArticle;
            },

            replaceUrlQuery(urlParams) {
                window.history.replaceState({}, "", `${location.pathname}#resources?${urlParams}`);
            },
        };
    </script>
</Resources>
