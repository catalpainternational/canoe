<Resources>
    <div class="content-wrapper" if="{state.hash == null}">
        <div class="resources-bar">
            <span class="resources-icon title"></span>
            <h3 translate>Resources</h3>
        </div>
        <SearchBar
            if="{state.articles.length > 0}"
            query="{state.query}"
            submitQuery="{submitQuery}"
        ></SearchBar>
        <TagList tags="{state.allTags}" onTagClick="{onTagClick}"></TagList>
        <div each="{article in state.articles}">
            <Card
                if="{isResourceArticleVisible(article)}"
                title="{article.title}"
                description="{article.description}"
                link="{article.id}"
                showFooter="{false}"
            ></Card>
        </div>
        <p if="{state.articles == 0}" translate>
            There are no resource articles yet. Check back soon!
        </p>
    </div>

    <script>
        import TagList from "RiotTags/Components/TagList.riot.html";
        import Card from "RiotTags/Components/Card.riot.html";
        import SearchBar from "RiotTags/Components/SearchBar.riot.html";

        import { getSearchQueryFromUrl, parseURLHash } from "js/Routing";
        import { getResources } from "js/WagtailPagesAPI";
        import {
            getTagsFromPages,
            doPageTagsMatchSelections,
            doesQueryMatchSearchContent,
        } from "js/SearchAndFiltering";

        export default {
            state: {
                selectedTags: [],
                articles: [],
                query: "",
                allTags: [],
                articleContent: {},
            },

            components: {
                taglist: TagList,
                card: Card,
                searchbar: SearchBar,
            },

            async onMounted() {
                const articles = await getResources();
                const allTags = getTagsFromPages(articles);
                this.update({ articles, allTags });
            },

            onTagClick(clickedTag) {
                let { selectedTags } = this.state;

                if (selectedTags.includes(clickedTag)) {
                    selectedTags = selectedTags.filter((tag) => tag !== clickedTag);
                } else {
                    selectedTags.push(clickedTag);
                }
                this.update({ selectedTags });
            },

            submitQuery(query) {
                this.update({ query });
            },

            isResourceArticleVisible(article) {
                console.log(`Checking if "${article.title}" is visible.`);
                const { query } = this.state;
                const { selectedTags } = this.state;
                const lowercaseArticleTags = article.tags.map((tag) => tag.toLowerCase());

                const isQueryMatch =
                    query.length < 3
                        ? true
                        : doesQueryMatchSearchContent(
                              query,
                              article.title,
                              article.description,
                              ...lowercaseArticleTags
                          );
                const isTagMatch = doPageTagsMatchSelections(lowercaseArticleTags, selectedTags);

                const showArticle = isQueryMatch && isTagMatch;
                return showArticle;
            },
        };
    </script>
</Resources>
