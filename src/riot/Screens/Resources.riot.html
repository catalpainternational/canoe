<Resources>
    <div class="content-wrapper" if="{state.hash == null}">
        <div class="resources-bar">
            <span class="resources-icon title"></span>
            <h3 translate>Resources</h3>
        </div>
        <SearchBar if="{state.articles.length > 0}" submitQuery="{submitQuery}"></SearchBar>
        <TagList tags="{state.allTags}" filterArticles="{filterArticles}"></TagList>
        <div each="{article in state.articles}">
            <Card
                if="{isResourceArticleVisible(article)}"
                title="{article.title}"
                description="{article.description}"
                link="{article.id}"
                showFooter="{false}"
            ></Card>
        </div>
        <p if="{state.articles == 0}" translate>
            There are no resource articles yet. Check back soon!
        </p>
    </div>

    <script>
        import TagList from "RiotTags/Components/TagList.riot.html";
        import Card from "RiotTags/Components/Card.riot.html";
        import SearchBar from "RiotTags/Components/SearchBar.riot.html";

        import { getResources } from "js/WagtailPagesAPI";
        import {
            getTagsFromPages,
            doPageTagsMatchSelections,
            doesQueryMatchSearchContent,
            checkUrlForSearchBarQuery,
        } from "js/SearchAndFiltering";

        export default {
            state: {
                selectedTags: new Set(),
                articles: [],
                query: "",
                allTags: [],
                articleContent: {},
            },

            components: {
                taglist: TagList,
                card: Card,
                searchbar: SearchBar,
            },

            async onMounted() {
                const articles = await getResources();
                const allTags = getTagsFromPages(articles);
                // Resources must pull the search query from the URL. Resources
                // cannot initialize itself with the SearchBar's query because
                // it'll mount two SearchBars. I think this double-mounting is a
                // RiotJS bug.
                const query = checkUrlForSearchBarQuery();
                this.update({ articles, allTags, query });
            },

            filterArticles(clickedFilter) {
                let { selectedTags } = this.state;

                if (selectedTags.has(clickedFilter)) {
                    selectedTags.delete(clickedFilter);
                } else {
                    selectedTags.add(clickedFilter);
                }
                this.update({ selectedTags });
            },

            submitQuery(query) {
                this.update({ query });
            },

            isResourceArticleVisible(article) {
                const { query } = this.state;
                const { selectedTags } = this.state;
                const lowercaseArticleTags = article.tags.map((tag) => tag.toLowerCase());

                const isQueryMatch =
                    query.length < 3
                        ? true
                        : doesQueryMatchSearchContent(
                              query,
                              article.title,
                              article.description,
                              ...lowercaseArticleTags
                          );
                const isTagMatch = doPageTagsMatchSelections(lowercaseArticleTags, selectedTags);

                const showArticle = isQueryMatch && isTagMatch;
                return showArticle;
            },
        };
    </script>
</Resources>
