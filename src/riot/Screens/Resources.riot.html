<Resources>
    <div class="content-wrapper">
        <div class="resources-bar">
            <span class="resources-icon title"></span>
            <h3 translate>Resources</h3>
        </div>
        <SearchBar
            typing="{state.typing}"
            onSearchInput="{onSearchInput}"
            shortQuery="{!state.query}"
        ></SearchBar>
        <TagList
            tags="{props.listOfTags}"
            onTagClick="{onTagClick}"
            selectedTags="{state.selectedTags}"
        ></TagList>
        <div each="{article in props.dummyArticles}">
            <Card
                if="{isResourceArticleVisible(article)}"
                title="{article.title}"
                description="{article.description}"
                link="resource?"
                showFooter="{false}"
            >
            </Card>
        </div>
    </div>

    <script>
        import TagList from "RiotTags/Components/TagList.riot.html";
        import Card from "RiotTags/Components/Card.riot.html";
        import SearchBar from "RiotTags/Components/SearchBar.riot.html";

        export default {
            state: {
                selectedTags: [],
                query: '',
                typing: false,
            },
        
            components: {
                taglist: TagList,
                card: Card,
                searchbar: SearchBar,
            },
            
            onTagClick(clickedTag) {
                if (this.state.selectedTags.includes(clickedTag)) {
                    const tagIndex = this.state.selectedTags.indexOf(clickedTag);
                    this.state.selectedTags.splice(tagIndex, 1);
                } else {
                    this.state.selectedTags.push(clickedTag);
                }
                this.update();
            },

            onSearchInput() {
                const queryElement = this.$("#search");
                if (queryElement.value.length > 0) {
                    this.update({ typing: true });
                } else {
                    this.update({ typing: false });
                }

                if (queryElement.value.length > 2) {
                    this.update({ query: queryElement.value });
                } else {
                    this.update({ query: '' });
                }
            },

            isResourceArticleVisible(article) {
                const query = this.state.query;
                const lowercaseArticle = article.title.toLowerCase().concat(article.description.toLowerCase());
                const lowercaseQuery = query.toLowerCase();
                const isQueryMatch = !query || lowercaseArticle.includes(lowercaseQuery);

                const tagsList = this.state.selectedTags;
                const hasTagMatch = () => {
                    for (let i = 0; i < tagsList.length; i++ ) {
                        if (article.tags.includes(tagsList[i])) {
                            return true;
                        } 
                    }
                    return false;
                }
                const isTagMatch = (tagsList.length === 0) || hasTagMatch();

                const showArticle = isQueryMatch && isTagMatch;

                return showArticle;
            },
        }
    
    </script>
</Resources>
