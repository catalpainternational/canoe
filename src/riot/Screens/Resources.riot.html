<Resources>
    <div class="content-wrapper">
        <div class="resources-bar">
            <span if="{!state.searchOpen}" class="resources-icon title"></span>
            <h3 if="{!state.searchOpen}" translate>Resources</h3>
            <input if="{state.searchOpen}" id="search" type="text" oninput="{onSearchInput}" />
            <span if="{state.searchOpen}" class="search-icon active"></span>
            <a class="{!state.searchOpen ? 'search-icon' : 'cross gray'}" onclick="{toggleSearch}"></a>
        </div>
        <p class="search-text" if="{state.searchOpen && !state.query}" translate>Enter at least 3 characters</p>
        <TagList
            tags="{props.listOfTags}"
            onTagClick="{onTagClick}"
            selectedTags="{state.selectedTags}"
        ></TagList>
        <div each="{article in props.dummyArticles}">
            <Card
                if="{isResourceArticleVisible(article)}"
                title="{article.title}"
                description="{article.description}"
                link="resource?"
                showFooter="{false}"
            >
            </Card>
        </div>
    </div>

    <script>
        import TagList from "RiotTags/Components/TagList.riot.html";
        import Card from "RiotTags/Components/Card.riot.html";

        export default {
            state: {
                searchOpen: false,
                selectedTags: [],
                query: '',
            },
        
            components: {
                taglist: TagList,
                card: Card,
            },
            
            onTagClick(clickedTag) {
                if (this.state.selectedTags.includes(clickedTag)) {
                    const tagIndex = this.state.selectedTags.indexOf(clickedTag);
                    this.state.selectedTags.splice(tagIndex, 1);
                } else {
                    this.state.selectedTags.push(clickedTag);
                }
                this.update();
            },

            onSearchInput() {
                const queryElement = this.$("#search");
                if (queryElement.value.length > 2) {
                    this.update({ query: queryElement.value });
                } else {
                    this.update({ query: '' });
                }
            },

            isResourceArticleVisible(article) {
                const query = this.state.query;
                const lowercaseArticle = article.title.toLowerCase().concat(article.description.toLowerCase());
                const lowercaseQuery = query.toLowerCase();
                const isQueryMatch = !query || lowercaseArticle.includes(lowercaseQuery);

                const tagsList = this.state.selectedTags;
                const hasTagMatch = () => {
                    for (let i = 0; i < tagsList.length; i++ ) {
                        if (article.tags.includes(tagsList[i])) {
                            return true;
                        } 
                    }
                    return false;
                }
                const isTagMatch = (tagsList.length === 0) || hasTagMatch();

                const showArticle = isQueryMatch && isTagMatch;

                return showArticle;
            },

            toggleSearch() {
                this.update({ searchOpen: !this.state.searchOpen });
                if (this.state.searchOpen) {
                    const query = this.$("#search");
                    query.focus();
                } else {
                    this.update({ query: '' });
                }
            }
        }
    
    </script>
</Resources>
