<Resources>
    <div class="content-wrapper" if="{state.hash == null}">
        <div class="resources-bar">
            <span class="resources-icon title"></span>
            <h3 translate>Resources</h3>
        </div>
        <SearchBar submitQuery="{submitQuery}"></SearchBar>
        <TagList
            tags="{state.listOfTags}"
            onTagClick="{onTagClick}"
            selectedTags="{state.selectedTags}"
        ></TagList>
        <div each="{article in state.articles}">
            <Card
                if="{isResourceArticleVisible(article)}"
                title="{article.title}"
                description="{article.description}"
                link="{article.id}"
                showFooter="{false}"
            ></Card>
        </div>
    </div>

    <script>
        import TagList from "RiotTags/Components/TagList.riot.html";
        import Card from "RiotTags/Components/Card.riot.html";
        import SearchBar from "RiotTags/Components/SearchBar.riot.html";

        import { getResources } from "js/WagtailPagesAPI";
        import {
            getTagsFromPages,
            doPageTagsMatchSelections,
            doesQueryMatchSearchContent,
        } from "js/SearchAndFiltering";

        export default {
            state: {
                selectedTags: [],
                query: "",
                articles: [],
                listOfTags: [],
                articleContent: {},
            },

            components: {
                taglist: TagList,
                card: Card,
                searchbar: SearchBar,
            },

            async onMounted() {
                const articles = await getResources();
                const listOfTags = getTagsFromPages(articles);
                this.update({ articles, listOfTags });
            },

            onTagClick(clickedTag) {
                if (this.state.selectedTags.includes(clickedTag)) {
                    const tagIndex = this.state.selectedTags.indexOf(clickedTag);
                    this.state.selectedTags.splice(tagIndex, 1);
                } else {
                    this.state.selectedTags.push(clickedTag);
                }
                this.update();
            },

            submitQuery(query) {
                this.update({ query });
            },

            isResourceArticleVisible(article) {
                this.state.articleContent = article;

                const { query } = this.state;
                const isQueryMatch = doesQueryMatchSearchContent(
                    query,
                    article.title,
                    article.description
                );

                const { selectedTags } = this.state;
                const isTagMatch = doPageTagsMatchSelections(article.tags, selectedTags);

                const showArticle = isQueryMatch && isTagMatch;
                return showArticle;
            },
        };
    </script>
</Resources>
