<Resources>
    <template if="{state.showDownloadModal}">
        <div class="modal-background fade"
            onclick="{toggleDownloadModal}">
        </div>
        <div class="cross gray modal-close-btn"
            onclick="{toggleDownloadModal}">
        </div>
    </template>

    <TopMenu extrastyleclasses="without-swoop">
        <h5>{ TRANSLATIONS.resources() }</h5>
        <a if="{page.resources.length}"
            class="top-icon right has-circle {state.cached ? 'course-download-complete' : ''}"
            onclick="{toggleDownloadModal}">
            <span class="download"></span>
        </a>
    </TopMenu>
    <div if="{state.hash == null}" class="content-wrapper">
        <SearchBar
            if="{page.resources.length > 0}"
            searchString="{state.searchString}"
            submitSearch="{submitSearch}"
        ></SearchBar>
        <TagList
            if="{ page.all_tags.size }"
            tags="{ page.all_tags }"
            onTagClick="{ onTagClick }"
            selectedTags="{ state.selectedTags }"
        ></TagList>
        <div class="list-resources">
            <a
                each="{resource in page.resources}"
                if="{isResourceVisible(resource)}"
                class="resource-card"
                href="#{resource.loc_hash}"
            >
                <template if="{ resource.ready }">
                    <span each="{card in resource.cards}">
                        <p>{card.tag}</p>
                        <span if="{resource.cards.length > 1}">,</span>
                    </span>
                </template>
                <h5>{resource.title}</h5>
                <h6 if="{ resource.ready }">{resource.description}</h6>
            </a>
        </div>
        <p if="{ page.resources.length === 0}" class="no-resources">
            { TRANSLATIONS.noArticlesYet() }
        </p>
    </div>

    <PopupModal if="{state.showDownloadModal}" togalModal="{toggleDownloadModal}">
        <span class="download-course"></span>
        <h3>{ TRANSLATIONS.download_resources() }</h3>
        <!-- <button class="btn-primary" onclick="{downloadAllResources}">{ TRANSLATIONS.download_all() }</button> -->
        <LessonDownload
            each="{(resource, index) in page.resources}"
            contentItem="{resource}"
            itemIndex="{index}"
        ></LessonDownload>
    </PopupModal>

    <script>
        import TagList from "RiotTags/Components/TagList.riot.html";
        import SearchBar from "RiotTags/Components/SearchBar.riot.html";
        import TopMenu from "RiotTags/Components/TopMenu.riot.html";
        import PopupModal from "RiotTags/Components/PopupModal.riot.html";
        import LessonDownload from "RiotTags/Components/LessonDownload.riot.html";

        import { getRoute } from "ReduxImpl/Interface";

        import {
            doPageTagsMatchSelections,
            doesQueryMatchSearchContent,
        } from "js/SearchAndFiltering";

        export default {
            state: {
                selectedTags: [],
                searchString: "",
                isLoading: false,
                showDonloadModal: false,
                cached: false,
            },

            components: {
                taglist: TagList,
                searchbar: SearchBar,
                topmenu: TopMenu,
                popupmodal: PopupModal,
                lessondownload: LessonDownload,
            },

            TRANSLATIONS: {
                resources: () => gettext("Resources"),
                noArticlesYet: () => gettext("There are no resources yet. Check back soon!"),
                download_resources: () => gettext("Make resources available offline"),
                download_all: () => gettext("Download all resources"),
            },

            onBeforeMount() {
                this.page = getRoute().page;
                this.state.isLoading = !this.page.ready;
            },
            onBeforeUpdate() {
                this.state.isLoading = !this.page.ready;
            },

            onTagClick(clickedTag, isFromUrl) {
                if (this.state.selectedTags.includes(clickedTag)) {
                    const tagIndex = this.state.selectedTags.indexOf(
                        clickedTag
                    );
                    this.state.selectedTags.splice(tagIndex, 1);
                } else {
                    this.state.selectedTags.push(clickedTag);
                }
                this.update();
            },

            submitSearch(searchString) {
                this.update({ searchString });
            },

            toggleDownloadModal() {
                this.update({showDownloadModal: !this.state.showDownloadModal});
                document.body.classList.toggle('modal-open');
            },

            downloadAllResources() {
                document.querySelectorAll('.download-state .download').forEach((it) => it.click());
            },

            isResourceVisible(resource) {
                const { searchString, selectedTags } = this.state;

                const isQueryMatch = doesQueryMatchSearchContent(
                    searchString,
                    resource.title,
                    resource.description ? resource.description : ''
                );

                const lowercaseTags = resource.tags.map((tag) =>
                    tag.toLowerCase()
                );
                const isTagMatch = doPageTagsMatchSelections(
                    lowercaseTags,
                    selectedTags
                );

                const show = isQueryMatch && isTagMatch;
                return show;
            },
        };
    </script>
</Resources>
