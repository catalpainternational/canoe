<Settings>
    <div class="settings">
        <div class="content-wrapper">
            <h3>Your settings</h3>
            <div if="{state.browserSupportsNotifications}" class="notifications-toggle">
                <div
                    class="switch {state.isSubscribedToNotifications ? 'on' : 'off'} {state.disableNotificationsButton ? 'disabled' : ''}"
                    onclick="{state.isSubscribedToNotifications ? unsubscribe : subscribe}"
                >
                    <input type="checkbox" />
                    <div class="slider"></div>
                </div>
                <p>Would you like to receive app notifications?</p>
            </div>

            <button
                if="{!state.appIsInstalled}"
                class="btn-secondary"
                onclick="{promptUserToInstallApp}"
            >
                Add to Home Screen
            </button>

            <button class="btn-secondary" onclick="{logout}">Log out</button>

            <!-- <CacheDisplay></CacheDisplay> -->
        </div>
    </div>
    <script>
        import { logout } from "js/AuthenticationUtilities";
        import {
            supportsPushManager,
            subscribe,
            unsubscribe,
            isSubscribedToNotifications
        } from "js/Notifications";
        import { dispatchInstallAppEvent } from "js/Events";
        import {
            alertIfRequestWasMadeOffline,
            alertIfBrowserBlocksNotifications
        } from "js/ErrorChecks";

        export default {
            state: {
                browserSupportsNotifications: false,
                isSubscribedToNotifications: true,
                disableNotificationsButton: false,
                appIsInstalled: false
            },

            logout() {
                logout();
            },

            async refreshSettings() {
                // These updates must remain separate. Riot doesn't update state
                // values independently.
                //
                //   this.update({
                //       appIsInstalled: this.isAppInstalledToHomeScreen(),
                //       isSubscribedToNotifications: await isSubscribedToNotifications()
                //   })
                //
                // When in the same update as isSubscribedToNotifications,
                // appIsInstalled resolves only after
                // isSubscribedToNotifications's "await" resolves. On slow
                // connections, when the "Add To Home Screen" button should
                // hide, the button remains visible. With these cases in mind,
                // we update appIsInstalled separately so that the button hides
                // immediately.

                this.update({
                    appIsInstalled: this.isAppInstalledToHomeScreen()
                });

                const browserSupportsNotifications = await supportsPushManager();

                if (!browserSupportsNotifications) {
                    return;
                }

                this.update({
                    browserSupportsNotifications,
                    isSubscribedToNotifications: await isSubscribedToNotifications()
                });
            },

            async disableNotificationsButtonAnd(subscribeOrUnsubscribe) {
                try {
                    this.update({ disableNotificationsButton: true });
                    await subscribeOrUnsubscribe();
                } catch (error) {
                    if (alertIfRequestWasMadeOffline(error)) {
                    } else if (alertIfBrowserBlocksNotifications(error)) {
                    } else {
                        throw error;
                    }
                } finally {
                    this.update({ disableNotificationsButton: false });
                }
            },

            async subscribe() {
                await this.disableNotificationsButtonAnd(subscribe);
                this.refreshSettings();
            },

            async unsubscribe() {
                const wantsToUnsubscribe = confirm(
                    `Olgeta uses notifications to send you useful course updates and reminders. If you turn off notifications, you will not receive this course information. Are you sure you want to turn off notifications?`
                );

                if (wantsToUnsubscribe) {
                    await this.disableNotificationsButtonAnd(unsubscribe);
                    this.refreshSettings();
                }
            },

            promptUserToInstallApp() {
                dispatchInstallAppEvent();
                this.refreshSettings();
            },

            isAppInstalledToHomeScreen() {
                return window.matchMedia("(display-mode: standalone)").matches;
            },

            onMounted() {
                this.refreshSettings();
            }
        };
    </script>
</Settings>
