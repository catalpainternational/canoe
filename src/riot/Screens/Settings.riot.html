<Settings>
    <div class="settings">
        <div class="content-wrapper">
            <h3 translate>Your settings</h3>

            <div if="{state.browserSupportsNotifications}" class="notifications-toggle">
                <div
                    class="switch {state.isSubscribedToNotifications ? 'on' : 'off'} {state.disableNotificationsButton ? 'disabled' : ''}"
                    onclick="{state.isSubscribedToNotifications ? unsubscribe : subscribe}"
                >
                    <input type="checkbox" />
                    <div class="slider"></div>
                </div>
                <p translate>Would you like to receive app notifications?</p>
            </div>

            <LanguageSelector></LanguageSelector>

            <button
                if="{state.canAddToHomeScreen}"
                class="btn-secondary"
                onclick="{promptUserToInstallApp}"
                translate
                translation-comment="This button adds an icon to the device homescreen"
            >
                Add to Home Screen
            </button>

            <button class="btn-secondary" onclick="{logout}" translate>Log out</button>

            <div is="logos" class="logo" />

            <!-- <CacheDisplay></CacheDisplay> -->
        </div>
    </div>
    <script>
        import LanguageSelector from "riot/Components/LanguageSelector.riot.html";
        import Logos from "riot/Components/Logos.riot.html";
        import { logout } from "js/AuthenticationUtilities";
        import {
            supportsPushManager,
            subscribeToNotifications,
            unsubscribeFromNotifications,
            isSubscribedToNotifications,
        } from "js/Notifications";
        import { dispatchInstallAppEvent } from "js/Events";
        // import CacheDisplay from "RiotTags/CacheDisplay.riot.html";
        import {
            alertIfRequestWasMadeOffline,
            alertIfBrowserBlocksNotifications,
        } from "js/ErrorChecks";
        import { getPlatform } from "js/PlatformDetection";

        export default {
            state: {
                browserSupportsNotifications: false,
                isSubscribedToNotifications: false,
                disableNotificationsButton: false,
                canAddToHomeScreen: false,
            },
            components: {
                languageselector: LanguageSelector,
                logos: Logos,
            },

            logout() {
                logout();
            },

            async refreshSettings() {
                this.update({
                    canAddToHomeScreen: this.shouldShowAddToHomeScreen(),
                });

                const browserSupportsNotifications = await supportsPushManager();

                if (!browserSupportsNotifications) {
                    return;
                }

                this.update({
                    browserSupportsNotifications,
                    isSubscribedToNotifications: await isSubscribedToNotifications(),
                });
            },

            async disableNotificationsButtonAnd(subscribeOrUnsubscribe) {
                try {
                    this.update({ disableNotificationsButton: true });
                    await subscribeOrUnsubscribe();
                } catch (error) {
                    if (alertIfRequestWasMadeOffline(error)) {
                    } else if (alertIfBrowserBlocksNotifications(error)) {
                    } else {
                        throw error;
                    }
                } finally {
                    this.update({ disableNotificationsButton: false });
                }
            },

            async subscribe() {
                await this.disableNotificationsButtonAnd(subscribeToNotifications);
                this.refreshSettings();
            },

            async unsubscribe() {
                // warns the user that this site ( name goes in %1 ) will not be able to send you notifications if you turn this off
                const message = gettext(
                    `%1 uses notifications to send you useful course updates and reminders. If you turn off notifications, you will not receive this course information. Are you sure you want to turn off notifications?`,
                    `${process.env.SITE_NAME}`
                );
                const wantsToUnsubscribe = confirm(message);

                if (wantsToUnsubscribe) {
                    await this.disableNotificationsButtonAnd(unsubscribeFromNotifications);
                    this.refreshSettings();
                }
            },

            promptUserToInstallApp() {
                dispatchInstallAppEvent();
                this.refreshSettings();
            },

            shouldShowAddToHomeScreen() {
                const { browser, inAppelflap, inPWAMode } = getPlatform();
                return !(browser.name === "Safari" || inPWAMode || inAppelflap);
            },

            onMounted() {
                this.refreshSettings();
            },
        };
    </script>
</Settings>
