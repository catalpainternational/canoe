<Profile>
    <TopMenu extrastyleclasses="with-swoop">
        <h4>{ TRANSLATIONS.yourProfile() }</h4>
    </TopMenu>

    <div class="content-wrapper">
        <h5 class="section-title">{ TRANSLATIONS.courseProgress() }</h5>
        <LoadingDots if="{state.loading}" extrastyleclasses="dark"></LoadingDots>
        <div class="card-container">
            <Card
                each="{course in state.courses}"
                title="{course.title}"
                link="{course.id}"
                status="{courseStatus(course)}"
                progressValue="{course.numberOfFinishedLessons}"
                progressMax="{course.numberOfLessons}"
            ></Card>
        </div>

        <h5 class="section-title">{ TRANSLATIONS.learning() }</h5>
        <div class="stats">
            <div class="card stat">
                <div class="profile-card">
                    <span class="checkmark-circle-blue"></span>
                    <h3>{ countFinishedLessonsAndExams() }</h3>
                    <h5>{ TRANSLATIONS.lessonsCompleted() }</h5>
                </div>
            </div>

            <div class="card stat">
                <div class="profile-card">
                    <span class="road-sign"></span>
                    <h3>{ getNumberOfLessonsLeft() }</h3>
                    <h5>{ TRANSLATIONS.lessonsLeft() }</h5>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        import Card from "RiotTags/Components/Card.riot.html";
        import LoadingDots from "RiotTags/Components/LoadingDots.riot.html";
        import TopMenu from "RiotTags/Components/TopMenu.riot.html";

        import { getHomePage } from "js/WagtailPagesAPI";
        import { getCapitalizedUsername, isGuestUser } from "js/AuthenticationUtilities";
        import { getCourseWithLatestCompletion } from "js/utilities";

        import AllCoursesPage from "js/AllCoursesPage";

        export default {
            state: {
                courses: [],
                currentCourse: null,
                loading: false,
            },

            components: {
                card: Card,
                loadingdots: LoadingDots,
                topmenu: TopMenu
            },

            TRANSLATIONS: {
                yourProfile: () => gettext("Your profile"),
                courseProgress: () => gettext("Course Progress"),
                learning: () => gettext("Learning statistics"),
                lessonsCompleted: () => gettext("lessons completed"),
                lessonsLeft: () => gettext("lessons remaining"),
            },

            async onMounted() {
                this.update({ loading: true });
                const allCoursesPageJSON = await getHomePage();
                const allCoursesPage = new AllCoursesPage(allCoursesPageJSON);

                let courses = await allCoursesPage.getFullCourseObjects();

                if (isGuestUser()) {
                    courses = courses.filter(course => course.isVisibleToGuests());
                }
                const lastWorkedOnCourse = getCourseWithLatestCompletion(courses);

                this.update({
                    loading: false,
                    courses,
                    currentCourse: lastWorkedOnCourse,
                });
            },

            countFinishedLessonsAndExams() {
                const { courses } = this.state;
                const tallyFinishedLessonsAndExams = (totalFinished, aCourse) =>
                    totalFinished + aCourse.numberOfFinishedLessons;
                return courses.reduce(tallyFinishedLessonsAndExams, 0);
            },

            countLessonsAndExams(courses) {
                const tallyLessonsAndExams = (totalLessons, currentCourse) =>
                    totalLessons + currentCourse.numberOfLessons;
                return courses.reduce(tallyLessonsAndExams, 0);
            },

            getNumberOfLessonsLeft() {
                const { courses } = this.state;
                return this.countLessonsAndExams(courses) - this.countFinishedLessonsAndExams();
            },

            courseStatus(course) {
                if (course.numberOfFinishedLessons === 0) {
                    return "not-started";
                } else if (course.numberOfFinishedLessons < course.numberOfLessons) {
                    return "in-progress";
                } else {
                    return "complete";
                }
            },
        };
    </script>
</Profile>
