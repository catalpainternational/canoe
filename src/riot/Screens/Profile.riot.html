<Profile>
    <TopMenu extrastyleclasses="without-swoop">
        <h4>{ TRANSLATIONS.yourProfile() }</h4>
        <a class="top-icon right extra-clickable-space" href="#settings">
            <span class="settings-icon"> </span>
        </a>
    </TopMenu>
    <div class="content-wrapper">
        <h2 class="sub-title">{ TRANSLATIONS.courseProgress() }</h2>
        <div class="tab-titles">
            <a
                class="{state.selectedInProgress ? 'selected' : ''}"
                onclick="{() => selectTab('in-progress')}"
            >
                <h5 class="section-title">{ TRANSLATIONS.inProgress() }</h5>
            </a>
            <a
                class="{!state.selectedInProgress ? 'selected' : ''}"
                onclick="{() => selectTab('completed')}"
            >
                <h5 class="section-title">{ TRANSLATIONS.completed() }</h5>
            </a>
        </div>
        <LoadingDots if="{state.loading}" extrastyleclasses="dark"></LoadingDots>
        <div if="{state.selectedInProgress}" class="card-container">
            <Card
                each="{course in state.inProgressCourses}"
                title="{course.title}"
                link="{course.id}"
                status="{courseStatus(course)}"
                progressValue="{course.numberOfFinishedLessons}"
                progressMax="{course.numberOfLessons}"
            ></Card>
        </div>
        <div if="{!state.selectedInProgress}" class="card-container">
            <Card
                each="{course in state.completedCourses}"
                title="{course.title}"
                link="{course.id}"
                status="{courseStatus(course)}"
                progressValue="{course.numberOfFinishedLessons}"
                progressMax="{course.numberOfLessons}"
            ></Card>
        </div>
        <h2 class="sub-title">{ TRANSLATIONS.learning() }</h2>
        <div class="stats">
            <div class="card stat">
                <div class="profile-card">
                    <span class="checkmark-circle"></span>
                    <h3>{ countFinishedLessonsAndExams() }</h3>
                    <h5>{ TRANSLATIONS.lessonsCompleted() }</h5>
                </div>
            </div>
            <div class="card stat">
                <div class="profile-card">
                    <span class="road-sign"></span>
                    <h3>{ getNumberOfLessonsLeft() }</h3>
                    <h5>{ TRANSLATIONS.lessonsLeft() }</h5>
                </div>
            </div>
        </div>
    </div>
    <script>
        import Card from "RiotTags/Components/Card.riot.html";
        import LoadingDots from "RiotTags/Components/LoadingDots.riot.html";
        import TopMenu from "RiotTags/Components/TopMenu.riot.html";

        import { getHomePage } from "js/WagtailPagesAPI";
        import { getCapitalizedUsername, isGuestUser } from "js/AuthenticationUtilities";
        import { getCourseWithLatestCompletion } from "js/utilities";

        import AllCoursesList from "js/AllCoursesList";

        export default {
            state: {
                courses: [],
                currentCourse: null,
                loading: false,
                inProgressCourses: [],
                completedCourses: [],
                selectedInProgress: true,
            },

            components: {
                card: Card,
                loadingdots: LoadingDots,
                topmenu: TopMenu,
            },

            TRANSLATIONS: {
                yourProfile: () => gettext("Your profile"),
                courseProgress: () => gettext("Course progress"),
                learning: () => gettext("Learning statistics"),
                lessonsCompleted: () => gettext("lessons completed"),
                lessonsLeft: () => gettext("lessons remaining"),
                inProgress: () => gettext("in progress"),
                completed: () => gettext("completed"),
            },

            async onMounted() {
                this.update({ loading: true });
                const allCoursesListJSON = await getHomePage();
                const allCoursesList = new AllCoursesList(allCoursesListJSON);

                let courses = await allCoursesList.getFullCourseObjects();

                if (isGuestUser()) {
                    courses = courses.filter((course) => course.isVisibleToGuests());
                }
                const lastWorkedOnCourse = getCourseWithLatestCompletion(courses);

                let inProgressCourses = [];
                let completedCourses = [];
                for (const course of courses) {
                    const status = this.courseStatus(course);
                    if (status === "not-started") {
                        continue;
                    } else if (status === "in-progress") {
                        inProgressCourses.push(course);
                    } else if (status === "complete") {
                        completedCourses.push(course);
                    }
                }

                this.update({
                    loading: false,
                    courses,
                    inProgressCourses,
                    completedCourses,
                    currentCourse: lastWorkedOnCourse,
                });
            },

            countFinishedLessonsAndExams() {
                const { courses } = this.state;
                const tallyFinishedLessonsAndExams = (totalFinished, aCourse) =>
                    totalFinished + aCourse.numberOfFinishedLessons;
                return courses.reduce(tallyFinishedLessonsAndExams, 0);
            },

            countLessonsAndExams(courses) {
                const tallyLessonsAndExams = (totalLessons, currentCourse) =>
                    totalLessons + currentCourse.numberOfLessons;
                return courses.reduce(tallyLessonsAndExams, 0);
            },

            getNumberOfLessonsLeft() {
                const { courses } = this.state;
                return this.countLessonsAndExams(courses) - this.countFinishedLessonsAndExams();
            },

            courseStatus(course) {
                if (course.numberOfFinishedLessons === 0) {
                    return "not-started";
                } else if (course.numberOfFinishedLessons < course.numberOfLessons) {
                    return "in-progress";
                } else {
                    return "complete";
                }
            },

            selectTab(tabName) {
                if (tabName === "in-progress") {
                    this.update({ selectedInProgress: true });
                } else {
                    this.update({ selectedInProgress: false });
                }
            },
        };
    </script>
</Profile>
