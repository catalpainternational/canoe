<Profile>
    <div class="profile">
        <div class="profile-header">
            <div class="header-box">
                <div class="left-block">
                    <h3>{ TRANSLATIONS.overall() }</h3>
                    <h6>{ percentLessonsCompleteMessage() }</h6>
                    <ContinueLearningButton
                        if="{state.currentCourse && !state.currentCourse.isFinished()}"
                        currentCourse="{state.currentCourse}"
                    ></ContinueLearningButton>
                </div>
                <span class="report-card"></span>
            </div>
        </div>

        <div class="content-wrapper">
            <h5 class="section-title">{ TRANSLATIONS.byCourse() }</h5>
            <ul class="course-progress-list">
                <li each="{course in state.courses}">
                    <a class="progress card" href="#{course.id}">
                        <div class="profile-card">
                            <h5>{course.title}</h5>
                            <span class="arrow background-purple"></span>
                        </div>
                        <div class="card-footer">
                            <span class="checkmark"></span>
                            <p>{ courseLessonsCompletedMessage(course) }</p>
                            <progress
                                if="{course.numberOfFinishedLessons > 0}"
                                value="{course.numberOfFinishedLessons}"
                                max="{course.numberOfLessons}"
                            ></progress>
                        </div>
                    </a>
                </li>
            </ul>

            <h5 class="section-title">{ TRANSLATIONS.learning() }</h5>
            <div class="stats">
                <div class="card card-sm no-shadow stat" href="#4">
                    <div class="profile-card">
                        <span class="checkmark-circle-blue"></span>
                        <h3>{countFinishedLessonsAndExams()}</h3>
                        <h5>{ TRANSLATIONS.lessonsCompleted() }</h5>
                    </div>
                </div>

                <div class="card card-sm no-shadow stat" href="#4">
                    <div class="profile-card">
                        <span class="road-sign"></span>
                        <h3>{getNumberOfLessonsLeft()}</h3>
                        <h5>{ TRANSLATIONS.lessonsLeft() }</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        import ContinueLearningButton from "RiotTags/Components/ContinueLearningButton.riot.html";

        import { getHomePage } from "@/WagtailPagesAPI";
        import { getCapitalizedUsername, isGuestUser } from "@/AuthenticationUtilities";
        import { getCourseWithLatestCompletion } from "@/utilities";

        import HomePage from "@/HomePage";

        export default {
            state: {
                courses: [],
                currentCourse: null,
            },

            components: {
                continuelearningbutton: ContinueLearningButton,
            },

            TRANSLATIONS: {
                overall: () => gettext("Overall progress"),
                byCourse: () => gettext("Progress by course"),
                learning: () => gettext("Learning statistics"),
                lessonsCompleted: () => gettext("lessons completed so far"),
                lessonsLeft: () => gettext("lessons remaining to finish your study"),
            },

            onMounted() {
                this.renderProfilePage();
            },

            async renderProfilePage() {
                const homePageJSON = await getHomePage();
                const homePage = new HomePage(homePageJSON);

                let courses = await homePage.getFullCourseObjects();

                if (isGuestUser()) {
                    courses = courses.filter((course) => course.isVisibleToGuests());
                }
                const lastWorkedOnCourse = getCourseWithLatestCompletion(courses);

                this.update({
                    courses,
                    currentCourse: lastWorkedOnCourse,
                });
            },

            countFinishedLessonsAndExams() {
                const { courses } = this.state;
                const tallyFinishedLessonsAndExams = (totalFinished, aCourse) =>
                    totalFinished + aCourse.numberOfFinishedLessons;
                return courses.reduce(tallyFinishedLessonsAndExams, 0);
            },

            countLessonsAndExams(courses) {
                const tallyLessonsAndExams = (totalLessons, currentCourse) =>
                    totalLessons + currentCourse.numberOfLessons;
                return courses.reduce(tallyLessonsAndExams, 0);
            },

            getNumberOfLessonsLeft() {
                const { courses } = this.state;
                return this.countLessonsAndExams(courses) - this.countFinishedLessonsAndExams();
            },

            getPercentOfLessonsCompleted() {
                const percentage =
                    (this.countFinishedLessonsAndExams() /
                        this.countLessonsAndExams(this.state.courses)) *
                    100;
                return Math.round(percentage) || 0;
            },

            courseLessonsCompletedMessage(course) {
                // displays how many lessons of the total in a course have been completed
                return gettext(
                    "%1 out of %2 completed",
                    course.numberOfFinishedLessons,
                    course.numberOfLessons
                );
            },

            percentLessonsCompleteMessage() {
                // displays percentage of completed lessons in all courses combined
                return gettext(
                    "Great work %1! You have completed %2\% of your overall coursework",
                    getCapitalizedUsername(),
                    this.getPercentOfLessonsCompleted()
                );
            },
        };
    </script>
</Profile>
