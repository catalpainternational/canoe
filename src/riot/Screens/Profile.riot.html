<Profile>
    <div class="profile">
        <div class="profile-header">
            <div class="left-block">
                <h3>Overall progress</h3>
                <h6>Great work {getUsername()}! You have completed {getPercentOfLessonsCompleted()}% 
                    of your overall coursework
                </h6>
                <ContinueLearningButton if="{state.currentCourse && isCurrentCourseInProgress(state.currentCourse)}"></ContinueLearningButton>
            </div>
            <span class="report-card"></span>
        </div>
        <div class="content-wrapper">
            <div class="section-title">
                <div>
                    <h5>Progress by course</h5>
                    <span>
                        <hr>
                    </span>
                </div>
            </div>
            <ul class="course-progress-list">
                <li each="{course in state.courses}">
                    <a class="progress card" href="#{course.data.id}">
                        <div class="profile-card">
                            <h5>{course.data.title}</h5>
                            <span class="arrow background-purple"></span>
                        </div>
                        <div class="card-footer">
                            <span class="checkmark"></span>
                            <p>
                                {getNumberOfCompletedLessonsFor(course)} out of
                                {course.lessons.length} completed
                            </p>
                            <progress
                                if="{getNumberOfCompletedLessonsFor(course) > 0}"
                                value="{getNumberOfCompletedLessonsFor(course)}"
                                max="{course.lessons.length}"
                            ></progress>
                        </div>
                    </a>
                </li>
            </ul>

            <div class="section-title">
                <div>
                    <h5>Learning statistics</h5>
                    <span>
                        <hr>
                    </span>
                </div>
            </div>
            <div class="stats">
                <div class="card card-sm no-shadow stat" href="#4">
                    <div class="profile-card">
                        <span class="checkmark-circle-blue"></span>
                        <h5>{getNumberOfCompletedLessons()} lessons completed so far</h5>
                    </div>
                </div>

                <div class="card card-sm no-shadow stat" href="#4">
                    <div class="profile-card">
                        <span class="road-sign"></span>
                        <h5>
                            {getNumberOfLessonsLeft()} lessons remaining to finish your study
                        </h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        import ContinueLearningButton from "RiotTags/Components/ContinueLearningButton.riot.html";

        import {
            countComplete,
            getMostRecentCompletion,
            isTheCourseComplete
        } from "Actions/completion";
        import { getOrFetchManifest, getOrFetchWagtailPage } from "js/WagtailPagesAPI";
        import { getUsername } from "js/AuthenticationUtilities";
        import {
            getAllLessons,
            getNumberOfCompletedLessons,
            getNumberOfCompletedLessonsFor,
            getHomePageId
        } from "js/utilities";

        export default {
            state: {
                manifest: null,
                courses: [],
                currentCourse: null
            },

            components: {
                continuelearningbutton: ContinueLearningButton
            },

            isCurrentCourseInProgress(aCourse) {
                return !isTheCourseComplete(aCourse.data.slug, aCourse.lessons);
            },

            getCurrentCourse(courses) {
                const lastCompletion = getMostRecentCompletion();
                if (lastCompletion === null) {
                    return null;
                }
                const lastWorkedOnCourse = courses.find(
                    course => course.data.slug === lastCompletion.courseSlug
                );
                return lastWorkedOnCourse;
            },

            getNumberOfCompletedLessons() {
                return getNumberOfCompletedLessons(this.state.courses);
            },

            getNumberOfCompletedLessonsFor(course) {
                return getNumberOfCompletedLessonsFor(course);
            },

            getNumberOfLessonsLeft() {
                return (
                    getAllLessons(this.state.courses).length - this.getNumberOfCompletedLessons()
                );
            },

            getPercentOfLessonsCompleted() {
                const percentage =
                    (getNumberOfCompletedLessons(this.state.courses) /
                        getAllLessons(this.state.courses).length) *
                    100;
                return Math.round(percentage) || 0;
            },

            getUsername() {
                return getUsername();
            },

            async renderProfilePage() {
                const manifest = await getOrFetchManifest();
                const homePage = await getOrFetchWagtailPage(manifest.home);
                const courses = homePage.courses;
                const lastWorkedOnCourse = this.getCurrentCourse(courses);

                this.update({
                    courses,
                    currentCourse: lastWorkedOnCourse
                });
            },

            onMounted() {
                this.renderProfilePage();
            }
        };
    </script>
</Profile>
