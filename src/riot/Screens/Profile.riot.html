<Profile>
    <TopMenu>
        <h4>Your profile</h4>
        <a class="search-icon top-icon right" href="#settings"></a>
    </TopMenu>
    <div class="profile">
        <div class="profile-header">
            <div class="header-box">
                <div class="left-block">
                    <h3>{ TRANSLATIONS.overall() }</h3>
                    <h6>{ percentLessonsCompleteMessage() }</h6>
                    <ContinueLearningButton
                        if="{state.currentCourse && !state.currentCourse.isFinished()}"
                        currentCourse="{state.currentCourse}"
                    ></ContinueLearningButton>
                </div>
                <span class="report-card"></span>
            </div>
        </div>

        <div class="content-wrapper">
            <h5 class="section-title">{ TRANSLATIONS.byCourse() }</h5>
            <ul class="course-progress-list">
                <div class="card-container">
                    <Card
                        each="{course in state.courses}"
                        title="{course.title}"
                        link="{course.id}"
                        status="{courseStatus(course)}"
                        progressValue="{course.numberOfFinishedLessons}"
                        progressMax="{course.numberOfLessons}"
                    ></Card>
                </div>
            </ul>

            <h5 class="section-title">{ TRANSLATIONS.learning() }</h5>
            <div class="stats">
                <div class="card card-sm no-shadow stat" href="#4">
                    <div class="profile-card">
                        <span class="checkmark-circle-blue"></span>
                        <h3>{countFinishedLessonsAndExams()}</h3>
                        <h5>{ TRANSLATIONS.lessonsCompleted() }</h5>
                    </div>
                </div>

                <div class="card card-sm no-shadow stat" href="#4">
                    <div class="profile-card">
                        <span class="road-sign"></span>
                        <h3>{getNumberOfLessonsLeft()}</h3>
                        <h5>{ TRANSLATIONS.lessonsLeft() }</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        import ContinueLearningButton from "RiotTags/Components/ContinueLearningButton.riot.html";
        import Card from "RiotTags/Components/Card.riot.html";
        import TopMenu from "RiotTags/Components/TopMenu.riot.html";

        import { getHomePage } from "js/WagtailPagesAPI";
        import { getCapitalizedUsername, isGuestUser } from "js/AuthenticationUtilities";
        import { getCourseWithLatestCompletion } from "js/utilities";

        import AllCoursesPage from "js/AllCoursesPage";

        export default {
            state: {
                courses: [],
                currentCourse: null,
            },

            components: {
                continuelearningbutton: ContinueLearningButton,
                card: Card,
                topmenu: TopMenu
            },

            TRANSLATIONS: {
                overall: () => gettext("Overall progress"),
                byCourse: () => gettext("Progress by course"),
                learning: () => gettext("Learning statistics"),
                lessonsCompleted: () => gettext("lessons completed so far"),
                lessonsLeft: () => gettext("lessons remaining to finish your study"),
            },

            onMounted() {
                this.renderProfilePage();
            },

            async renderProfilePage() {
                const allCoursesPageJSON = await getHomePage();
                const allCoursesPage = new AllCoursesPage(allCoursesPageJSON);

                let courses = await allCoursesPage.getFullCourseObjects();

                if (isGuestUser()) {
                    courses = courses.filter((course) => course.isVisibleToGuests());
                }
                const lastWorkedOnCourse = getCourseWithLatestCompletion(courses);

                this.update({
                    courses,
                    currentCourse: lastWorkedOnCourse,
                });
            },

            countFinishedLessonsAndExams() {
                const { courses } = this.state;
                const tallyFinishedLessonsAndExams = (totalFinished, aCourse) =>
                    totalFinished + aCourse.numberOfFinishedLessons;
                return courses.reduce(tallyFinishedLessonsAndExams, 0);
            },

            countLessonsAndExams(courses) {
                const tallyLessonsAndExams = (totalLessons, currentCourse) =>
                    totalLessons + currentCourse.numberOfLessons;
                return courses.reduce(tallyLessonsAndExams, 0);
            },

            getNumberOfLessonsLeft() {
                const { courses } = this.state;
                return this.countLessonsAndExams(courses) - this.countFinishedLessonsAndExams();
            },

            getPercentOfLessonsCompleted() {
                const percentage =
                    (this.countFinishedLessonsAndExams() /
                        this.countLessonsAndExams(this.state.courses)) *
                    100;
                return Math.round(percentage) || 0;
            },

            percentLessonsCompleteMessage() {
                // displays percentage of completed lessons in all courses combined
                return gettext(
                    "Great work %1! You have completed %2\% of your overall coursework",
                    getCapitalizedUsername(),
                    this.getPercentOfLessonsCompleted()
                );
            },

            courseStatus(course) {
                if (course.numberOfFinishedLessons === 0) {
                    return "not-started";
                } else if (course.numberOfFinishedLessons < course.numberOfLessons) {
                    return "in-progress";
                } else {
                    return "complete";
                }
            },
        };
    </script>
</Profile>
