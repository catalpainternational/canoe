<Profile>
    <div class="profile">
        <div class="profile-header">
            <div class="header-box">
                <div class="left-block">
                    <h3>{ TRANSLATIONS.overall() }</h3>
                    <h6>{ percentLessonsCompleteMessage() }</h6>
                    <ContinueLearningButton
                        if="{state.currentCourse && isCourseInProgress(state.currentCourse)}"
                    ></ContinueLearningButton>
                </div>
                <span class="report-card"></span>
            </div>
        </div>
        <div class="content-wrapper">
            <h5 class="section-title">{ TRANSLATIONS.byCourse() }</h5>
            <ul class="course-progress-list">
                <li each="{course in state.courses}">
                    <a class="progress card" href="#{course.data.id}">
                        <div class="profile-card">
                            <h5>{course.data.title}</h5>
                            <span class="arrow background-purple"></span>
                        </div>
                        <div class="card-footer">
                            <span class="checkmark"></span>
                            <p>
                                { courseLessonsCompletedMessage(course) }
                            </p>
                            <progress
                                if="{countCompleteLessonsIn(course) > 0}"
                                value="{countCompleteLessonsIn(course)}"
                                max="{course.lessons.length}"
                            ></progress>
                        </div>
                    </a>
                </li>
            </ul>

            <h5 class="section-title">{ TRANSLATIONS.learning() }</h5>
            <div class="stats">
                <div class="card card-sm no-shadow stat" href="#4">
                    <div class="profile-card">
                        <span class="checkmark-circle-blue"></span>
                        <h3>{countCompleteLessonsTotal()}</h3>
                        <h5>{ TRANSLATIONS.lessonsCompleted() }</h5>
                    </div>
                </div>

                <div class="card card-sm no-shadow stat" href="#4">
                    <div class="profile-card">
                        <span class="road-sign"></span>
                        <h3>{getNumberOfLessonsLeft()}</h3>
                        <h5>{ TRANSLATIONS.lessonsLeft() }</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        import ContinueLearningButton from "RiotTags/Components/ContinueLearningButton.riot.html";

        import { getHomePage } from "js/WagtailPagesAPI";
        import { getCapitalizedUsername, isGuestUser } from "js/AuthenticationUtilities";
        import { getAllLessons } from "js/utilities";
        import {
            countCompleteLessonsInCourse,
            countCompleteLessonsInCourses,
            getLatestCompletion,
            isCourseInProgress,
        } from "js/CompletionInterface";

        export default {
            state: {
                manifest: null,
                courses: [],
                currentCourse: null,
            },

            components: {
                continuelearningbutton: ContinueLearningButton,
            },

            TRANSLATIONS: {
                overall: () => gettext("Overall progress"),
                byCourse: () => gettext("Progress by course"),
                learning: () => gettext("Learning statistics"),
                lessonsCompleted: () => gettext("lessons completed so far"),
                lessonsLeft: () => gettext("lessons remaining to finish your study"),
            },

            isCourseInProgress(aCourse) {
                return isCourseInProgress(aCourse);
            },

            getCurrentCourse(courses) {
                const latestCompletion = getLatestCompletion(courses);
                if (latestCompletion === null) {
                    return null;
                }
                const lastWorkedOnCourse = courses.find(
                    (course) => course.data.slug === latestCompletion.courseSlug
                );
                return lastWorkedOnCourse;
            },

            countCompleteLessonsTotal() {
                return countCompleteLessonsInCourses(this.state.courses);
            },

            countCompleteLessonsIn(course) {
                return countCompleteLessonsInCourses([course]);
            },

            getNumberOfLessonsLeft() {
                return getAllLessons(this.state.courses).length - this.countCompleteLessonsTotal();
            },

            getPercentOfLessonsCompleted() {
                const percentage =
                    (this.countCompleteLessonsTotal() / getAllLessons(this.state.courses).length) *
                    100;
                return Math.round(percentage) || 0;
            },

            async renderProfilePage() {
                const homePage = await getHomePage();
                let courses = homePage.courses;

                if (isGuestUser()) {
                    courses = courses.filter((course) => course.is_visible_to_guests);
                }
                const lastWorkedOnCourse = this.getCurrentCourse(courses);

                this.update({
                    courses,
                    currentCourse: lastWorkedOnCourse,
                });
            },

            onMounted() {
                this.renderProfilePage();
            },

            courseLessonsCompletedMessage(course) {
                // displays how many lessons of the total in a course have been completed
                return gettext(
                    "%1 out of %2 completed",
                    this.countCompleteLessonsIn(course),
                    course.lessons.length
                );
            },

            percentLessonsCompleteMessage() {
                // displays percentage of completed lessons in all courses combined
                return gettext(
                    "Great work %1! You have completed %2\% of your overall coursework",
                    getCapitalizedUsername(),
                    this.getPercentOfLessonsCompleted()
                );
            },
        };
    </script>
</Profile>
