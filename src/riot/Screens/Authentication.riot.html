<Authentication>
    <div>
        <span class="site-logo"></span>
        <span class="login-image"></span>
        <form onsubmit="{loginUser}">
            <h3 translate>Login</h3>
            <div class="form-group">
                <label for="username" translate>Username</label>
                <input id="username" type="text" name="username" oninput="{clearError}" />
            </div>
            <div class="form-group">
                <label for="password" translate>Password</label>
                <input id="password" type="password" name="password" oninput="{clearError}" />
            </div>
            <div class="icon-box crossout">
                <a onclick="{showPassword}">
                    <span class="eye"></span>
                    <span class="password-placement">{state.isShowingPassword ? 'Hide' : 'Show'} Password</span>
                </a>
            </div>
            <div if="{state.errorExplanation}">
                <span class="warning"></span>
                <p class="error-message">{state.errorExplanation}</p>
            </div>
            <button class="btn-primary" type="submit" disabled="{state.isLoginButtonDisabled}" translate>Login</button>
        </form>
        <div class="logo">
            <span class="logo-a"></span>
            <span class="logo-b"></span>
            <span class="logo-c"></span>
        </div>
    </div>

    <script>
        import { alertIfRequestWasMadeOffline } from "js/Errors";
        import { login } from "js/AuthenticationUtilities";

        export default {
            state: {
                errorExplanation: null,
                isLoginButtonDisabled: false,
                isShowingPassword: false
            },

            getUsernameAndPasswordFromForm() {
                const usernameInput = this.$("#username");
                const passwordInput = this.$("#password");

                const usernameAndPassword = {
                    username: usernameInput.value,
                    password: passwordInput.value
                };
                return usernameAndPassword;
            },

            showPassword() {
                const passwordElement = this.$("#password");
                const eyeIcon = this.$(".icon-box");

                if (passwordElement.type === "password") {
                    passwordElement.type = "text";
                    eyeIcon.classList.remove("crossout");
                } else {
                    passwordElement.type = "password";
                    eyeIcon.classList.add("crossout");
                }
                this.update({
                    isShowingPassword: !this.state.isShowingPassword
                });
            },

            async loginUser(event) {
                event.preventDefault();

                const usernameAndPassword = this.getUsernameAndPasswordFromForm();
                try {
                    this.update({
                        isLoginButtonDisabled: true
                    });
                    await login(usernameAndPassword);
                } catch (error) {
                    if (alertIfRequestWasMadeOffline(error)) {
                    } else if (error.message === "400") {
                        this.update({
                            errorExplanation: "Invalid login credentials"
                        });
                    }
                } finally {
                    this.update({
                        isLoginButtonDisabled: false
                    });
                }
            },

            clearError() {
                if (this.state.errorExplanation) {
                    this.update({
                        errorExplanation: null
                    });
                }
            }
        };
    </script>
</Authentication>
