<TestMultipleAnswer class="answer">
    <div class="answers-block">
        <h4><span translate>Check </span><span class="bold" translate>all</span><span> answers that apply</span></h4>
        <ol>
            <li
                each="{answer in props.card.answers}"
                onclick="{() => selectAnswer(answer)}"
            >
                <div>
                    <span class="checkbox"></span>
                    <span if="{state.visibleAnswers.includes(answer) && answer.correct}" class="success"></span>
                    <span if="{state.visibleAnswers.includes(answer) && !answer.correct}" class="warning"></span>
                    <span if="{state.hiddenAnswers.includes(answer) && !state.visibleAnswers.includes(answer)}" class="pendingAnswer"></span>
                    <p>{answer.text}</p>
                </div>
            </li>
        </ol>
    </div>
    <h4 if="{state.visibleAnswers.length > 0}" translate>Find and check all correct answers and uncheck incorrect answers</h4>
    <button
        if="{!props.isCourseTest}"
        class="btn-primary"
        onclick="{showResults}"
        disabled="{state.hiddenAnswers.length === 0 && state.visibleAnswers.length === 0}"
        translate
    >Check answers</button>

    <script>
        import { dispatchTestAnswerEvent } from "js/Events";

        export default {
            state: {
                hiddenAnswers: [],
                visibleAnswers: [],
                numberTotalCorrectAnswers: ''
            },

            onMounted() {
                const numberTotalCorrectAnswers = this.props.card.answers.filter(a => a.correct).length;
                this.update({ 
                    numberTotalCorrectAnswers, 
                    hiddenAnswers: [] 
                });
            },

            showResults() {
                this.state.visibleAnswers = this.state.visibleAnswers.concat(this.state.hiddenAnswers);
                this.state.hiddenAnswers = [];
                this.update();

                const numberIncorrectAnswersChosen = this.state.visibleAnswers.filter(a => !a.correct).length;
                const numberCorrectAnswersChosen = this.state.visibleAnswers.filter(a => a.correct).length;
                const numberCorrectAnswersMissing = this.state.numberTotalCorrectAnswers - numberCorrectAnswersChosen;
                const isQuestionComplete = numberCorrectAnswersChosen === this.state.numberTotalCorrectAnswers && numberIncorrectAnswersChosen === 0;
                
                this.props.toggleModal(true, {}, isQuestionComplete);
                
                if (isQuestionComplete) {
                    this.update({ 
                        visibleAnswers: []
                    });
                };
            },

            selectAnswer(answer) {
                if (this.state.visibleAnswers.includes(answer)) {
                    const visibleAnswerIndex = this.state.visibleAnswers.indexOf(answer);
                    this.state.visibleAnswers.splice(visibleAnswerIndex, 1);
                } else if (this.state.hiddenAnswers.includes(answer)) {
                    const hiddenAnswerIndex = this.state.hiddenAnswers.indexOf(answer);
                    this.state.hiddenAnswers.splice(hiddenAnswerIndex, 1);
                } else {
                    this.state.hiddenAnswers.push(answer);
                }
                this.update();
                this.props.isCourseTest && this.props.recordAnswer(answer, this.props.card.question);
            },
        }
    </script>
</TestMultipleAnswer>
