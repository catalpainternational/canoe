<TestMultipleAnswer>
    <div class="answers-block">
        <h4><raw html="{ TRANSLATIONS.checkAllAnswers() }"></raw></h4>
        <ol>
            <li each="{(answer, index) in card.answers}" onclick="{() => selectAnswer(answer)}">
                <div class="checkbox-container {answerClass(answer)}">
                    <div class="checkbox">
                        <span>{ alphabet[index] }</span>
                    </div>
                    <p class="label">{ answer.text }</p>
                </div>
            </li>
        </ol>
    </div>
    <h4 if="{ getAnswer() }">{ TRANSLATIONS.checkCorrect() }</h4>
    <button
        if="{!props.isCourseExam}"
        class="btn-primary"
        onclick="{ showResults }"
        disabled="{ !getAnswer() }"
    >
        { TRANSLATIONS.checkAnswers() }
    </button>

    <script>
        import Raw from "RiotTags/Components/Raw.riot.html";

        import { getRoute, getExamAnswer, storeExamAnswer } from "ReduxImpl/Interface";

        const alphabet = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N',
            'O','P','Q','R','S','T','U','V','W','X','Y','Z'];

        export default {
            components: {
                raw: Raw,
            },
            state: {
            },

            TRANSLATIONS: {
                checkAllAnswers: () => gettext("Check <strong>all</strong> answers that apply"),
                checkCorrect: () =>
                    gettext("Find and check all correct answers and uncheck incorrect answers"),
                checkAnswers: () => gettext("Check answers"),
            },

            get alphabet() {
                return alphabet;
            },
            get route() {
                return getRoute();
            },
            get cardIndex() {
                return parseInt(this.route.riotHash[1]) - 1;
            },
            get page() {
                return this.route.page;
            },
            get card() {
                return this.page.examCards 
                    ? this.page.examCards[this.cardIndex]
                    : this.page.cards[this.cardIndex];
            },

            getAnswer() {
                return getExamAnswer(
                    this.page.id,
                    this.card.id
                );
            },
            setAnswer(answer) {
                storeExamAnswer(
                    this.page.id,
                    this.card.id,
                    answer,
                )
            },

            showResults() {
                if ( this.props.toggleModal ) {
                    this.props.toggleModal(true);
                }
            },

            answerClass(answer) {
                const selected = this.getAnswer();
                if (selected !== undefined 
                    && selected.answers.find(a=> a.text === answer.text)) {
                    // this answer has been selected
                    if (this.page.hasExam || !this.state.haveCheckedAnswers) {
                        // we are in an exam or we have not checked answers yet
                        return "answer-pending";
                    } else {
                        // show selection feedback
                        if (!answer.correct) {
                            return "answer-warning";
                        } else {
                            return "answer-success";
                        }
                    }
                } else {
                    return "";
                }
            },

            selectAnswer(answer) {
                const storedAnswerData = this.getAnswer();

                const nextAnswers = storedAnswerData || {
                    question: {
                        id: this.card.id,
                        text: this.card.question,
                    },
                    answers: [], 
                };
                const selectedAlready = nextAnswers.answers.findIndex(a => a.text === answer.text);
                if (selectedAlready !== -1) {
                    nextAnswers.answers.splice(selectedAlready, 1);
                } else {
                    nextAnswers.answers.push(answer);
                }
                nextAnswers.correct = (
                    nextAnswers.answers.every(a => a.correct)
                    && this.card.answers.filter(a => a.correct).length == nextAnswers.answers.length
                );
                this.state.haveCheckedAnswers = false;
                this.setAnswer(nextAnswers);
            },

            showResults() {
                this.update({
                    haveCheckedAnswers: true
                });
                if ( this.props.toggleModal ) {
                    this.props.toggleModal(true);
                }
                /*console.assert(Array.isArray(answers), `"answers" must come in as an Array`);

                const numberIncorrectAnswersChosen = answers.filter(a => !a.correct).length;
                const numberCorrectAnswersChosen = answers.filter(a => a.correct).length;

                const isQuestionComplete =
                    numberCorrectAnswersChosen === this.state.numberTotalCorrectAnswers &&
                    numberIncorrectAnswersChosen === 0;
                    */
                return false;
            },
        };
    </script>
</TestMultipleAnswer>
