<LessonContent>
    <LessonFrame
        if="{!props.isLessonPage || state.cardIdx < props.lessonContent.cards.length}"
        extraStyleClasses="content"
        linkTo="{props.lesson ? props.lesson.id : props.resourceId}"
        progressValue="{props.lesson ? state.cardIdx + 1 : ''}"
        progressMax="{props.lesson ? props.lessonContent.cards.length : ''}"
        noCardStyle="{props.resourceId === 'resources' ? true : false}"
        resourceTitle="{props.resourceId === 'resources' ? props.lessonContent.title : ''}"
    >
        <template if="{props.description}">
            <p class="resource-description">{ props.description }</p>
        </template>
        <template if="{props.resourceId === 'resources'}" each="{card in props.lessonContent.cards}">
            <Raw if="{card.tag === 'raw'}" html="{card.content}" class="content-block"></Raw>
            <BasicCard if="{card.tag === 'basic'}" card="{card}" class="content-block"></BasicCard>
            <AudioCard if="{card.media_type === 'audio'}" media="{card}" class="content-block"></AudioCard>
            <VideoCard if="{card.media_type === 'video'}" media="{card}" class="content-block"></VideoCard>
            <QuoteCard if="{card.tag === 'quote'}" card="{card}" class="content-block"></QuoteCard>
            <ListCard if="{card.tag === 'list'}" card="{card}" class="content-block"></ListCard>
            <PdfCard if="{card.tag === 'pdf'}" card="{card}" class="content-block"></PdfCard>
        </template>
        <template if="{props.resourceId !== 'resources'}">
            <Raw
                if="{props.lessonContent.cards[state.cardIdx].tag === 'raw'}"
                html="{props.lessonContent.cards[state.cardIdx].content}"
            />
            <BasicCard
                if="{props.lessonContent.cards[state.cardIdx].tag === 'basic'}"
                card="{props.lessonContent.cards[state.cardIdx]}"
            />
            <AudioCard
                if="{props.lessonContent.cards[state.cardIdx].media_type === 'audio'}"
                media="{props.lessonContent.cards[state.cardIdx]}"
            />
            <VideoCard
                if="{props.lessonContent.cards[state.cardIdx].media_type === 'video'}"
                media="{props.lessonContent.cards[state.cardIdx]}"
            />
            <QuoteCard
                if="{props.lessonContent.cards[state.cardIdx].tag === 'quote'}"
                card="{props.lessonContent.cards[state.cardIdx]}"
            />
            <ListCard
                if="{props.lessonContent.cards[state.cardIdx].tag === 'list'}"
                card="{props.lessonContent.cards[state.cardIdx]}"
            />
            <PdfCard
                if="{props.lessonContent.cards[state.cardIdx].tag === 'pdf'}"
                card="{props.lessonContent.cards[state.cardIdx]}"
            />
        </template>
    </LessonFrame>
    <div if="{props.isLessonPage && state.cardIdx !== props.lessonContent.cards.length}" class="bottom-buttons">
        <div>
            <a if="{state.cardIdx > 0}" class="has-circle" onclick="{goBack}">
                <span class="arrow"></span>
            </a>
        </div>
        <div>
            <button
                class="btn-primary"
                onclick="{nextContentPage}"
                if="{state.cardIdx < props.lessonContent.cards.length - 1}"
            >
                { TRANSLATIONS.next() }
            </button>
            <button
                class="btn-primary"
                onclick="{completeContentModal}"
                if="{state.cardIdx === props.lessonContent.cards.length - 1}"
            >
                { TRANSLATIONS.finish() }
            </button>
        </div>
    </div>
    <LessonModuleComplete
        if="{props.isLessonPage && state.cardIdx === props.lessonContent.cards.length}"
        lessonId="{props.lesson.id}"
        module="{props.module}"
        nextModule="{props.nextModule}"
        title="{props.title}"
    ></LessonModuleComplete>

    <script>
        import LessonModuleComplete from "RiotTags/Lesson/LessonModuleComplete.riot.html";
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";
        import Raw from "RiotTags/Components/Raw.riot.html";
        import BasicCard from "RiotTags/Components/BasicCard.riot.html";
        import VideoCard from "RiotTags/Lesson/VideoCard.riot.html";
        import AudioCard from "RiotTags/Lesson/AudioCard.riot.html";
        import QuoteCard from "RiotTags/Components/QuoteCard.riot.html";
        import ListCard from "RiotTags/Lesson/ListCard.riot.html";
        import PdfCard from "RiotTags/Lesson/PdfCard.riot.html";

        import { getLessonCardIdx, getNextCardsUrl, getPreviousCardsUrl } from "js/Routing";
        import { setComplete } from "Actions/completion";

        export default {
            state: {
                cardIdx: 0,
                iframes: [],
            },

            components: {
                lessonmodulecomplete: LessonModuleComplete,
                basiccard: BasicCard,
                quotecard: QuoteCard,
                listcard: ListCard,
                raw: Raw,
                lessonframe: LessonFrame,
                videocard: VideoCard,
                audiocard: AudioCard,
                pdfcard: PdfCard,
            },

            TRANSLATIONS: {
                next: () => gettext("Next"),
                finish: () => gettext("Finish"),
            },

            onBeforeMount(props, state) {
                state.cardIdx = props.isLessonPage ? getLessonCardIdx() : "0";
                window.addEventListener("hashchange", this.hashChanged);
            },

            onBeforeUnmount(props, state) {
                window.removeEventListener("hashchange", this.hashChanged);
            },

            hashChanged() {
                this.update({
                    cardIdx: getLessonCardIdx(),
                });
            },

            goBack() {
                location.hash = getPreviousCardsUrl(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            },

            nextContentPage() {
                window.scroll(0, 0);
                location.hash = getNextCardsUrl(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            },

            completeContentModal() {
                setComplete(this.props.course.slug, this.props.lesson.slug, this.props.module);
                location.hash = getNextCardsUrl(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            },

            checkForPlayableVideos() {
                this.state.iframes = this.$$("iframe");
            },

            onUpdated() {
                this.checkForPlayableVideos();
            },
        };
    </script>
</LessonContent>
