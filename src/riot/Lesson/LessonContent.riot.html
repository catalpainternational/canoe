<LessonContent>
    <LessonFrame
        if="{ props.lesson.ready && state.cardNumber <= state.cards.length }"
        extraStyleClasses="{state.card.tag.includes('Choice') ? 'test' : 'content'}"
        progressValue="{ state.cardNumber }"
        progressMax="{ state.cards.length }"
        linkTo="{ props.lesson.course.loc_hash }"
    >
        <TitleDescription
            if="{state.card.tag === 'titleDescription'}"
            card="{state.card}"
        />
        <Raw if="{state.card.tag === 'raw'}" html="{state.card.content}" />
        <BasicCard if="{state.card.tag === 'basic'}" card="{state.card}" />
        <AudioCard
            if="{state.card.media_type === 'audio'}"
            media="{state.card}"
        />
        <VideoCard
            if="{state.card.media_type === 'video'}"
            media="{state.card}"
        />
        <QuoteCard if="{state.card.tag === 'quote'}" card="{state.card}" />
        <ListCard if="{state.card.tag === 'list'}" card="{state.card}" />
        <PdfCard if="{state.card.tag === 'pdf'}" card="{state.card}" />
        <Html5Card if="{state.card.tag === 'html5'}" card="{state.card}" />
        <template
            if="{state.card.tag === 'singleChoice' || state.card.tag === 'multipleChoice'}">
            <h3>{state.card.question}</h3>
            <TestSingleAnswer
                if="{state.card.tag === 'singleChoice'}"
                card="{state.card}"
                lessonName="{props.lesson.title}"
                toggleModal="{toggleTestModal}"
                class="test"
            />
            <TestMultipleAnswer
                if="{state.card.tag === 'multipleChoice'}"
                card="{state.card}"
                lessonName="{props.lesson.title}"
                toggleModal="{toggleTestModal}"
                class="test"
            />
        </template>
    </LessonFrame>
    <div
        if="{props.lesson.ready && state.cardNumber <= state.cards.length}"
        class="bottom-buttons"
    >
        <div>
            <a
                if="{ state.cardNumber > 1 }"
                class="has-circle"
                onclick="{ goBack }"
            >
                <span class="arrow"></span>
            </a>
        </div>
        <div>
            <button
                class="btn-primary"
                onclick="{ nextCard }"
                if="{
                    state.cardNumber < state.cards.length
                    && !state.card.tag.includes('Choice')
                }"
            >
                { TRANSLATIONS.next() }
            </button>
            <button
                class="btn-primary"
                onclick="{ completeLesson }"
                if="{
                    state.cardNumber === state.cards.length
                    && !state.card.tag.includes('Choice')
                }"
            >
                { TRANSLATIONS.finish() }
            </button>
        </div>
    </div>
    <TestPopupModal
        if="{state.showModal}"
        isQuestionComplete="{state.isQuestionComplete}"
        selectedAnswer="{state.selectedAnswer}"
        isLastQuestion="{state.cardNumber === state.cards.length}"
        toggleModal="{toggleTestModal}"
        lesson="{props.lesson}"
        cardNumber="{state.cardNumber}"
    />
    <LessonFeedback
        if="{ !state.cardNumber && state.stage == 'feedback' }"
        lessonName="{props.lesson.title}"
    ></LessonFeedback>
    <LessonComplete
        if="{ !state.cardNumber && state.stage == 'complete' }"
    ></LessonComplete>

    <script>
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";
        import Raw from "RiotTags/Components/Raw.riot.html";
        import BasicCard from "RiotTags/Components/BasicCard.riot.html";
        import VideoCard from "RiotTags/Lesson/VideoCard.riot.html";
        import AudioCard from "RiotTags/Lesson/AudioCard.riot.html";
        import QuoteCard from "RiotTags/Components/QuoteCard.riot.html";
        import ListCard from "RiotTags/Lesson/ListCard.riot.html";
        import PdfCard from "RiotTags/Lesson/PdfCard.riot.html";
        import Html5Card from "RiotTags/Lesson/Html5Card.riot.html";
        import TitleDescription from "RiotTags/Components/TitleDescription.riot.html";
        import LessonComplete from "RiotTags/Lesson/LessonComplete.riot.html";
        import LessonFeedback from "RiotTags/Lesson/LessonFeedback.riot.html";
        import TestSingleAnswer from "RiotTags/Lesson/TestSingleAnswer.riot.html";
        import TestMultipleAnswer from "RiotTags/Lesson/TestMultipleAnswer.riot.html";
        import TestPopupModal from "RiotTags/Lesson/TestPopupModal.riot.html";

        import { getRoute } from "ReduxImpl/Interface";

        function LessonContent() {
            return {
                state: {
                    showModal: false,
                    selectedAnswer: {},
                    isQuestionComplete: false,
                    cards: [],
                    card: undefined,
                },

                TRANSLATIONS: {
                    next: () => gettext("Next"),
                    finish: () => gettext("Finish"),
                },

                readState() {
                    const route = getRoute();
                    const stage = route.riotHash[1];
                    const cardNumber = parseInt(stage);

                    this.state.stage = stage;
                    this.state.complete = stage === "complete";
                    this.state.cardNumber = cardNumber;

                    if (this.lesson.ready) {
                        this.state.cards = this.lesson.content.cards;
                        this.state.card = this.lesson.content.cards[cardNumber - 1];
                    }
                },

                onBeforeMount(props, state) {
                    this.lesson = getRoute().page;
                    this.readState();
                },

                onBeforeUpdate(props, state) {
                    this.readState();
                },

                goBack() {
                    const prevCard = this.state.cards[this.state.cardNumber - 2];
                    location.hash = `${this.props.lesson.loc_hash}:content:${this.state.cardNumber - 1}`;
                },

                nextCard() {
                    window.scroll(0, 0);

                    location.hash = `${this.props.lesson.loc_hash}:content:${this.state.cardNumber + 1}`;
                },

                completeLesson() {
                    this.props.lesson.completeSection('content');

                    location.hash = `${this.props.lesson.loc_hash}:test:feedback`;
                },

                checkForPlayableVideos() {
                    this.state.iframes = this.$$("iframe");
                },

                onUpdated() {
                    this.checkForPlayableVideos();
                },

                toggleTestModal(showModal, selectedAnswer, isQuestionComplete) {
                    this.update({
                        showModal,
                        selectedAnswer,
                        isQuestionComplete,
                    });
                    const testElement = this.$(".test");
                    if (showModal) {
                        testElement.classList.add("fade");
                    } else {
                        testElement.classList.remove("fade");
                    }
                },
            };
        }

        LessonContent.components = {
            basiccard: BasicCard,
            quotecard: QuoteCard,
            listcard: ListCard,
            raw: Raw,
            lessonframe: LessonFrame,
            videocard: VideoCard,
            audiocard: AudioCard,
            pdfcard: PdfCard,
            html5card: Html5Card,
            titledescription: TitleDescription,
            lessoncomplete: LessonComplete,
            lessonfeedback: LessonFeedback,
            testsingleanswer: TestSingleAnswer,
            testmultipleanswer: TestMultipleAnswer,
            testpopupmodal: TestPopupModal,
        };

        export default LessonContent;
    </script>
</LessonContent>
