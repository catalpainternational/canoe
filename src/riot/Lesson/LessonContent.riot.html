<LessonContent>
    <div
        class="content background-blue-1"
        if="{state.cardIdx < props.lessonContent.cards.length}"
    >
        <div class="content-wrapper">
            <Raw
                if="{props.lessonContent.cards[state.cardIdx].tag == 'raw'}"
                html="{props.lessonContent.cards[state.cardIdx].content}" />
            <Media
                if="{props.lessonContent.cards[state.cardIdx].tag == 'media'}"
                media="{props.lessonContent.cards[state.cardIdx]}" />

            <button
                class="btn-primary"
                onclick="{nextContentPage}"
                if="{state.cardIdx < props.lessonContent.cards.length - 1}"
            >
                Next {state.cardIdx + 1}/{props.lessonContent.cards.length}
            </button>
            <button
                class="btn-primary"
                onclick="{completeContentModal}"
                if="{state.cardIdx === props.lessonContent.cards.length - 1}"
            >
                Finish
            </button>
        </div>
    </div>
    <LessonModuleComplete
        if="{state.cardIdx === props.lessonContent.cards.length}"
        lessonId="{props.lesson.id}"
        module="{props.module}"
        nextModule="{props.nextModule}"
        title="{props.title}"
        background="{props.course.colour}"
    ></LessonModuleComplete>

    <script>
        import LessonModuleComplete from "RiotTags/Lesson/LessonModuleComplete.riot.html";
        import Raw from "RiotTags/Components/Raw.riot.html";
        import Media from "RiotTags/Media.riot.html";

        import { getLessonCardIdx, getLessonModuleHash } from "js/Routing";
        import { setComplete } from "Actions/completion";
        import { dispatchPlayVideoEvent } from "js/Events";

        export default {
            state: {
                cardIdx: 0,
                iframes: []
            },

            components: {
                lessonmodulecomplete: LessonModuleComplete,
                media: Media,
                raw: Raw
            },

            onBeforeMount(props, state) {
                state.cardIdx = getLessonCardIdx();
                window.addEventListener("hashchange", this.hashChanged);
            },

            onBeforeUnmount(props, state) {
                window.removeEventListener("hashchange", this.hashChanged);
            },

            hashChanged() {
                this.update({
                    cardIdx: getLessonCardIdx()
                });
            },

            nextContentPage() {
                window.scroll(0, 0);
                location.hash = getLessonModuleHash(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            },

            completeContentModal() {
                setComplete(this.props.course.slug, this.props.lesson.slug, this.props.module);
                location.hash = getLessonModuleHash(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            },

            checkForPlayableVideos() {
                this.state.iframes = this.$$("iframe");
            },

            notifyGoogleAnalyticsIfVideoIsPlaying() {
                for (const iframe of this.state.iframes) {
                    if (document.activeElement === iframe) {
                        const videoUrl = iframe.src;
                        dispatchPlayVideoEvent(videoUrl);
                    }
                }
            },

            onUpdated() {
                this.checkForPlayableVideos();
                window.onblur = this.notifyGoogleAnalyticsIfVideoIsPlaying;
            }
        };
    </script>
</LessonContent>
