<LessonContent>
    <LessonFrame
        if="{ props.lesson.ready && state.cardNumber <= state.cards.length }"
        extraStyleClasses="content"
        progressValue="{ state.cardNumber }"
        progressMax="{ state.cards.length }"
        lesson="{ props.lesson }"
        noCardStyle="{!props.module ? true : false}"
        resourceTitle="{!props.module ? props.lessonContent.title : ''}"
        linkTo="{ props.lesson.course.loc_hash }"
    >
        <template if="{props.description}">
            <p class="resource-description">{ props.description }</p>
        </template>
        <template if="{!props.module}" each="{card in state.cards}">
            <Raw if="{card.tag === 'raw'}" html="{card.content}" class="content-block"></Raw>
            <BasicCard if="{card.tag === 'basic'}" card="{card}" class="content-block"></BasicCard>
            <AudioCard
                if="{card.media_type === 'audio'}"
                media="{card}"
                class="content-block"
            ></AudioCard>
            <VideoCard
                if="{card.media_type === 'video'}"
                media="{card}"
                class="content-block"
            ></VideoCard>
            <QuoteCard if="{card.tag === 'quote'}" card="{card}" class="content-block"></QuoteCard>
            <ListCard if="{card.tag === 'list'}" card="{card}" class="content-block"></ListCard>
            <PdfCard if="{card.tag === 'pdf'}" card="{card}" class="content-block"></PdfCard>
        </template>
        <template if="{!!props.module}">
            <Raw
                if="{state.card.tag === 'raw'}"
                html="{state.card.content}"
            />
            <BasicCard
                if="{state.card.tag === 'basic'}"
                card="{state.card}"
            />
            <AudioCard
                if="{state.card.media_type === 'audio'}"
                media="{state.card}"
            />
            <VideoCard
                if="{state.card.media_type === 'video'}"
                media="{state.card}"
            />
            <QuoteCard
                if="{state.card.tag === 'quote'}"
                card="{state.card}"
            />
            <ListCard
                if="{state.card.tag === 'list'}"
                card="{state.card}"
            />
            <PdfCard
                if="{state.card.tag === 'pdf'}"
                card="{state.card}"
            />
            <Html5Card
                if="{state.card.tag === 'html5'}"
                card="{state.card}"
            />
        </template>
    </LessonFrame>
    <div if="{props.lesson && state.cardNumber <= state.cards.length}" class="bottom-buttons">
        <div>
            <a if="{ state.cardNumber > 1 }" class="has-circle" onclick="{ goBack }">
                <span class="arrow"></span>
            </a>
        </div>
        <div>
            <button
                class="btn-primary"
                onclick="{ nextCard }"
                if="{ state.cardNumber < state.cards.length }"
            >
                { TRANSLATIONS.next() }
            </button>
            <button
                class="btn-primary"
                onclick="{ completeLesson }"
                if="{ state.cardNumber === state.cards.length }"
            >
                { TRANSLATIONS.finish() }
            </button>
        </div>
    </div>
    <LessonFeedback
        if="{ !state.cardNumber && state.stage == 'feedback' }"
        lessonName="{props.lesson.title}"
    ></LessonFeedback>
    <LessonComplete
        if="{ !state.cardNumber && state.stage == 'complete' }"
    ></LessonComplete>

    <script>
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";
        import Raw from "RiotTags/Components/Raw.riot.html";
        import BasicCard from "RiotTags/Components/BasicCard.riot.html";
        import VideoCard from "RiotTags/Lesson/VideoCard.riot.html";
        import AudioCard from "RiotTags/Lesson/AudioCard.riot.html";
        import QuoteCard from "RiotTags/Components/QuoteCard.riot.html";
        import ListCard from "RiotTags/Lesson/ListCard.riot.html";
        import PdfCard from "RiotTags/Lesson/PdfCard.riot.html";
        import Html5Card from "RiotTags/Lesson/Html5Card.riot.html";

        import { getRoute } from "ReduxImpl/Interface";
        import { lessonSectionComplete } from "js/utilities";

        function readState(props) {
            const route = getRoute();
            const stage = route.riotHash[1];
            const cardNumber = parseInt(stage);
            const state = {
                cards: props.lesson.ready ? props.lesson.data.cards : [],
                card: props.lesson.ready ? props.lesson.data.cards[cardNumber - 1] : undefined,
                cardNumber: cardNumber,
                complete: stage === 'complete'
            };
            return state;
        }

        function LessonContent() { return {

            TRANSLATIONS: {
                next: () => gettext("Next"),
                finish: () => gettext("Finish"),
            },

            onBeforeMount(props, state) {
                this.state = readState(props);
            },

            onBeforeUpdate(props, state) {
                this.state = readState(props);
            },

            goBack() {
                const prevCard = this.state.cards[this.state.cardNumber - 2];
                location.hash = `${this.props.lesson.loc_hash}:${prevCard.type}:${this.state.cardNumber - 1}`;
            },

            nextCard() {
                window.scroll(0, 0);
                const nextCard = this.state.cards[this.state.cardNumber];
                lessonSectionComplete(
                    this.state.cards,
                    this.state.cards[this.state.cardNumber - 1],
                    this.props.lesson,
                    this.props.module
                );

                location.hash = `${this.props.lesson.loc_hash}:${nextCard.type}:${this.state.cardNumber + 1}`;
            },

            completeLesson() {
                location.hash = `${this.props.lesson.loc_hash}:test:feedback`;
            },

            checkForPlayableVideos() {
                this.state.iframes = this.$$("iframe");
            },

            onUpdated() {
                this.checkForPlayableVideos();
            },
        }}

        LessonContent.components = {
            basiccard: BasicCard,
            quotecard: QuoteCard,
            listcard: ListCard,
            raw: Raw,
            lessonframe: LessonFrame,
            videocard: VideoCard,
            audiocard: AudioCard,
            pdfcard: PdfCard,
            html5card: Html5Card,
        };

        export default LessonContent;

    </script>
</LessonContent>
