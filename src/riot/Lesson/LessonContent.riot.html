<LessonContent>
    <LessonFrame
        if="{ props.lesson.ready && state.cardNumber <= state.cards.length }"
        extraStyleClasses="content"
        progressValue="{ state.cardNumber }"
        progressMax="{ state.cards.length }"
    >
        <Raw if="{state.card.tag === 'raw'}" html="{state.card.content}" />
        <BasicCard if="{state.card.tag === 'basic'}" card="{state.card}" />
        <AudioCard
            if="{state.card.media_type === 'audio'}"
            media="{state.card}"
        />
        <VideoCard
            if="{state.card.media_type === 'video'}"
            media="{state.card}"
        />
        <QuoteCard if="{state.card.tag === 'quote'}" card="{state.card}" />
        <ListCard if="{state.card.tag === 'list'}" card="{state.card}" />
        <PdfCard if="{state.card.tag === 'pdf'}" card="{state.card}" />
        <Html5Card if="{state.card.tag === 'html5'}" card="{state.card}" />
    </LessonFrame>
    <div
        if="{props.lesson.ready && state.cardNumber <= state.cards.length}"
        class="bottom-buttons"
    >
        <div>
            <a
                if="{ state.cardNumber > 1 }"
                class="has-circle"
                onclick="{ goBack }"
            >
                <span class="arrow"></span>
            </a>
        </div>
        <div>
            <button
                class="btn-primary"
                onclick="{ nextContentCard }"
                if="{ state.cardNumber < state.cards.length }"
            >
                { TRANSLATIONS.next() }
            </button>
            <button
                class="btn-primary"
                onclick="{ completeContentModal }"
                if="{ state.cardNumber === state.cards.length }"
            >
                { TRANSLATIONS.finish() }
            </button>
        </div>
    </div>
    <LessonModuleComplete
        if="{ props.lesson.ready && state.complete }"
        lesson="{props.lesson}"
        module="{props.module}"
        nextModule="test"
    ></LessonModuleComplete>

    <script>
        import LessonModuleComplete from "RiotTags/Lesson/LessonModuleComplete.riot.html";
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";
        import Raw from "RiotTags/Components/Raw.riot.html";
        import BasicCard from "RiotTags/Components/BasicCard.riot.html";
        import VideoCard from "RiotTags/Lesson/VideoCard.riot.html";
        import AudioCard from "RiotTags/Lesson/AudioCard.riot.html";
        import QuoteCard from "RiotTags/Components/QuoteCard.riot.html";
        import ListCard from "RiotTags/Lesson/ListCard.riot.html";
        import PdfCard from "RiotTags/Lesson/PdfCard.riot.html";
        import Html5Card from "RiotTags/Lesson/Html5Card.riot.html";

        import { getRoute } from "ReduxImpl/Interface";

        function readState(props) {
            const route = getRoute();
            const stage = route.riotHash[1];
            const cardNumber = parseInt(stage);
            const state = {
                cards: props.lesson.ready ? props.lesson.content.cards : [],
                card: props.lesson.ready
                    ? props.lesson.content.cards[cardNumber - 1]
                    : undefined,
                cardNumber: cardNumber,
                complete: stage === "complete",
            };
            return state;
        }

        function LessonContent() {
            return {
                TRANSLATIONS: {
                    next: () => gettext("Next"),
                    finish: () => gettext("Finish"),
                },

                onBeforeMount(props, state) {
                    this.state = readState(props);
                },

                onBeforeUpdate(props, state) {
                    this.state = readState(props);
                },

                goBack() {
                    location.hash = `${this.props.lesson.loc_hash}:content:${
                        this.state.cardNumber - 1
                    }`;
                },

                nextContentCard() {
                    window.scroll(0, 0);
                    location.hash = `${this.props.lesson.loc_hash}:content:${
                        this.state.cardNumber + 1
                    }`;
                },

                completeContentModal() {
                    this.props.lesson.completeSection(this.props.module);
                    location.hash = `${this.props.lesson.loc_hash}:content:complete`;
                },

                checkForPlayableVideos() {
                    this.state.iframes = this.$$("iframe");
                },

                onUpdated() {
                    this.checkForPlayableVideos();
                },
            };
        }

        LessonContent.components = {
            lessonmodulecomplete: LessonModuleComplete,
            basiccard: BasicCard,
            quotecard: QuoteCard,
            listcard: ListCard,
            raw: Raw,
            lessonframe: LessonFrame,
            videocard: VideoCard,
            audiocard: AudioCard,
            pdfcard: PdfCard,
            html5card: Html5Card,
        };

        export default LessonContent;
    </script>
</LessonContent>
