<LessonContent>
    <LessonFrame
        if="{state.cardIdx < props.lessonContent.cards.length}"
        extraStyleClasses="content"
    >
        <Raw
            if="{props.lessonContent.cards[state.cardIdx].tag === 'raw'}"
            html="{props.lessonContent.cards[state.cardIdx].content}"
        />
        <BasicCard
            if="{props.lessonContent.cards[state.cardIdx].tag === 'basic'}"
            card="{props.lessonContent.cards[state.cardIdx]}"
        />
        <AudioCard
            if="{props.lessonContent.cards[state.cardIdx].media_type === 'audio'}"
            media="{props.lessonContent.cards[state.cardIdx]}"
        />
        <VideoCard
            if="{props.lessonContent.cards[state.cardIdx].media_type === 'video'}"
            media="{props.lessonContent.cards[state.cardIdx]}"
        />
        <QuoteCard
            if="{props.lessonContent.cards[state.cardIdx].tag === 'quote'}"
            card="{props.lessonContent.cards[state.cardIdx]}"
        />
        <div class="bottom-buttons">
            <div>
                <a if="{state.cardIdx > 0}" class="arrow-gray" onclick="{goBack}"></a>
            </div>
            <div>
                <button
                    class="btn-primary"
                    onclick="{nextContentPage}"
                    if="{state.cardIdx < props.lessonContent.cards.length - 1}"
                    translate
                >
                    Next
                </button>
                <button
                    class="btn-primary"
                    onclick="{completeContentModal}"
                    if="{state.cardIdx === props.lessonContent.cards.length - 1}"
                    translate
                >
                    Finish
                </button>
            </div>
        </div>
        <p class="card-number">{ cardNumberMessage() }</p>
    </LessonFrame>
    <LessonModuleComplete
        if="{state.cardIdx === props.lessonContent.cards.length}"
        lessonId="{props.lesson.id}"
        module="{props.module}"
        nextModule="{props.nextModule}"
        title="{props.title}"
    ></LessonModuleComplete>

    <script>
        import LessonModuleComplete from "RiotTags/Lesson/LessonModuleComplete.riot.html";
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";
        import Raw from "RiotTags/Components/Raw.riot.html";
        import BasicCard from "RiotTags/Components/BasicCard.riot.html";
        import VideoCard from "RiotTags/Lesson/VideoCard.riot.html";
        import AudioCard from "RiotTags/Lesson/AudioCard.riot.html";
        import QuoteCard from "RiotTags/Components/QuoteCard.riot.html";

        import { getLessonCardIdx, getLessonModuleHash } from "js/Routing";
        import { setComplete } from "Actions/completion";

        export default {
            state: {
                cardIdx: 0,
                iframes: [],
            },

            components: {
                lessonmodulecomplete: LessonModuleComplete,
                basiccard: BasicCard,
                quotecard: QuoteCard,
                raw: Raw,
                lessonframe: LessonFrame,
                videocard: VideoCard,
                audiocard: AudioCard,
            },

            onBeforeMount(props, state) {
                state.cardIdx = getLessonCardIdx();
                window.addEventListener("hashchange", this.hashChanged);
            },

            onBeforeUnmount(props, state) {
                window.removeEventListener("hashchange", this.hashChanged);
            },

            hashChanged() {
                this.update({
                    cardIdx: getLessonCardIdx(),
                });
            },

            goBack() {
                window.history.back();
            },

            cardNumberMessage() {
                // display the number of the current card out of the total number of cards
                return gettext(
                    "%1 of %2",
                    this.state.cardIdx + 1,
                    this.props.lessonContent.cards.length
                );
            },

            nextContentPage() {
                window.scroll(0, 0);
                location.hash = getLessonModuleHash(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            },

            completeContentModal() {
                setComplete(this.props.course.slug, this.props.lesson.slug, this.props.module);
                location.hash = getLessonModuleHash(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            },

            checkForPlayableVideos() {
                this.state.iframes = this.$$("iframe");
            },

            onUpdated() {
                this.checkForPlayableVideos();
            },
        };
    </script>
</LessonContent>
