<CourseExam>
    <template if="{ !state.results }">
        <LessonFrame if="{ stage === 'code' && course.examType !== 'prelearning'}" linkTo="{ course.loc_hash }">
            <HonorCode minimumScore="{ course.minimumExamScore }"></HonorCode>
        </LessonFrame>
        <LessonFrame
            if="{ !isNaN(cardNumber) }"
            id="test"
            extraStyleClasses="test"
            linkTo="{ course.loc_hash }"
            progressValue="{ cardNumber }"
            progressMax="{ examCards.length }"
        >
            <Test
                card-number="{ cardNumber }" 
            ></Test>
        </LessonFrame>
        <div if="{ !isNaN(cardNumber) }" class="bottom-buttons">
            <div>
                <a if="{ cardNumber > 1 }" class="has-circle" onclick="{previousExamCard}">
                    <span class="arrow"></span>
                </a>
            </div>
            <div>
                <button
                    if="{ cardNumber < examCards.length }"
                    class="btn-primary"
                    onclick="{nextExamCard}"
                    disabled="{ !hasAnswer() }"
                >
                    { TRANSLATIONS.next() }
                </button>
                <button
                    if="{ cardNumber === examCards.length }"
                    class="btn-primary"
                    onclick="{nextExamCard}"
                    disabled="{ !hasAnswer() }"
                >
                    { TRANSLATIONS.submit() }
                </button>
            </div>
        </div>
    </template>
    <ExamResults
        if="{ state.results }"
        result="{ state.results }"
    ></ExamResults>

    <script>
        import ExamResults from "RiotTags/Lesson/ExamResults.riot.html";
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";
        import HonorCode from "RiotTags/Lesson/HonorCode.riot.html";
        import Test from "RiotTags/Lesson/Test.riot.html";

        import { getRoute, getExamAnswer, clearPageAnswers } from "ReduxImpl/Interface";

        function CourseExam() {
            return {
                state: {
                    results: false,
                },

                TRANSLATIONS: {
                    next: () => gettext("Next"),
                    submit: () => gettext("Submit answers"),
                },

                onBeforeUpdate() {
                    window.scroll(0, 0);
                },

                get route() {
                    return getRoute();
                },
                get course() {
                    return this.route.page;
                },
                get stage() {
                    const s =  this.route.riotHash[1];
                    if (s) {
                        return s;
                    } else {
                        return this.course.examType === 'prelearning' ? 1 : 'code';
                    }
                },
                get cardNumber() {
                    const p =  parseInt(this.stage);
                    return p;
                },
                get examCards() {
                    return this.course.examCards;
                },

                previousExamCard() {
                    const newCardNumber = this.cardNumber - 1;
                    location.hash = `${this.course.loc_hash}:exam:${newCardNumber}`;
                },

                nextExamCard() {
                    if( this.cardNumber === this.examCards.length ) {
                        this.submit();
                    } else {
                        const newCardNumber = this.cardNumber + 1;
                        location.hash = `${this.course.loc_hash}:exam:${newCardNumber}`;
                    }
                },
                submit() {
                    const result = this.course.examResult;
                    if (result.error == 'incomplete') {
                        alert('check you have answered all questions');
                    } else {
                        // set this course as complete in the store
                        // this will persist in local storage and the server
                        if (result.passed || this.course.examType === 'prelearning') {
                            this.course.complete = true;
                        }

                        // clear the answers from memory so they do not show up next time
                        clearPageAnswers(this.course.id);

                        this.update({results: result});
                    }
                },

                hasAnswer() {
                    const a = getExamAnswer(this.course.id, this.course.examCards[this.cardNumber - 1].id);
                    return a;
                },
            }
        };

        CourseExam.components =  {
            examresults: ExamResults,
            lessonframe: LessonFrame,
            honorcode: HonorCode,
            test: Test,
        };

        export default CourseExam;
    </script>
</CourseExam>
