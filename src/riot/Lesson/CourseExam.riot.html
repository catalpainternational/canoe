<CourseExam>
    <LessonFrame if="{isAtHonorCode(state.cardIdx)}">
        <HonorCode
            courseId="{props.wagtailPage.id}"
            minimumScore="{MINIMUM_SCORE}"
        ></HonorCode>
    </LessonFrame>
    <LessonFrame
        if="{state.cardIdx >= 0 && state.cardIdx < state.cards.length && state.card}"
        id="test"
        extraStyleClasses="test"
    >
        <h3>{state.cardIdx + 1}. {state.card.question}</h3>
        <TestSingleAnswer
            if="{state.card.type === SINGLE_CHOICE}"
            isCourseExam="{true}"
            card="{state.card}"
            recordAnswer="{recordAnswer}"
            savedAnswer="{state.currentAnswer.answers}"
        ></TestSingleAnswer>
        <TestMultipleAnswer
            if="{state.card.type !== SINGLE_CHOICE}"
            isCourseExam="{true}"
            card="{state.card}"
            recordAnswer="{recordAnswer}"
            savedAnswer="{state.currentAnswer.answers}"
        ></TestMultipleAnswer>
        <div class="bottom-buttons">
            <div>
                <a if="{state.cardIdx > 0}" class="arrow-gray" onclick="{previousExamCard}"></a>
            </div>
            <div>
                <button
                    if="{state.cardIdx < state.cards.length - 1}"
                    class="btn-primary"
                    onclick="{nextExamCard}"
                    disabled="{Object.keys(state.currentAnswer).length === 0}"
                >
                    { TRANSLATIONS.next() }
                </button>
                <button
                    if="{state.cardIdx === state.cards.length - 1}"
                    class="btn-primary"
                    onclick="{nextExamCard}"
                    disabled="{Object.keys(state.currentAnswer).length === 0}"
                >
                    { TRANSLATIONS.submit() }
                </button>
            </div>
        </div>
        <p class="card-number">{ cardNumberMessage() }</p>
    </LessonFrame>
    <ExamResults
        if="{isAtResults(state.cardIdx)}"
        course="{props.wagtailPage}"
        title="{props.wagtailPage.title}"
        finalScore="{calculateFinalScore()}"
        minimumScore="{MINIMUM_SCORE}"
    ></ExamResults>

    <script>
        import ExamResults from "RiotTags/Lesson/ExamResults.riot.html";
        import TestSingleAnswer from "RiotTags/Lesson/TestSingleAnswer.riot.html";
        import TestMultipleAnswer from "RiotTags/Lesson/TestMultipleAnswer.riot.html";
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";
        import HonorCode from "RiotTags/Lesson/HonorCode.riot.html";

        import { getLessonCardIdx, getPreviousCardsUrl, getNextCardsUrl } from "js/Routing";
        import { dispatchTestAnswerEvent, ON_ANSWERED_TEST_QUESTION } from "js/Events";
        import { URLDoesntExist, ExamIsMissingAnAnswer } from "js/Errors";
        import { saveExamAnswer, loadExamAnswer, tallyFinalScore } from "js/ExamInterface";

        export default {
            state: {
                cardIdx: 0,
                card: null,
                currentAnswer: {},
            },

            components: {
                examresults: ExamResults,
                testsingleanswer: TestSingleAnswer,
                testmultipleanswer: TestMultipleAnswer,
                lessonframe: LessonFrame,
                honorcode: HonorCode,
            },

            TRANSLATIONS: {
                next: () => gettext('Next'),
                submit: () => gettext('Submit answers'),
            },

            MINIMUM_SCORE: 75,
            SINGLE_CHOICE: "single_choice",
            SECTION: "exam",

            onBeforeMount(props, state) {
                window.addEventListener("hashchange", this.onHashChange);

                const { cards } = props;
                this.state.cards = cards;
                this.shuffleCards(this.state.cards);

                if (cards.length > 5) {
                    this.state.cards = this.state.cards.slice(0, 5);
                }
            },

            onBeforeUnmount(props, state) {
                window.removeEventListener("hashchange", this.onHashChange);
            },

            onMounted(props, state) {
                this.onHashChange();
            },

            shuffleCards(cards) {
                cards.sort(() => Math.random() - 0.5);
            },

            onHashChange() {
                this.renderAnExamScreen();
                window.scroll(0, 0);
            },

            renderAnExamScreen() {
                const cardIdx = getLessonCardIdx();
                this.update({
                    cardIdx,
                });

                if (this.isAtHonorCode(cardIdx) || this.isAtResults(cardIdx)) {
                    return;
                }

                const card = this.getCard(cardIdx);
                const previousAnswer = loadExamAnswer(card.id);
                const currentAnswer = previousAnswer || {};

                this.state.cardAnswers = card.answers;
                this.shuffleCards(this.state.cardAnswers);
                card.answers = this.state.cardAnswers;

                this.update({
                    card,
                    currentAnswer,
                });
            },

            isAtHonorCode(cardIdx) {
                return cardIdx === -1;
            },

            isAtResults(cardIdx) {
                return cardIdx === this.state.cards.length;
            },

            getCard(cardIdx) {
                const card = this.state.cards[cardIdx];
                if (!card) {
                    throw new URLDoesntExist(
                        `Cannot find exam question at ${window.location.hash}`
                    );
                }
                return card;
            },

            recordAnswer(response) {
                console.assert(
                    response.hasOwnProperty("answers") && response.hasOwnProperty("isCorrect")
                );

                this.update({ currentAnswer: response });
            },

            previousExamCard() {
                const { wagtailPage } = this.props;
                const { cardIdx } = this.state;
                location.hash = getPreviousCardsUrl(wagtailPage.id, this.SECTION, cardIdx);
            },

            nextExamCard() {
                const { wagtailPage } = this.props;
                const { cardIdx, card, currentAnswer } = this.state;
                saveExamAnswer(card.id, currentAnswer);
                location.hash = getNextCardsUrl(wagtailPage.id, this.SECTION, cardIdx);
            },

            calculateFinalScore() {
                const { cards } = this.props;
                const listOfExamQuestions = cards.map((card) => card.id);
                try {
                    return Math.round(tallyFinalScore(listOfExamQuestions));
                } catch (err) {
                    if (err instanceof ExamIsMissingAnAnswer) {
                        return 0;
                    }
                    throw err;
                }
            },

            cardNumberMessage() {
                // display the number of the current card out of the total number of cards
                return gettext("%1 of %2", this.state.cardIdx + 1, this.state.cards.length);
            },
        };
    </script>
</CourseExam>
