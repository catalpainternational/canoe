<LessonComplete>
    <template if="{state.lessonSlugs.length}">
        <div class="congratulations-container">
            <span class="superman-success"></span>
            <template if="{!isCourseComplete()}">
                <div>
                    <h2>{ TRANSLATIONS.congrats() }</h2>
                    <p>{ lessonCompleteMessage() }</p>
                </div>
                <button class="btn-primary" onclick="{goToCourseOverview}">
                    { TRANSLATIONS.next() }
                    <span></span>
                </button>
            </template>
            <template if="{isCourseComplete()}">
                <div>
                    <h2>{ TRANSLATIONS.good() }</h2>
                    <p>{ lessonCompleteMessage() }</p>
                    <p if="{ courseHasExam() }">{ takeCourseExamMessage() }</p>
                </div>
                <button if="{ courseHasExam() }" class="btn-primary" onclick="{goToCourseExam}">
                    { TRANSLATIONS.exam() }
                    <span></span>
                </button>
                <button class="btn-secondary" onclick="{goToCourseOverview}">
                    { TRANSLATIONS.course() }
                </button>
            </template>
        </div>
    </template>
    <script>
        import { getACoursesLessons } from "js/WagtailPagesAPI";
        import { countFinishedLessonsAmongSlugs } from "js/CompletionInterface";

        export default {
            state: {
                lessonSlugs: [],
            },

            TRANSLATIONS: {
                congrats: () => gettext("Congratulations!"),
                next: () => gettext("Next Lesson"),
                good: () => gettext("Good job!"),
                exam: () => gettext("Take Exam"),
                course: () => gettext("Back to Course"),
            },

            onMounted() {
                this.loadLessonsForIsCourseComplete();
            },

            async loadLessonsForIsCourseComplete() {
                const lessons = await getACoursesLessons(this.props.course.id);
                const lessonSlugs = lessons.map((lesson) => lesson.slug);
                this.update({ lessonSlugs });
            },

            courseHasExam() {
                const { course } = this.props;
                return course.has_exam;
            },

            isCourseComplete() {
                const { course } = this.props;
                const { lessonSlugs } = this.state;
                return (
                    countFinishedLessonsAmongSlugs(course.slug, lessonSlugs) ===
                    course.lessons_count - Number(course.has_exam)
                );
            },

            goToCourseOverview() {
                location.hash = `#${this.props.course.id}`;
            },

            goToCourseExam() {
                location.hash = `#${this.props.course.id}/exam/0`;
            },

            lessonCompleteMessage() {
                // message on completion of a lesson %1 is replaced by the lesson title
                return gettext('You just completed the lesson "%1"', this.props.title);
            },

            takeCourseExamMessage() {
                // message on completion of lesson and prompt to take course exam
                return gettext(
                    'Take the exam now to complete the course "%1"',
                    this.props.course.title
                );
            },
        };
    </script>
</LessonComplete>
