<LessonTest>
    <LessonFrame
        id="test"
        if="{ props.lesson.ready && state.cardNumber }"
        extraStyleClasses="test"
        progressValue="{ state.cardNumber }"
        progressMax="{ state.cards.length }"
        lesson="{ props.lesson }"
    >
        <h3>{ state.cardNumber }. { state.card.question }</h3>
        <TestSingleAnswer
            if="{state.isSingleAnswer}"
            lessonName="{props.lesson.title}"
            card="{state.card}"
            toggleModal="{toggleModal}"
        ></TestSingleAnswer>
        <TestMultipleAnswer
            if="{!state.isSingleAnswer}"
            lessonName="{props.lesson.title}"
            card="{state.card}"
            toggleModal="{toggleModal}"
        ></TestMultipleAnswer>
    </LessonFrame>
    <TestPopupModal
        if="{state.showModal}"
        isQuestionComplete="{state.isQuestionComplete}"
        selectedAnswer="{state.selectedAnswer}"
        isLastQuestion="{state.cardNumber === state.cards.length}"
        toggleModal="{toggleModal}"
        lesson="{props.lesson}"
        module="{props.module}"
        cardNumber="{state.cardNumber}"
    ></TestPopupModal>
    <LessonFeedback
        if="{ !state.cardNumber && state.stage == 'feedback' }"
        lessonName="{props.lesson.title}"
    ></LessonFeedback>
    <LessonComplete
        if="{ !state.cardNumber && state.stage == 'complete' }"
    ></LessonComplete>

    <script>
        import LessonComplete from "RiotTags/Lesson/LessonComplete.riot.html";
        import LessonFeedback from "RiotTags/Lesson/LessonFeedback.riot.html";
        import TestSingleAnswer from "RiotTags/Lesson/TestSingleAnswer.riot.html";
        import TestMultipleAnswer from "RiotTags/Lesson/TestMultipleAnswer.riot.html";
        import TestPopupModal from "RiotTags/Lesson/TestPopupModal.riot.html";
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";

        import { logATestAnswer } from "js/GoogleAnalytics";
        import { dispatchTestAnswerEvent, ON_ANSWERED_TEST_QUESTION } from "js/Events";

        import { getRoute } from "ReduxImpl/Interface";

        function readState(props) {
            const route = getRoute();
            const stage = route.riotHash[1];
            const cardNumber = parseInt(stage);
            const card = props.lesson.ready ? props.lesson.test.cards[cardNumber - 1] : undefined;
            const state = {
                cards: props.lesson.ready ? props.lesson.test.cards : [],
                card: card,
                isSingleAnswer: card ? card.answers.filter(answer => answer.correct).length < 2 : undefined,
                cardNumber: cardNumber,
                stage,
            };
            return state;
        }
        function LessonTest () { return {

            onBeforeMount(props, state) {
                this.state = readState(props);
            },
            onBeforeUpdate(props, state) {
                this.state = Object.assign(this.state, readState(props));
            },

/*
                window.addEventListener(ON_ANSWERED_TEST_QUESTION, event => {
                    logATestAnswer(event.detail);
                const correctAnswers = card.answers.filter(answer => answer.correct);
                this.update({
                    isSingleAnswer: correctAnswers.length === 1,
                });
*/

            toggleModal(showModal, selectedAnswer, isQuestionComplete) {
                this.update({
                    showModal,
                    selectedAnswer,
                    isQuestionComplete,
                });
                const testElement = this.$(".test");
                if (showModal) {
                    testElement.classList.add("fade");
                } else {
                    testElement.classList.remove("fade");
                }
            },

            correctTitleMessage() {
                // title for correct answer feedback
                return this.state.selectedAnswer.correctTitle
                    ? this.state.selectedAnswer.correctTitle
                    : gettext("Great");
            },

            correctTextMessage() {
                // text for correct answer feedback
                return this.state.selectedAnswer.correctText
                    ? this.state.selectedAnswer.correctText
                    : gettext("Well done, keep it up!");
            },

            incorrectTitleMessage() {
                // title for incorrect answer feedback
                return this.state.selectedAnswer.incorrectTitle
                    ? this.state.selectedAnswer.incorrectTitle
                    : gettext("Oops");
            },

            incorrectTextMessage() {
                // text for incorrect answer feedback
                return this.state.selectedAnswer.incorrectText
                    ? this.state.selectedAnswer.incorrectText
                    : gettext("Read the question more carefully!");
            },

            selectAnswer(answer) {
                this.update({ selectedAnswer: answer });
                const eventData = {
                    lesson: this.props.lesson.title,
                    question: this.state.cards[this.state.cardIdx].question,
                    answer: answer.text,
                    isAnswerCorrect: answer.correct,
                };
                dispatchTestAnswerEvent(eventData);
                this.toggleModal(true);
            },

            nextTestCard() {
                this.toggleModal(false);
                window.scroll(0, 0);
                this.state.selectedAnswer = {};
                location.hash = getNextCardsUrl(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            },
        }}
        LessonTest.components = {
            lessoncomplete: LessonComplete,
            lessonfeedback: LessonFeedback,
            testsingleanswer: TestSingleAnswer,
            testmultipleanswer: TestMultipleAnswer,
            testpopupmodal: TestPopupModal,
            lessonframe: LessonFrame,
        };

        export default LessonTest;
    </script>
</LessonTest>
