<LessonTest>
    <div id="test" class="test background-blue-1" if="{state.cardIdx < state.cards.length}">
        <div class="carousel-card">
            <h3>{state.cardIdx + 1}. {state.cards[state.cardIdx].question}</h3>
            <TestSingleAnswer 
                if="{state.isSingleAnswer}"
                lessonName="{props.lesson.title}"
                card="{state.cards[state.cardIdx]}"
                toggleModal="{toggleModal}"
            ></TestSingleAnswer>
            <TestMultipleAnswer
                if="{!state.isSingleAnswer}"
                lessonName="{props.lesson.title}"
                card="{state.cards[state.cardIdx]}"
                toggleModal="{toggleModal}"
            ></TestMultipleAnswer>
            <p class="card-number">{ cardNumberMessage() }</p>
        </div>
    </div>
    <TestFeedbackModal
        if="{state.showModal}"
        isQuestionComplete="{state.isQuestionComplete}"
        selectedAnswers="{state.selectedAnswers}"
        isLastQuestion="{state.cardIdx === state.cards.length - 1}"
        toggleModal="{toggleModal}"
        course="{props.course}"
        lesson="{props.lesson}"
        module="{props.module}"
        cardIdx="{state.cardIdx}"
    ></TestFeedbackModal>
    <LessonFeedback
        if="{state.cardIdx === state.cards.length}"
        backgroundColor="{props.course.colour}"
        lessonName="{props.lesson.title}"
    ></LessonFeedback>
    <LessonComplete
        if="{state.cardIdx === state.cards.length + 1}"
        course="{props.course}"
        title="{props.title}"
        backgroundColor="{props.course.colour}"
    >
    </LessonComplete>

    <script>
        import LessonComplete from "RiotTags/Lesson/LessonComplete.riot.html";
        import LessonFeedback from "RiotTags/Lesson/LessonFeedback.riot.html";
        import TestSingleAnswer from "RiotTags/Lesson/TestSingleAnswer.riot.html";
        import TestMultipleAnswer from "RiotTags/Lesson/TestMultipleAnswer.riot.html";
        import TestFeedbackModal from "RiotTags/Lesson/TestFeedbackModal.riot.html";

        import { getLessonCardIdx } from "js/Routing";
        import { dispatchTestAnswerEvent } from "js/Events";

        export default {
            state: {
                cards: [],
                cardIdx: 0,
                isSingleAnswer: false,
                showModal: false,
                selectedAnswers: []
            },

            components: {
                lessoncomplete: LessonComplete,
                lessonfeedback: LessonFeedback,
                testsingleanswer: TestSingleAnswer,
                testmultipleanswer: TestMultipleAnswer,
                testfeedbackmodal: TestFeedbackModal
            },

            onBeforeMount(props, state) {
                const { cards } = props.test;
                state.cards = cards;
                state.cardIdx = getLessonCardIdx();
                window.addEventListener("hashchange", this.hashChanged);
            },

            onMounted(props, state) {
                this.update({ 
                    isSingleAnswer: this.state.cards[this.state.cardIdx] && this.state.cards[this.state.cardIdx].answers.filter(a => a.correct).length === 1 
                });
            },

            onBeforeUnmount(props, state) {
                window.removeEventListener("hashchange", this.hashChanged);
            },

            hashChanged() {
                const cardIdx = getLessonCardIdx();
                const isSingleAnswer = this.state.cards[cardIdx] && this.state.cards[cardIdx].answers.filter(a => a.correct).length === 1;

                this.update({
                    cardIdx,
                    isSingleAnswer
                });
            },

            goBack() {
                window.history.back();
            },

            cardNumberMessage() {
                // display the number of the current card out of the total number of cards
                return gettext(
                    "%1 of %2",
                    this.state.cardIdx + 1,
                    this.props.test.cards.length
                );
            },

            toggleModal(showModal, selectedAnswers, isQuestionComplete) {
                this.update({
                    selectedAnswers,
                    isQuestionComplete 
                });

                const testElement = this.$("#test");
                if (showModal) {
                    this.update({ showModal: true });
                    testElement.classList.add("showElement");
                } else {
                    this.update({ showModal: false });
                    testElement.classList.remove("showElement");
                }
            },
        };
    </script>
</LessonTest>
