<LessonTest>
    <div id="test" class="test background-blue-1" if="{state.cardIdx < state.cards.length}">
        <div class="carousel-card">
            <h3>{state.cardIdx + 1}. {state.cards[state.cardIdx].question}</h3>
            <TestSingleAnswer 
                if="{!state.isMultipleAnswers}"
                lessonName="{props.lesson.title}"
                answers="{state.cards[state.cardIdx].answers}"
                question="{state.cards[state.cardIdx].question}"
                toggleModal="{toggleModal}"
            ></TestSingleAnswer>
            <TestMultipleAnswer
                if="{state.isMultipleAnswers}"
                lessonName="{props.lesson.title}"
                answers="{state.cards[state.cardIdx].answers}"
                question="{state.cards[state.cardIdx].question}"
                toggleModal="{toggleModal}"
            ></TestMultipleAnswer>
            <p class="card-number">{ cardNumberMessage() }</p>
        </div>
    </div>
    <div id="modal" class="feedback-modal">
        <div if="{state.selectedAnswer.correct || !state.hasIncorrectAnswers}">
            <h2>{ correctTitleMessage() }</h2>
            <p>{ correctTextMessage() }</p>
            <button if="{state.cardIdx < state.cards.length - 1}" class="btn-primary" onclick="{ nextTestCard }" translate>Next</button>
            <button if="{state.cardIdx === state.cards.length - 1}" class="btn-primary" onclick="{ completePage }" translate>Finish</button>
        </div>
        <div if="{!state.selectedAnswer.correct || state.hasIncorrectAnswers}">
            <h2>{ incorrectTitleMessage() }</h2>
            <p>{ incorrectTextMessage() }</p>
            <button class="btn-primary btn-wrong" onclick="{ () => toggleModal(false) }" translate>Try again</button>
        </div>
    </div>
    <LessonFeedback
        if="{state.cardIdx === state.cards.length}"
        backgroundColor="{props.course.colour}"
        lessonName="{props.lesson.title}"
    ></LessonFeedback>
    <LessonComplete
        if="{state.cardIdx === state.cards.length + 1}"
        course="{props.course}"
        title="{props.title}"
        backgroundColor="{props.course.colour}"
    >
    </LessonComplete>

    <script>
        import LessonComplete from "RiotTags/Lesson/LessonComplete.riot.html";
        import LessonFeedback from "RiotTags/Lesson/LessonFeedback.riot.html";
        import TestSingleAnswer from "RiotTags/Lesson/TestSingleAnswer.riot.html";
        import TestMultipleAnswer from "RiotTags/Lesson/TestMultipleAnswer.riot.html";

        import { getLessonCardIdx, getLessonModuleHash } from "js/Routing";
        import { setComplete } from "Actions/completion";
        import { dispatchTestAnswerEvent } from "js/Events";

        export default {
            state: {
                selectedAnswer: {},
                cards: [],
                cardIdx: 0,
                isMultipleAnswers: false,
                hasIncorrectAnswers: false
            },

            components: {
                lessoncomplete: LessonComplete,
                lessonfeedback: LessonFeedback,
                testsingleanswer: TestSingleAnswer,
                testmultipleanswer: TestMultipleAnswer
            },

            onBeforeMount(props, state) {
                const { cards } = props.test;
                // state.cards = cards;
                state.cardIdx = getLessonCardIdx();
                window.addEventListener("hashchange", this.hashChanged);
                
                const dummyCard = [{
                    question: "Which organs are primarily affected by COVID-19?", 
                    answers: [
                        {text: "A long time ago in a galaxy far far away", correct: false},
                        {text: "It is a period of civil war.", correct: true},
                        {text: "During the battle, Rebel spies managed to steal secret plans.", correct: true},
                        {text: "Pursued by the Empire's sinister agents, Princess Leia races home aboard her starship.", correct: false},
                    ]
                }];
                state.cards = dummyCard;
                const correctAnswers = dummyCard[0].answers.filter(a => a.correct);
                state.isMultipleAnswers = correctAnswers.length > 1;
            },

            onBeforeUnmount(props, state) {
                window.removeEventListener("hashchange", this.hashChanged);
            },

            hashChanged() {
                this.update({
                    cardIdx: getLessonCardIdx()
                });
            },

            goBack() {
                window.history.back();
            },

            cardNumberMessage() {
                // display the number of the current card out of the total number of cards
                return gettext(
                    "%1 of %2",
                    this.state.cardIdx + 1,
                    this.props.test.cards.length
                );
            },

            correctTitleMessage() {
                // title for correct answer feedback
                return this.state.selectedAnswer.correctTitle 
                ? this.state.selectedAnswer.correctTitle
                : gettext("Great");
            },

            correctTextMessage() {
                // text for correct answer feedback
                return this.state.selectedAnswer.correctText 
                ? this.state.selectedAnswer.correctText
                : gettext("Well done, keep it up!");
            },

            incorrectTitleMessage() {
                // title for incorrect answer feedback
                return this.state.selectedAnswer.incorrectTitle 
                ? this.state.selectedAnswer.incorrectTitle
                : gettext("Oops");
            },

            incorrectTextMessage() {
                // text for incorrect answer feedback
                return this.state.selectedAnswer.incorrectText 
                ? this.state.selectedAnswer.incorrectText
                : gettext("Read the question more carefully!");
            },

            // selectAnswer(answer) {
            //     this.update({ selectedAnswer: answer });
            //     const eventData = {
            //         lesson: this.props.lesson.title,
            //         question: this.state.cards[this.state.cardIdx].question,
            //         answer: answer.text,
            //         isAnswerCorrect: answer.correct
            //     };
            //     dispatchTestAnswerEvent(eventData);
            //     this.toggleModal(true);
            // },

            toggleModal(showModal, answer, hasIncorrectAnswers) {
                const modalElement = this.$("#modal");
                const testElement = this.$("#test");

                if (showModal) {
                    this.update({ 
                        selectedAnswer: answer, 
                        hasIncorrectAnswers: hasIncorrectAnswers
                    });
                    modalElement.classList.add("showElement");
                    testElement.classList.add("showElement");
                } else {
                    modalElement.classList.remove("showElement");
                    testElement.classList.remove("showElement");
                }
            },

            nextTestCard() {
                this.toggleModal(false);
                window.scroll(0, 0);
                this.state.selectedAnswer = {};
                location.hash = getLessonModuleHash(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            },

            completePage() {
                this.toggleModal(false);
                setComplete(this.props.course.slug, this.props.lesson.slug, this.props.module);
                location.hash = getLessonModuleHash(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            }
        };
    </script>
</LessonTest>
