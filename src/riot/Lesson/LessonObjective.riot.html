<LessonObjective>
    { props.lesson.ready }
    <LessonFrame
        if="{ props.lesson.ready && state.cardIdx <= state.cards.length }"
        extraStyleClasses="objective"
        progressValue="{ state.cardIdx + 1 }"
        progressMax="{ state.cards.length }"
        lesson="{ props.lesson }"
    >
        <span class="plant"></span>
        <h3>{ TRANSLATIONS.title() }</h3>
        <p class="center-objective">{state.cards[state.cardIdx].description}</p>
        <div class="bottom-buttons">
            <div>
                <a if="{ state.cardIdx > 0 }" class="has-circle" onclick="{ goBack }">
                    <span class="arrow"></span>
                </a>
            </div>
            <div>
                <button
                    class="btn-primary"
                    onclick="{ nextObjectiveCard }"
                    if="{ state.cardIdx < state.cards.length - 1 }"
                >
                    { TRANSLATIONS.next() }
                </button>
                <button
                    class="btn-primary"
                    onclick="{ completeObjectiveModal }"
                    if="{ state.cardIdx === state.cards.length - 1 }"
                >
                    { TRANSLATIONS.finish() }
                </button>
            </div>
        </div>
    </LessonFrame>
    <LessonModuleComplete
        if="{ props.lesson.ready && state.cardIdx === state.cards.length }"
        lesson="{props.lesson}"
        module="{props.module}"
        nextModule="{props.nextModule}"
    ></LessonModuleComplete>

    <script>
        import LessonModuleComplete from "RiotTags/Lesson/LessonModuleComplete.riot.html";
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";

        import { getLessonCardIdx, getNextCardsUrl, getPreviousCardsUrl } from "js/Routing";
        import { setComplete } from "Actions/completion";
        import { getRoute } from "ReduxImpl/Interface";

        function readState(props) {
            const route = getRoute();
            const idx = route.riotHash.split(":")[1];
            const state = {
                cards: props.lesson.ready ? props.lesson.objective.cards : [],
                cards: props.lesson.ready ? props.lesson.objective.cards[idx] : undefined,
                cardIdx: idx,
            };
            return state;
        }
        function LessonObjective() { return {

            TRANSLATIONS: {
                next: () => gettext("Next"),
                title: () => gettext("Objectives"),
                finish: () => gettext("Finish"),
            },

            onBeforeMount(props, state) {
                this.state = readState(props);
            },
            onBeforeUpdate(props, state) {
                this.state = readState(props);
            },

            goBack() {
                location.hash = getPreviousCardsUrl(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            },

            nextObjectiveCard() {
                window.scroll(0, 0);
                location.hash = getNextCardsUrl(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            },

            completeObjectiveModal() {
                setComplete(this.props.course.slug, this.props.lesson.slug, this.props.module);
                location.hash = getNextCardsUrl(
                    this.props.lesson.id,
                    this.props.module,
                    this.state.cardIdx
                );
            },
        }}

        LessonObjective.components = {
            lessonmodulecomplete: LessonModuleComplete,
            lessonframe: LessonFrame,
        };
        
        export default LessonObjective;
    </script>
</LessonObjective>