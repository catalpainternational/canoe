<LessonObjective>
    <LessonFrame
        if="{ props.lesson.ready && state.cardNumber <= state.cards.length }"
        extraStyleClasses="objective"
        progressValue="{ state.cardNumber }"
        progressMax="{ state.cards.length }"
        lesson="{ props.lesson }"
    >
        <span class="plant"></span>
        <h3>{ TRANSLATIONS.title() }</h3>
        <p class="center-objective">{state.card.description}</p>
    </LessonFrame>
    <div if="{ props.lesson.ready && state.cardNumber <= state.cards.length }" class="bottom-buttons">
        <div>
            <a if="{ state.cardNumber > 1 }" class="has-circle" onclick="{ goBack }">
                <span class="arrow"></span>
            </a>
        </div>
        <div>
            <button
                class="btn-primary"
                onclick="{nextObjectiveCard}"
                if="{ state.cardNumber < state.cards.length }"
            >
                { TRANSLATIONS.next() }
            </button>
            <button
                class="btn-primary"
                onclick="{completeObjectiveModal}"
                if="{ state.cardNumber === state.cards.length }"
            >
                { TRANSLATIONS.finish() }
            </button>
        </div>
    </div>
    <LessonModuleComplete
        if="{ props.lesson.ready && state.complete }"
        lesson="{props.lesson}"
        module="{props.module}"
        nextModule="content"
    ></LessonModuleComplete>

    <script>
        import LessonModuleComplete from "RiotTags/Lesson/LessonModuleComplete.riot.html";
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";

        import { getRoute } from "ReduxImpl/Interface";

        function readState(props) {
            const route = getRoute();
            const stage = route.riotHash[1];
            const cardNumber = parseInt(stage);
            const state = {
                cards: props.lesson.ready ? props.lesson.objective.cards : [],
                card: props.lesson.ready ? props.lesson.objective.cards[cardNumber - 1] : undefined,
                cardNumber: cardNumber,
                complete: stage === 'complete'
            };
            return state;
        }
        function LessonObjective() { return {

            TRANSLATIONS: {
                next: () => gettext("Next"),
                title: () => gettext("Objectives"),
                finish: () => gettext("Finish"),
            },

            onBeforeMount(props, state) {
                this.state = readState(props);
            },
            onBeforeUpdate(props, state) {
                this.state = readState(props);
            },

            goBack() {
                location.hash = `${this.props.lesson.loc_hash}:objectives:${this.state.cardNumber - 1}`;
            },

            nextObjectiveCard() {
                window.scroll(0, 0);
                location.hash = `${this.props.lesson.loc_hash}:objectives:${this.state.cardNumber + 1}`;
            },

            completeObjectiveModal() {
                this.props.lesson.completeSection(this.props.module);
                location.hash = `${this.props.lesson.loc_hash}:objectives:complete`;
            },
        }}

        LessonObjective.components = {
            lessonmodulecomplete: LessonModuleComplete,
            lessonframe: LessonFrame,
        };
        
        export default LessonObjective;
    </script>
</LessonObjective>