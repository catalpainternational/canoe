<LessonObjective>
    <LessonFrame
        if="{ props.lesson.ready && state.cardNumber <= state.cards.length }"
        extraStyleClasses="objective"
        progressValue="{ state.cardNumber }"
        progressMax="{ state.cards.length }"
        lesson="{ props.lesson }"
        linkTo="{ props.lesson.course.loc_hash }"
    >
        <span class="plant"></span>
        <h3>{ TRANSLATIONS.title() }</h3>
        <p class="center-objective">{state.card.description}</p>
    </LessonFrame>
    <div if="{ props.lesson.ready && state.cardNumber <= state.cards.length }" class="bottom-buttons">
        <div>
            <a if="{ state.cardNumber > 1 }" class="has-circle" onclick="{ goBack }">
                <span class="arrow"></span>
            </a>
        </div>
        <div>
            <button
                class="btn-primary"
                onclick="{nextCard}"
                if="{ state.cardNumber < state.cards.length }"
            >
                { TRANSLATIONS.next() }
            </button>
            <button
                class="btn-primary"
                onclick="{completeLesson}"
                if="{ state.cardNumber === state.cards.length }"
            >
                { TRANSLATIONS.finish() }
            </button>
        </div>
    </div>
    <LessonFeedback
        if="{ !state.cardNumber && state.stage == 'feedback' }"
        lessonName="{props.lesson.title}"
    ></LessonFeedback>
    <LessonComplete
        if="{ !state.cardNumber && state.stage == 'complete' }"
    ></LessonComplete>

    <script>
        import LessonFrame from "RiotTags/Components/LessonFrame.riot.html";

        import { getRoute } from "ReduxImpl/Interface";
        import { lessonSectionComplete } from "js/utilities";

        function readState(props) {
            const route = getRoute();
            const stage = route.riotHash[1];
            const cardNumber = parseInt(stage);
            const state = {
                cards: props.lesson.ready ? props.lesson.data.cards : [],
                card: props.lesson.ready ? props.lesson.data.cards[cardNumber - 1] : undefined,
                cardNumber: cardNumber,
                complete: stage === 'complete'
            };
            return state;
        }
        function LessonObjective() { return {

            TRANSLATIONS: {
                next: () => gettext("Next"),
                title: () => gettext("Objectives"),
                finish: () => gettext("Finish"),
            },

            onBeforeMount(props, state) {
                this.state = readState(props);
            },
            onBeforeUpdate(props, state) {
                this.state = readState(props);
            },

            goBack() {
                const prevCard = this.state.cards[this.state.cardNumber - 2];
                location.hash = `${this.props.lesson.loc_hash}:${prevCard.type}:${this.state.cardNumber - 1}`;
            },

            nextCard() {
                window.scroll(0, 0);
                const nextCard = this.state.cards[this.state.cardNumber];
                lessonSectionComplete(
                    this.state.cards,
                    this.state.cards[this.state.cardNumber - 1],
                    this.props.lesson,
                    this.props.module
                );

                location.hash = `${this.props.lesson.loc_hash}:${nextCard.type}:${this.state.cardNumber + 1}`;
            },

            completeLesson() {
                location.hash = `${this.props.lesson.loc_hash}:test:feedback`;
            },
        }}

        LessonObjective.components = {
            lessonframe: LessonFrame,
        };

        export default LessonObjective;
    </script>
</LessonObjective>
