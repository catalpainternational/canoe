<AudioCard>
    <div>
        <h3 class="media-title">{props.media.title}</h3>
        <p class="media-description">{props.media.description}</p>
        <audio 
            if="{ !state.src }"
            controls
            crossorigin="anonymous"
            onplay="{ (event) => storeAnalytics(event) }"
            >
            <span>{ TRANSLATIONS.browserSupport() }</span>
        </audio>
        <p class="error-message" if="{ !state.src }">
            { TRANSLATIONS.missing() }
        </p>
        <p if={state.cached}>{ TRANSLATIONS.cached() }</p>
        <p if={!state.cached}>{ TRANSLATIONS.notCached() }</p>
    </div>

    <script>
        import { Asset } from "ts/Implementations/Asset";
        import { getRoute } from "ReduxImpl/Interface";
        import { isItemCached } from "js/cacheManager/cacheManager";
        import { logClickedPlayOnVideo } from "js/GoogleAnalytics";

        export default {
            state: {
                cached: false
            },

            TRANSLATIONS: {
                browserSupport: () => gettext("Your browser does not support the audio element."),
                cached: () => gettext("This audio will play offline."),
                notCached: () => gettext("This audio is not available offline."),
                missing: () => gettext("Sorry: This audio is missing.")
            },

            onBeforeMount(props, state) {
                this.page = getRoute().page;
                const assetEntry = this.page.getAudioRenditions(
                    props.media.id
                );
                let src = "";
                try {
                    src = Asset.Url(assetEntry);
                } catch {
                    // No compatible rendition found, therefore no url
                    src = "";
                }
                this.state.src = src;
                if (src) {
                    isItemCached(src).then(cached => {
                        this.update({cached});
                    });
                }
            },

            storeAnalytics() {
                const mediaTitle = this.props.media.title;
                logClickedPlayOnVideo(mediaTitle);
            },

        };
    </script>
</AudioCard>
