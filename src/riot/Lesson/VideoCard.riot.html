<VideoCard>
    <div>
        <video
            if="{ state.src }"
            src="{ state.src }"
            width="100%"
            crossorigin="anonymous"
            controls="true"
            preload="auto"
            onplay="{ (event) => storeAnalytics(event) }"
        >
            <!-- if preload set to none the video will not actually be requested, if set to auto it is requested -->
            <span>{ TRANSLATIONS.browserSupport() }</span>
        </video>
        <p class="error-message" if="{ !state.src }">
            { TRANSLATIONS.missing() }
        </p>
        <h3 class="media-title">{props.media.title}</h3>
        <p class="media-description">{props.media.description}</p>

        <p if="{ state.error === 'no_asset' }">
            { TRANSLATIONS.noAssetError() }
        </p>
    </div>

    <script>
        import { Asset } from "ts/Implementations/Asset";
        import { getRoute } from "ReduxImpl/Interface";
        import { isItemCached } from "js/cacheManager/cacheManager";
        import { logClickedPlayOnVideo } from "js/GoogleAnalytics";

        export default {
            TRANSLATIONS: {
                browserSupport: () => gettext('Your browser does not support the video element.'),
                missing: () => gettext("Sorry: This video is missing.")
            },

            state: {
                src: "",
                cached: false
            },

            onBeforeMount(props, state) {
                this.page = getRoute().page;
                const assetEntry = this.page.getVideoRenditions(
                    props.media.id
                );
                let src = "";
                try {
                    src = Asset.Url(assetEntry);
                } catch {
                    // No compatible rendition found, therefore no url
                    src = "";
                }
                this.state.src = src;
                if (src) {
                    isItemCached(src).then(cached => {
                        this.update({cached});
                    });
                }
            },

            storeAnalytics() {
                const mediaTitle = this.props.media.title;
                logClickedPlayOnVideo(mediaTitle);
            },
        };
    </script>
</VideoCard>
